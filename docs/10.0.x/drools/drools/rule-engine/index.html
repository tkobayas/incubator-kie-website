<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Drools rule engine :: Drools Documentation</title>
    <link rel="canonical" href="https://docs.drools.org/latest/drools-docs/drools/rule-engine/index.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<!--Licensed to the Apache Software Foundation (ASF) under one-->
<!--or more contributor license agreements.  See the NOTICE file-->
<!--distributed with this work for additional information-->
<!--regarding copyright ownership.  The ASF licenses this file-->
<!--to you under the Apache License, Version 2.0 (the-->
<!--"License"); you may not use this file except in compliance-->
<!--with the License.  You may obtain a copy of the License at-->

<!--http://www.apache.org/licenses/LICENSE-2.0-->

<!--Unless required by applicable law or agreed to in writing,-->
<!--software distributed under the License is distributed on an-->
<!--"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY-->
<!--KIND, either express or implied.  See the License for the-->
<!--specific language governing permissions and limitations-->
<!--under the License.-->

<link rel="stylesheet" href="../../_/css/search.css">
<link rel="stylesheet" href="../../_/css/menu.css">
<link rel="stylesheet" href="../../_/css/drl.css">
<!--Licensed to the Apache Software Foundation (ASF) under one-->
<!--or more contributor license agreements.  See the NOTICE file-->
<!--distributed with this work for additional information-->
<!--regarding copyright ownership.  The ASF licenses this file-->
<!--to you under the Apache License, Version 2.0 (the-->
<!--"License"); you may not use this file except in compliance-->
<!--with the License.  You may obtain a copy of the License at-->

<!--http://www.apache.org/licenses/LICENSE-2.0-->

<!--Unless required by applicable law or agreed to in writing,-->
<!--software distributed under the License is distributed on an-->
<!--"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY-->
<!--KIND, either express or implied.  See the License for the-->
<!--specific language governing permissions and limitations-->
<!--under the License.-->

<script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<!--Licensed to the Apache Software Foundation (ASF) under one-->
<!--or more contributor license agreements.  See the NOTICE file-->
<!--distributed with this work for additional information-->
<!--regarding copyright ownership.  The ASF licenses this file-->
<!--to you under the Apache License, Version 2.0 (the-->
<!--"License"); you may not use this file except in compliance-->
<!--with the License.  You may obtain a copy of the License at-->

<!--http://www.apache.org/licenses/LICENSE-2.0-->

<!--Unless required by applicable law or agreed to in writing,-->
<!--software distributed under the License is distributed on an-->
<!--"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY-->
<!--KIND, either express or implied.  See the License for the-->
<!--specific language governing permissions and limitations-->
<!--under the License.-->

<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="https://kie.apache.org/">
          <img src="../../_/img/droolsExpertLogo.png" alt="Drools logo"/>
        </a>
        <a class="navbar-item" href="https://kie.apache.org/">
          Drools Documentation
        </a>
      </div>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search docs">
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item">
          <a class="navbar-item small-item" href="https://github.com/apache/incubator-kie-drools" title="Follow Drools on GitHub"><div class="github-icon"></div></a>
          <a class="navbar-item small-item" href="https://twitter.com/KieCommunity" target="_blank" title="Follow KIE Community on Twitter for more Drools tweets"><img alt="T" src="../../_/img/twitterLogo.png"></a>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="drools" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../introduction/index.html">Drools User Guide 10.0.0</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../introduction/index.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../getting-started/index.html">Getting Started</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../KIE/index.html">Build, Deploy, Utilize and Run</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="index.html">Drools rule engine</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../language-reference/index.html">Rule Language Reference</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../language-reference-traditional/index.html">Rule Language Reference (Traditional)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../DMN/index.html">Decision Model and Notation (DMN)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../pragmatic-ai/index.html">Pragmatic AI: Integrating Machine Learning with Drools</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../Commands/index.html">Drools Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../migration-guide/index.html">Migration Guide</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../experimental-features/index.html">Experimental features</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../release-notes/index.html">Release Notes</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Drools User Guide 10.0.0</span>
    <span class="version">default</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../introduction/index.html">Drools User Guide 10.0.0</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../introduction/index.html">default</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../introduction/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../introduction/index.html">Drools User Guide 10.0.0</a></li>
    <li><a href="index.html">Drools rule engine</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Drools rule engine</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The Drools rule engine stores, processes, and evaluates data to execute the business rules or decision models that you define. The basic function of the Drools rule engine is to match incoming data, or <em>facts</em>, to the conditions of rules and determine whether and how to execute the rules.</p>
</div>
<div class="paragraph">
<p>The Drools rule engine operates using the following basic components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Rules:</strong> Business rules or DMN decisions that you define. All rules must contain at a minimum the conditions that trigger the rule and the actions that the rule dictates.</p>
</li>
<li>
<p><strong>Facts:</strong> Data that enters or changes in the Drools rule engine that the Drools rule engine matches to rule conditions to execute applicable rules.</p>
</li>
<li>
<p><strong>Production memory:</strong> Location where rules are stored in the Drools rule engine.</p>
</li>
<li>
<p><strong>Working memory:</strong> Location where facts are stored in the Drools rule engine.</p>
</li>
<li>
<p><strong>Agenda:</strong> Location where activated rules are registered and sorted (if applicable) in preparation for execution.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When a business user or an automated system adds or updates rule-related information in Drools, that information is inserted into the working memory of the Drools rule engine in the form of one or more facts. The Drools rule engine matches those facts to the conditions of the rules that are stored in the production memory to determine eligible rule executions. (This process of matching facts to rules is often referred to as <em>pattern matching</em>.) When rule conditions are met, the Drools rule engine activates and registers rules in the agenda, where the Drools rule engine then sorts prioritized or conflicting rules in preparation for execution.</p>
</div>
<div class="paragraph">
<p>The following diagram illustrates these basic components of the Drools rule engine:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/rule-engine/rule-engine-inkscape_enterprise.png" alt="rule engine inkscape enterprise">
</div>
<div class="title">Figure 1. Overview of basic Drools rule engine components</div>
</div>
<div class="paragraph">
<p>For more details and examples of rule and fact behavior in the Drools rule engine, see <a href="#inference-and-truth-maintenance_rule-engine">Inference and truth maintenance in the Drools rule engine</a>.</p>
</div>
<div class="paragraph">
<p>These core concepts can help you to better understand other more advanced components, processes, and sub-processes of the Drools rule engine, and as a result, to design more effective business assets in Drools.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kie-sessions-con_rule-engine"><a class="anchor" href="#kie-sessions-con_rule-engine"></a>KIE sessions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In Drools, a KIE session stores and executes runtime data. The KIE session is created from a KIE base or directly from a KIE container if you have defined the KIE session in the KIE module descriptor file (<code>kmodule.xml</code>) for your project.</p>
</div>
<div class="listingblock">
<div class="title">Example KIE session configuration in a <code>kmodule.xml</code> file</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;kmodule&gt;
  ...
  &lt;kbase&gt;
    ...
    &lt;ksession name="KSession2_1" type="stateless" default="true" clockType="realtime"&gt;
    ...
  &lt;/kbase&gt;
  ...
&lt;/kmodule&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A KIE base is a repository that you define in the KIE module descriptor file (<code>kmodule.xml</code>) for your project and contains all
in Drools, but does not contain any runtime data.</p>
</div>
<div class="listingblock">
<div class="title">Example KIE base configuration in a <code>kmodule.xml</code> file</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;kmodule&gt;
  ...
  &lt;kbase name="KBase2" default="false" eventProcessingMode="stream" equalsBehavior="equality" declarativeAgenda="enabled" packages="org.domain.pkg2, org.domain.pkg3" includes="KBase1"&gt;
    ...
  &lt;/kbase&gt;
  ...
&lt;/kmodule&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A KIE session can be stateless or stateful. In a stateless KIE session, data from a previous invocation of the KIE session (the previous session state) is discarded between session invocations. In a stateful KIE session, that data is retained. The type of KIE session you use depends on your project requirements and how you want data from different asset invocations to be persisted.</p>
</div>
<div class="sect2">
<h3 id="kie-sessions-stateless-con_rule-engine"><a class="anchor" href="#kie-sessions-stateless-con_rule-engine"></a>Stateless KIE sessions</h3>
<div class="paragraph">
<p>A stateless KIE session is a session that does not use inference to make iterative changes to facts over time. In a stateless KIE session, data from a previous invocation of the KIE session (the previous session state) is discarded between session invocations, whereas in a stateful KIE session, that data is retained. A stateless KIE session behaves similarly to a function in that the results that it produces are determined by the contents of the KIE base and by the data that is passed into the KIE session for execution at a specific point in time. The KIE session has no memory of any data that was passed into the KIE session previously.</p>
</div>
<div class="paragraph">
<p>Stateless KIE sessions are commonly used for the following use cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Validation</strong>, such as validating that a person is eligible for a mortgage</p>
</li>
<li>
<p><strong>Calculation</strong>, such as computing a mortgage premium</p>
</li>
<li>
<p><strong>Routing and filtering</strong>, such as sorting incoming emails into folders or sending incoming emails to a destination</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, consider the following driver&#8217;s license data model and sample DRL rule:</p>
</div>
<div class="listingblock">
<div class="title">Data model for driver&#8217;s license application</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class Applicant {
  private String name;
  private int age;
  private boolean valid;
  // Getter and setter methods
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample DRL rule for driver&#8217;s license application</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">package com.company.license

rule "Is of valid age"
when
  $a : Applicant(age &lt; 18)
then
  $a.setValid(false);
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Is of valid age</code> rule disqualifies any applicant younger than 18 years old. When the <code>Applicant</code> object is inserted into the Drools rule engine, the Drools rule engine evaluates the constraints for each rule and searches for a match. The <code>"objectType"</code> constraint is always implied, after which any number of explicit field constraints are evaluated. The variable <code>$a</code> is a binding variable that references the matched object in the rule consequence.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The dollar sign (<code>$</code>) is optional and helps to differentiate between variable names and field names.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this example, the sample rule and all other files in the <code>~/resources</code> folder of the Drools project are built with the following code:</p>
</div>
<div class="listingblock">
<div class="title">Create the KIE container</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">KieServices kieServices = KieServices.Factory.get();

KieContainer kContainer = kieServices.getKieClasspathContainer();</code></pre>
</div>
</div>
<div class="paragraph">
<p>This code compiles all the rule files found on the class path and adds the result of this compilation, a <code>KieModule</code> object, in the <code>KieContainer</code>.</p>
</div>
<div class="paragraph">
<p>Finally, the <code>StatelessKieSession</code> object is instantiated from the <code>KieContainer</code> and is executed against specified data:</p>
</div>
<div class="listingblock">
<div class="title">Instantiate the stateless KIE session and enter data</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">StatelessKieSession kSession = kContainer.newStatelessKieSession();

Applicant applicant = new Applicant("Mr John Smith", 16);

assertTrue(applicant.isValid());

ksession.execute(applicant);

assertFalse(applicant.isValid());</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a stateless KIE session configuration, the <code>execute()</code> call acts as a combination method that instantiates the <code>KieSession</code> object, adds all the user data and executes user commands, calls <code>fireAllRules()</code>, and then calls <code>dispose()</code>. Therefore, with a stateless KIE session, you do not need to call <code>fireAllRules()</code> or call <code>dispose()</code> after session invocation as you do with a stateful KIE session.</p>
</div>
<div class="paragraph">
<p>In this case, the specified applicant is under the age of 18, so the application is declined.</p>
</div>
<div class="paragraph">
<p>For a more complex use case, see the following example. This example uses a stateless KIE session and executes rules against an iterable list of objects, such as a collection.</p>
</div>
<div class="listingblock">
<div class="title">Expanded data model for driver&#8217;s license application</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class Applicant {
  private String name;
  private int age;
  // Getter and setter methods
}

public class Application {
  private Date dateApplied;
  private boolean valid;
  // Getter and setter methods
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Expanded DRL rule set for driver&#8217;s license application</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">package com.company.license

rule "Is of valid age"
when
  Applicant(age &lt; 18)
  $a : Application()
then
  $a.setValid(false);
end

rule "Application was made this year"
when
  $a : Application(dateApplied &gt; "01-jan-2009")
then
  $a.setValid(false);
end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Expanded Java source with iterable execution in a stateless KIE session</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">StatelessKieSession ksession = kbase.newStatelessKnowledgeSession();
Applicant applicant = new Applicant("Mr John Smith", 16);
Application application = new Application();

assertTrue(application.isValid());
ksession.execute(Arrays.asList(new Object[] { application, applicant }));  <i class="conum" data-value="1"></i><b>(1)</b>
assertFalse(application.isValid());

ksession.execute
  (CommandFactory.newInsertIterable(new Object[] { application, applicant }));  <i class="conum" data-value="2"></i><b>(2)</b>

List&lt;Command&gt; cmds = new ArrayList&lt;Command&gt;();  <i class="conum" data-value="3"></i><b>(3)</b>
cmds.add(CommandFactory.newInsert(new Person("Mr John Smith"), "mrSmith"));
cmds.add(CommandFactory.newInsert(new Person("Mr John Doe"), "mrDoe"));

BatchExecutionResults results = ksession.execute(CommandFactory.newBatchExecution(cmds));
assertEquals(new Person("Mr John Smith"), results.getValue("mrSmith"));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Method for executing rules against an iterable collection of objects produced by the <code>Arrays.asList()</code> method. Every collection element is inserted before any matched rules are executed. The <code>execute(Object object)</code> and <code>execute(Iterable objects)</code> methods are wrappers around the <code>execute(Command command)</code> method that comes from the <code>BatchExecutor</code> interface.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Execution of the iterable collection of objects using the <code>CommandFactory</code> interface.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>BatchExecutor</code> and <code>CommandFactory</code> configurations for working with many different commands or result output identifiers. The <code>CommandFactory</code> interface supports other commands that you can use in the <code>BatchExecutor</code>, such as <code>StartProcess</code>, <code>Query</code>, and <code>SetGlobal</code>.</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="kie-sessions-stateless-globals-con_rule-engine"><a class="anchor" href="#kie-sessions-stateless-globals-con_rule-engine"></a>Global variables in stateless KIE sessions</h4>
<div class="paragraph">
<p>The <code>StatelessKieSession</code> object supports global variables (globals) that you can configure to be resolved as session-scoped globals, delegate globals, or execution-scoped globals.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Session-scoped globals:</strong> For session-scoped globals, you can use the method <code>getGlobals()</code> to return a <code>Globals</code> instance that provides access to the KIE session globals. These globals are used for all execution calls. Use caution with mutable globals because execution calls can be executing simultaneously in different threads.</p>
<div class="listingblock">
<div class="title">Session-scoped global</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.kie.api.runtime.StatelessKieSession;

StatelessKieSession ksession = kbase.newStatelessKieSession();

// Set a global `myGlobal` that can be used in the rules.
ksession.setGlobal("myGlobal", "I am a global");

// Execute while resolving the `myGlobal` identifier.
ksession.execute(collection);</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Delegate globals:</strong> For delegate globals, you can assign a value to a global (with <code>setGlobal(String, Object)</code>) so that the value is stored in an internal collection that maps identifiers to values. Identifiers in this internal collection have priority over any supplied delegate. If an identifier cannot be found in this internal collection, the delegate global (if any) is used.</p>
</li>
<li>
<p><strong>Execution-scoped globals:</strong> For execution-scoped globals, you can use the <code>Command</code> object to set a global that is passed to the <code>CommandExecutor</code> interface for execution-specific global resolution.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>CommandExecutor</code> interface also enables you to export data using out identifiers for globals, inserted facts, and query results:</p>
</div>
<div class="listingblock">
<div class="title">Out identifiers for globals, inserted facts, and query results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.kie.api.runtime.ExecutionResults;

// Set up a list of commands.
List cmds = new ArrayList();
cmds.add(CommandFactory.newSetGlobal("list1", new ArrayList(), true));
cmds.add(CommandFactory.newInsert(new Person("jon", 102), "person"));
cmds.add(CommandFactory.newQuery("Get People" "getPeople"));

// Execute the list.
ExecutionResults results = ksession.execute(CommandFactory.newBatchExecution(cmds));

// Retrieve the `ArrayList`.
results.getValue("list1");
// Retrieve the inserted `Person` fact.
results.getValue("person");
// Retrieve the query as a `QueryResults` instance.
results.getValue("Get People");</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kie-sessions-stateful-con_rule-engine"><a class="anchor" href="#kie-sessions-stateful-con_rule-engine"></a>Stateful KIE sessions</h3>
<div class="paragraph">
<p>A stateful KIE session is a session that uses inference to make iterative changes to facts over time. In a stateful KIE session, data from a previous invocation of the KIE session (the previous session state) is retained between session invocations, whereas in a stateless KIE session, that data is discarded.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Ensure that you call the <code>dispose()</code> method after running a stateful KIE session so that no memory leaks occur between session invocations.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Stateful KIE sessions are commonly used for the following use cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Monitoring</strong>, such as monitoring a stock market and automating the buying process</p>
</li>
<li>
<p><strong>Diagnostics</strong>, such as running fault-finding processes or medical diagnostic processes</p>
</li>
<li>
<p><strong>Logistics</strong>, such as parcel tracking and delivery provisioning</p>
</li>
<li>
<p><strong>Ensuring compliance</strong>, such as verifying the legality of market trades</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, consider the following fire alarm data model and sample DRL rules:</p>
</div>
<div class="listingblock">
<div class="title">Data model for sprinklers and fire alarm</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class Room {
  private String name;
  // Getter and setter methods
}

public class Sprinkler {
  private Room room;
  private boolean on;
  // Getter and setter methods
}

public class Fire {
  private Room room;
  // Getter and setter methods
}

public class Alarm { }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample DRL rule set for activating sprinklers and alarm</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "When there is a fire turn on the sprinkler"
when
  Fire($room : room)
  $sprinkler : Sprinkler(room == $room, on == false)
then
  modify($sprinkler) { setOn(true) };
  System.out.println("Turn on the sprinkler for room "+$room.getName());
end

rule "Raise the alarm when we have one or more fires"
when
    exists Fire()
then
    insert( new Alarm() );
    System.out.println( "Raise the alarm" );
end

rule "Cancel the alarm when all the fires have gone"
when
    not Fire()
    $alarm : Alarm()
then
    delete( $alarm );
    System.out.println( "Cancel the alarm" );
end


rule "Status output when things are ok"
when
    not Alarm()
    not Sprinkler( on == true )
then
    System.out.println( "Everything is ok" );
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the <code>When there is a fire turn on the sprinkler</code> rule, when a fire occurs, the instances of the <code>Fire</code> class are created for that room and inserted into the KIE session. The rule adds a constraint for the specific <code>room</code> matched in the <code>Fire</code> instance so that only the sprinkler for that room is checked. When this rule is executed, the sprinkler activates. The other sample rules determine when the alarm is activated or deactivated accordingly.</p>
</div>
<div class="paragraph">
<p>Whereas a stateless KIE session relies on standard Java syntax to modify a field, a stateful KIE session relies on the <code>modify</code> statement in rules to notify the Drools rule engine of changes. The Drools rule engine then reasons over the changes and assesses impact on subsequent rule executions. This process is part of the Drools rule engine ability to use <em>inference</em> and <em>truth maintenance</em> and is essential in stateful KIE sessions.</p>
</div>
<div class="paragraph">
<p>In this example, the sample rules and all other files in the <code>~/resources</code> folder of the Drools project are built with the following code:</p>
</div>
<div class="listingblock">
<div class="title">Create the KIE container</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">KieServices kieServices = KieServices.Factory.get();
KieContainer kContainer = kieServices.getKieClasspathContainer();</code></pre>
</div>
</div>
<div class="paragraph">
<p>This code compiles all the rule files found on the class path and adds the result of this compilation, a <code>KieModule</code> object, in the <code>KieContainer</code>.</p>
</div>
<div class="paragraph">
<p>Finally, the <code>KieSession</code> object is instantiated from the <code>KieContainer</code> and is executed against specified data:</p>
</div>
<div class="listingblock">
<div class="title">Instantiate the stateful KIE session and enter data</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">KieSession ksession = kContainer.newKieSession();

String[] names = new String[]{"kitchen", "bedroom", "office", "livingroom"};
Map&lt;String,Room&gt; name2room = new HashMap&lt;String,Room&gt;();
for( String name: names ){
    Room room = new Room( name );
    name2room.put( name, room );
    ksession.insert( room );
    Sprinkler sprinkler = new Sprinkler( room );
    ksession.insert( sprinkler );
}

ksession.fireAllRules();</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Console output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">&gt; Everything is ok</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the data added, the Drools rule engine completes all pattern matching but no rules have been executed, so the configured verification message appears. As new data triggers rule conditions, the Drools rule engine executes rules to activate the alarm and later to cancel the alarm that has been activated:</p>
</div>
<div class="listingblock">
<div class="title">Enter new data to trigger rules</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Fire kitchenFire = new Fire( name2room.get( "kitchen" ) );
Fire officeFire = new Fire( name2room.get( "office" ) );

FactHandle kitchenFireHandle = ksession.insert( kitchenFire );
FactHandle officeFireHandle = ksession.insert( officeFire );

ksession.fireAllRules();</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Console output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">&gt; Raise the alarm
&gt; Turn on the sprinkler for room kitchen
&gt; Turn on the sprinkler for room office</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ksession.delete( kitchenFireHandle );
ksession.delete( officeFireHandle );

ksession.fireAllRules();</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Console output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">&gt; Cancel the alarm
&gt; Turn off the sprinkler for room office
&gt; Turn off the sprinkler for room kitchen
&gt; Everything is ok</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, a reference is kept for the returned <code>FactHandle</code> object. A fact handle is an internal engine reference to the inserted instance and enables instances to be retracted or modified later.</p>
</div>
<div class="paragraph">
<p>As this example illustrates, the data and results from previous stateful KIE sessions (the activated alarm) affect the invocation of subsequent sessions (alarm cancellation).</p>
</div>
</div>
<div class="sect2">
<h3 id="kie-sessions-pools-con_rule-engine"><a class="anchor" href="#kie-sessions-pools-con_rule-engine"></a>KIE session pools</h3>
<div class="paragraph">
<p>In use cases with large amounts of KIE runtime data and high system activity, KIE sessions might be created and disposed very frequently. A high turnover of KIE sessions is not always time consuming, but when the turnover is repeated millions of times, the process can become a bottleneck and require substantial clean-up effort.</p>
</div>
<div class="paragraph">
<p>For these high-volume cases, you can use KIE session pools instead of many individual KIE sessions. To use a KIE session pool, you obtain a KIE session pool from a KIE container, define the initial number of KIE sessions in the pool, and create the KIE sessions from that pool as usual:</p>
</div>
<div class="listingblock">
<div class="title">Example KIE session pool</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// Obtain a KIE session pool from the KIE container
KieContainerSessionsPool pool = kContainer.newKieSessionsPool(10);

// Create KIE sessions from the KIE session pool
KieSession kSession = pool.newKieSession();</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the KIE session pool starts with 10 KIE sessions in it, but you can specify the number of KIE sessions that you need. This integer value is the number of KIE sessions that are only initially created in the pool. If required by the running application, the number of KIE sessions in the pool can dynamically grow beyond that value.</p>
</div>
<div class="paragraph">
<p>After you define a KIE session pool, the next time you use the KIE session as usual and call <code>dispose()</code> on it, the KIE session is reset and pushed back into the pool instead of being destroyed.</p>
</div>
<div class="paragraph">
<p>KIE session pools typically apply to stateful KIE sessions, but KIE session pools can also affect stateless KIE sessions that you reuse with multiple <code>execute()</code> calls. When you create a stateless KIE session directly from a KIE container, the KIE session continues to internally create a new KIE session for each <code>execute()</code> invocation. Conversely, when you create a stateless KIE session from a KIE session pool, the KIE session internally uses only the specific KIE sessions provided by the pool.</p>
</div>
<div class="paragraph">
<p>When you finish using a KIE session pool, you can call the <code>shutdown()</code> method on it to avoid memory leaks. Alternatively, you can call <code>dispose()</code> on the KIE container to shut down all the pools created from the KIE container.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="inference-and-truth-maintenance_rule-engine"><a class="anchor" href="#inference-and-truth-maintenance_rule-engine"></a>Inference and truth maintenance in the Drools rule engine</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The basic function of the Drools rule engine is to match data to business rules and determine whether and how to execute rules. To ensure that relevant data is applied to the appropriate rules, the Drools rule engine makes <em>inferences</em> based on existing knowledge and performs the actions based on the inferred information.</p>
</div>
<div class="paragraph">
<p>For example, the following DRL rule determines the age requirements for adults, such as in a bus pass policy:</p>
</div>
<div class="listingblock">
<div class="title">Rule to define age requirement</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Infer Adult"
when
  $p : Person(age &gt;= 18)
then
  insert(new IsAdult($p));
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Based on this rule, the Drools rule engine infers whether a person is an adult or a child and performs the specified action (the <code>then</code> consequence). Every person who is 18 years old or older has an instance of <code>IsAdult</code> inserted for them in the working memory. This inferred relation of age and bus pass can then be invoked in any rule, such as in the following rule segment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$p : Person()
IsAdult(person == $p)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In many cases, new data in a rule system is the result of other rule executions, and this new data can affect the execution of other rules. If the Drools rule engine asserts data as a result of executing a rule, the Drools rule engine uses truth maintenance to justify the assertion and enforce truthfulness when applying inferred information to other rules. Truth maintenance also helps to identify inconsistencies and to handle contradictions. For example, if two rules are executed and result in a contradictory action, the Drools rule engine chooses the action based on assumptions from previously calculated conclusions.</p>
</div>
<div class="paragraph">
<p>The Drools rule engine inserts facts using either stated or logical insertions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Stated insertions:</strong> Defined with <code>insert()</code>. After stated insertions, facts are generally retracted explicitly. (The term <em>insertion</em>, when used generically, refers to <em>stated insertion</em>.)</p>
</li>
<li>
<p><strong>Logical insertions:</strong> Defined with <code>insertLogical()</code>. After logical insertions, the facts that were inserted are automatically retracted when the conditions in the rules that inserted the facts are no longer true. The facts are retracted when no condition supports the logical insertion. A fact that is logically inserted is considered to be <em>justified</em> by the Drools rule engine.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, the following sample DRL rules use stated fact insertion to determine the age requirements for issuing a child bus pass or an adult bus pass:</p>
</div>
<div class="listingblock">
<div class="title">Rules to issue bus pass, stated insertion</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Issue Child Bus Pass"
when
  $p : Person(age &lt; 18)
then
  insert(new ChildBusPass($p));
end

rule "Issue Adult Bus Pass"
when
  $p : Person(age &gt;= 18)
then
  insert(new AdultBusPass($p));
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>These rules are not easily maintained in the Drools rule engine as bus riders increase in age and move from child to adult bus pass. As an alternative, these rules can be separated into rules for bus rider age and rules for bus pass type using logical fact insertion. The logical insertion of the fact makes the fact dependent on the truth of the <code>when</code> clause.</p>
</div>
<div class="paragraph">
<p>The following DRL rules use logical insertion to determine the age requirements for children and adults:</p>
</div>
<div class="listingblock">
<div class="title">Children and adult age requirements, logical insertion</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Infer Child"
when
  $p : Person(age &lt; 18)
then
  insertLogical(new IsChild($p));
end

rule "Infer Adult"
when
  $p : Person(age &gt;= 18)
then
  insertLogical(new IsAdult($p));
end</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
For logical insertions, your fact objects must override the <code>equals</code> and <code>hashCode</code> methods from the <code>java.lang.Object</code> object according to the Java standard. Two objects are equal if their <code>equals</code> methods return <code>true</code> for each other and if their <code>hashCode</code> methods return the same values. For more information, see the Java API documentation for your Java version.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the condition in the rule is false, the fact is automatically retracted. This behavior is helpful in this example because the two rules are mutually exclusive. In this example, if the person is younger than 18 years old, the rule logically inserts an <code>IsChild</code> fact. After the person is 18 years old or older, the <code>IsChild</code> fact is automatically retracted and the <code>IsAdult</code> fact is inserted.</p>
</div>
<div class="paragraph">
<p>The following DRL rules then determine whether to issue a child bus pass or an adult bus pass and logically insert the <code>ChildBusPass</code> and <code>AdultBusPass</code> facts. This rule configuration is possible because the truth maintenance system in the Drools rule engine supports chaining of logical insertions for a cascading set of retracts.</p>
</div>
<div class="listingblock">
<div class="title">Rules to issue bus pass, logical insertion</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Issue Child Bus Pass"
when
  $p : Person()
    IsChild(person == $p)
then
  insertLogical(new ChildBusPass($p));
end

rule "Issue Adult Bus Pass"
when
  $p : Person()
    IsAdult(person =$p)
then
  insertLogical(new AdultBusPass($p));
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>When a person turns 18 years old, the <code>IsChild</code> fact and the person&#8217;s <code>ChildBusPass</code> fact is retracted. To these set of conditions, you can relate another rule that states that a person must return the child pass after turning 18 years old. When the Drools rule engine automatically retracts the <code>ChildBusPass</code> object, the following rule is executed to send a request to the person:</p>
</div>
<div class="listingblock">
<div class="title">Rule to notify bus pass holder of new pass</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Return ChildBusPass Request"
when
  $p : Person()
    not(ChildBusPass(person == $p))
then
  requestChildBusPass($p);
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following flowcharts illustrate the life cycle of stated and logical insertions:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/rule-engine/Stated_Assertion.png" alt="Stated Assertion">
</div>
<div class="title">Figure 2. Stated insertion</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/rule-engine/Logical_Assertion.png" alt="Logical Assertion">
</div>
<div class="title">Figure 3. Logical insertion</div>
</div>
<div class="paragraph">
<p>When the Drools rule engine logically inserts an object during a rule execution, the Drools rule engine <em>justifies</em> the object by executing the rule. For each logical insertion, only one equal object can exist, and each subsequent equal logical insertion increases the justification counter for that logical insertion. A justification is removed when the conditions of the rule become untrue. When no more justifications exist, the logical object is automatically retracted.</p>
</div>
<div class="sect2">
<h3 id="_government_id_example"><a class="anchor" href="#_government_id_example"></a>Government ID example</h3>
<div class="paragraph">
<p>So now we know what inference is, and have a basic example, how does this facilitate good rule design and maintenance?</p>
</div>
<div class="paragraph">
<p>Consider a government ID department that is responsible for issuing ID cards when children become adults.
They might have a decision table that includes logic like this, which says when an adult living in London is 18 or over, issue the card:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top" style="background-color: #bfbfbf;"></td>
<td class="tableblock halign-center valign-top" colspan="3" style="background-color: #000000;"><p class="tableblock"><span class="white">RuleTable ID Card</span></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" style="background-color: #bfbfbf;"></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffcc99;"><p class="tableblock">CONDITION</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffcc99;"><p class="tableblock">CONDITION</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffcc99;"><p class="tableblock">ACTION</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" style="background-color: #bfbfbf;"></td>
<td class="tableblock halign-center valign-top" colspan="2" style="background-color: #ffcc99;"><p class="tableblock">p : Person</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffcc99;"></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" style="background-color: #bfbfbf;"></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffcc99;"><p class="tableblock">location</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffcc99;"><p class="tableblock">age &gt;= $1</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffcc99;"><p class="tableblock">issueIdCard($1)</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" style="background-color: #ccffcc;"></td>
<td class="tableblock halign-center valign-top" style="background-color: #ccffff;"><p class="tableblock">Select Person</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ccffff;"><p class="tableblock">Select Adults</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffff99;"><p class="tableblock">Issue ID Card</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" style="background-color: #ffffff;"><p class="tableblock">Issue ID Card to Adults</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffffff;"><p class="tableblock">London</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffffff;"><p class="tableblock">18</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffffff;"><p class="tableblock">p</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>However the ID department does not set the policy on who an adult is.
That&#8217;s done at a central government level.
If the central government were to change that age to 21, this would initiate a change management process.
Someone would have to liaise with the ID department and make sure their systems are updated, in time for the law going live.</p>
</div>
<div class="paragraph">
<p>This change management process and communication between departments is not ideal for an agile environment, and change becomes costly and error prone.
Also the card department is managing more information than it needs to be aware of with its "monolithic" approach to rules management which is "leaking" information better placed elsewhere.
By this I mean that it doesn&#8217;t care what explicit "age &gt;= 18" information determines whether someone is an adult, only that they are an adult.</p>
</div>
<div class="paragraph">
<p>In contrast to this, let&#8217;s pursue an approach where we split (de-couple) the authoring responsibilities, so that both the central government and the ID department maintain their own rules.</p>
</div>
<div class="paragraph">
<p>It&#8217;s the central government&#8217;s job to determine who is an adult.
If they change the law they just update their central repository with the new rules, which others use:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top" style="background-color: #bfbfbf;"></td>
<td class="tableblock halign-center valign-top" colspan="2" style="background-color: #000000;"><p class="tableblock"><span class="white">RuleTable Age Policy</span></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" style="background-color: #bfbfbf;"></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffcc94;"><p class="tableblock">CONDITION</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffcc94;"><p class="tableblock">ACTION</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" style="background-color: #bfbfbf;"></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffcc94;"><p class="tableblock">p : Person</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffcc94;"></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" style="background-color: #bfbfbf;"></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffcc94;"><p class="tableblock">age &gt;= $1</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffcc94;"><p class="tableblock">insert($1)</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" style="background-color: #b9ffca;"></td>
<td class="tableblock halign-center valign-top" style="background-color: #ccffff;"><p class="tableblock">Adult Age Policy</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #f7ff92;"><p class="tableblock">Add Adult Relation</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" style="background-color: #ffffff;"><p class="tableblock">Infer Adult</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffffff;"><p class="tableblock">18</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffffff;"><p class="tableblock">new IsAdult( p )</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The IsAdult fact, as discussed previously, is inferred from the policy rules.
It encapsulates the seemingly arbitrary piece of logic "age &gt;= 18" and provides semantic abstractions for its meaning.
Now if anyone uses the above rules, they no longer need to be aware of explicit information that determines whether someone is an adult or not.
They can just use the inferred fact:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top" style="background-color: #c0c0c0;"></td>
<td class="tableblock halign-center valign-top" colspan="3" style="background-color: #000000;"><p class="tableblock"><span class="white">RuleTable ID Card</span></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" style="background-color: #c0c0c0;"></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffcc99;"><p class="tableblock">CONDITION</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffcc99;"><p class="tableblock">CONDITION</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffcc99;"><p class="tableblock">ACTION</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" style="background-color: #c0c0c0;"></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffcc99;"><p class="tableblock">p : Person</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffcc99;"><p class="tableblock">isAdult</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffcc99;"></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" style="background-color: #c0c0c0;"></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffcc99;"><p class="tableblock">location</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffcc99;"><p class="tableblock">person == $1</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffcc99;"><p class="tableblock">issueIdCard($1)</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" style="background-color: #ccffcc;"></td>
<td class="tableblock halign-center valign-top" style="background-color: #ccffff;"><p class="tableblock">Select Person</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ccffff;"><p class="tableblock">Select Adults</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffff99;"><p class="tableblock">Issue ID Card</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" style="background-color: #ffffff;"><p class="tableblock">Issue ID Card to Adults</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffffff;"><p class="tableblock">London</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffffff;"><p class="tableblock">p</p></td>
<td class="tableblock halign-center valign-top" style="background-color: #ffffff;"><p class="tableblock">p</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>While the example is very minimal and trivial it illustrates some important points.
We started with a monolithic and leaky approach to our knowledge engineering.
We created a single decision table that had all possible information in it and that leaks information from central government that the ID department did not care about and did not want to manage.</p>
</div>
<div class="paragraph">
<p>We first de-coupled the knowledge process so each department was responsible for only what it needed to know.
We then encapsulated this leaky knowledge using an inferred fact IsAdult.
The use of the term IsAdult also gave a semantic abstraction to the previously arbitrary logic "age &gt;= 18".</p>
</div>
<div class="paragraph">
<p>So a general rule of thumb when doing your knowledge engineering is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Bad</strong></p>
<div class="ulist">
<ul>
<li>
<p>Monolithic</p>
</li>
<li>
<p>Leaky</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Good</strong></p>
<div class="ulist">
<ul>
<li>
<p>De-couple knowledge responsibilities</p>
</li>
<li>
<p>Encapsulate knowledge</p>
</li>
<li>
<p>Provide semantic abstractions for those encapsulations</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="fact-equality-modes-con_rule-engine"><a class="anchor" href="#fact-equality-modes-con_rule-engine"></a>Fact equality modes in the Drools rule engine</h3>
<div class="paragraph">
<p>The Drools rule engine supports the following fact equality modes that determine how the Drools rule engine stores and compares inserted facts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>identity</code>: (Default) The Drools rule engine uses an <code>IdentityHashMap</code> to store all inserted facts. For every new fact insertion, the Drools rule engine returns a new <code>FactHandle</code> object. If a fact is inserted again, the Drools rule engine returns the original <code>FactHandle</code> object, ignoring repeated insertions for the same fact. In this mode, two facts are the same for the Drools rule engine only if they are the very same object with the same identity.</p>
</li>
<li>
<p><code>equality</code>: The Drools rule engine uses a <code>HashMap</code> to store all inserted facts. The Drools rule engine returns a new <code>FactHandle</code> object only if the inserted fact is not equal to an existing fact, according to the <code>equals()</code> method of the inserted fact. In this mode, two facts are the same for the Drools rule engine if they are composed the same way, regardless of identity. Use this mode when you want objects to be assessed based on feature equality instead of explicit identity.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As an illustration of fact equality modes, consider the following example facts:</p>
</div>
<div class="listingblock">
<div class="title">Example facts</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person p1 = new Person("John", 45);
Person p2 = new Person("John", 45);</code></pre>
</div>
</div>
<div class="paragraph">
<p>In <code>identity</code> mode, facts <code>p1</code> and <code>p2</code> are different instances of a <code>Person</code> class and are treated as separate objects because they have separate identities. In <code>equality</code> mode, facts <code>p1</code> and <code>p2</code> are treated as the same object because they are composed the same way. This difference in behavior affects how you can interact with fact handles.</p>
</div>
<div class="paragraph">
<p>For example, assume that you insert facts <code>p1</code> and <code>p2</code> into the Drools rule engine and later you want to retrieve the fact handle for <code>p1</code>. In <code>identity</code> mode, you must specify <code>p1</code> to return the fact handle for that exact object, whereas in <code>equality</code> mode, you can specify <code>p1</code>, <code>p2</code>, or <code>new Person("John", 45)</code> to return the fact handle.</p>
</div>
<div class="listingblock">
<div class="title">Example code to insert a fact and return the fact handle in <code>identity</code> mode</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">ksession.insert(p1);

ksession.getFactHandle(p1);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example code to insert a fact and return the fact handle in <code>equality</code> mode</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">ksession.insert(p1);

ksession.getFactHandle(p1);

// Alternate option:
ksession.getFactHandle(new Person("John", 45));</code></pre>
</div>
</div>
<div class="paragraph">
<p>To set the fact equality mode, use one of the following options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set the system property <code>drools.equalityBehavior</code> to <code>identity</code> (default) or <code>equality</code>.</p>
</li>
<li>
<p>Set the equality mode while creating the KIE base programmatically:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">KieServices ks = KieServices.get();
KieBaseConfiguration kieBaseConf = ks.newKieBaseConfiguration();
kieBaseConf.setOption(EqualityBehaviorOption.EQUALITY);
KieBase kieBase = kieContainer.newKieBase(kieBaseConf);</code></pre>
</div>
</div>
</li>
<li>
<p>Set the equality mode in the KIE module descriptor file (<code>kmodule.xml</code>) for a specific Drools project:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;kmodule&gt;
  ...
  &lt;kbase name="KBase2" default="false" equalsBehavior="equality" packages="org.domain.pkg2, org.domain.pkg3" includes="KBase1"&gt;
    ...
  &lt;/kbase&gt;
  ...
&lt;/kmodule&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="execution-control-con_rule-engine"><a class="anchor" href="#execution-control-con_rule-engine"></a>Execution control in the Drools rule engine</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When new rule data enters the working memory of the Drools rule engine, rules may become fully matched and eligible for execution. A single working memory action can result in multiple eligible rule executions. When a rule is fully matched, the Drools rule engine creates an internalMatch instance, referencing the rule and the matched facts, and adds the internalMatch onto the Drools rule engine agenda. The agenda controls the execution order of these rule internalMatches using a conflict resolution strategy.</p>
</div>
<div class="paragraph">
<p>After the first call of <code>fireAllRules()</code> in the Java application, the Drools rule engine cycles repeatedly through two phases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Agenda evaluation.</strong> In this phase, the Drools rule engine selects all rules that can be executed. If no executable rules exist, the execution cycle ends. If an executable rule is found, the Drools rule engine registers the internalMatch in the agenda and then moves on to the working memory actions phase to perform rule consequence actions.</p>
</li>
<li>
<p><strong>Working memory actions.</strong> In this phase, the Drools rule engine performs the rule consequence actions (the <code>then</code> portion of each rule) for all activated rules previously registered in the agenda. After all the consequence actions are complete or the main Java application process calls <code>fireAllRules()</code> again, the Drools rule engine returns to the agenda evaluation phase to reassess rules.</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/rule-engine/Two_Phase.png" alt="Two Phase">
</div>
<div class="title">Figure 4. Two-phase execution process in the Drools rule engine</div>
</div>
<div class="paragraph">
<p>When multiple rules exist on the agenda, the execution of one rule may cause another rule to be removed from the agenda. To avoid this, you can define how and when rules are executed in the Drools rule engine. Some common methods for defining rule execution order are by using rule salience, agenda groups, or internalMatch groups.</p>
</div>
<div class="sect2">
<h3 id="_salience_for_rules"><a class="anchor" href="#_salience_for_rules"></a>Salience for rules</h3>
<div class="paragraph">
<p>Each rule has an integer <code>salience</code> attribute that determines the order of execution. Rules with a higher salience value are given higher priority when ordered in the internalMatch queue. The default salience value for rules is zero, but the salience can be negative or positive.</p>
</div>
<div class="paragraph">
<p>For example, the following sample DRL rules are listed in the Drools rule engine stack in the order shown:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "RuleA"
salience 95
when
    $fact : MyFact( field1 == true )
then
    System.out.println("Rule2 : " + $fact);
    update($fact);
end

rule "RuleB"
salience 100
when
   $fact : MyFact( field1 == false )
then
   System.out.println("Rule1 : " + $fact);
   $fact.setField1(true);
   update($fact);
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>RuleB</code> rule is listed second, but it has a higher salience value than the <code>RuleA</code> rule and is therefore executed first.</p>
</div>
</div>
<div class="sect2">
<h3 id="_agenda_groups_for_rules"><a class="anchor" href="#_agenda_groups_for_rules"></a>Agenda groups for rules</h3>
<div class="paragraph">
<p>An agenda group is a set of rules bound together by the same <code>agenda-group</code> rule attribute. Agenda groups partition rules on the Drools rule engine agenda. At any one time, only one group has a <em>focus</em> that gives that group of rules priority for execution before rules in other agenda groups. You determine the focus with a <code>setFocus()</code> call for the agenda group. You can also define rules with an <code>auto-focus</code> attribute so that the next time the rule is activated, the focus is automatically given to the entire agenda group to which the rule is assigned.</p>
</div>
<div class="paragraph">
<p>Each time the <code>setFocus()</code> call is made in a Java application, the Drools rule engine adds the specified agenda group to the top of the rule stack. The default agenda group <code>"MAIN"</code> contains all rules that do not belong to a specified agenda group and is executed first in the stack unless another group has the focus.</p>
</div>
<div class="paragraph">
<p>For example, the following sample DRL rules belong to specified agenda groups and are listed in the Drools rule engine stack in the order shown:</p>
</div>
<div class="listingblock">
<div class="title">Sample DRL rules for banking application</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Increase balance for credits"
  agenda-group "calculation"
when
  ap : AccountPeriod()
  acc : Account( $accountNo : accountNo )
  CashFlow( type == CREDIT,
            accountNo == $accountNo,
            date &gt;= ap.start &amp;&amp; &lt;= ap.end,
            $amount : amount )
then
  acc.balance  += $amount;
end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Print balance for AccountPeriod"
  agenda-group "report"
when
  ap : AccountPeriod()
  acc : Account()
then
  System.out.println( acc.accountNo +
                      " : " + acc.balance );
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>For this example, the rules in the <code>"calculation"</code> agenda group must always be executed first and the rules in the <code>"report"</code> agenda group must always be executed second. Any remaining rules in other agenda groups can then be executed. Therefore, the <code>"report"</code> and <code>"calculation"</code> groups must receive the focus to be executed in reverse order (due to the fact that the agenda groups are placed on a stack), before other rules can be executed:</p>
</div>
<div class="listingblock">
<div class="title">Set the focus for the order of agenda group execution</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Agenda agenda = ksession.getAgenda();
agenda.getAgendaGroup( "report" ).setFocus();
agenda.getAgendaGroup( "calculation" ).setFocus();
ksession.fireAllRules();</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use the <code>clear()</code> method to cancel all the internalMatches generated by the rules belonging to a given agenda group before each has had a chance to be executed:</p>
</div>
<div class="listingblock">
<div class="title">Cancel all other rule internalMatches</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ksession.getAgenda().getAgendaGroup( "Group A" ).clear();</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_activation_groups_for_rules"><a class="anchor" href="#_activation_groups_for_rules"></a>Activation groups for rules</h3>
<div class="paragraph">
<p>An internalMatch group is a set of rules bound together by the same <code>activation-group</code> rule attribute. In this group, only one rule can be executed. After conditions are met for a rule in that group to be executed, all other pending rule executions from that internalMatch group are removed from the agenda.</p>
</div>
<div class="paragraph">
<p>For example, the following sample DRL rules belong to the specified internalMatch group and are listed in the Drools rule engine stack in the order shown:</p>
</div>
<div class="listingblock">
<div class="title">Sample DRL rules for banking</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Print balance for AccountPeriod1"
  activation-group "report"
when
  ap : AccountPeriod1()
  acc : Account()
then
  System.out.println( acc.accountNo +
                      " : " + acc.balance );
end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Print balance for AccountPeriod2"
  activation-group "report"
when
  ap : AccountPeriod2()
  acc : Account()
then
  System.out.println( acc.accountNo +
                      " : " + acc.balance );
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>For this example, if the first rule in the <code>"report"</code> internalMatch group is executed, the second rule in the group and all other executable rules on the agenda are removed from the agenda.</p>
</div>
</div>
<div class="sect2">
<h3 id="rule-execution-modes-con_rule-engine"><a class="anchor" href="#rule-execution-modes-con_rule-engine"></a>Rule execution modes and thread safety in the Drools rule engine</h3>
<div class="paragraph">
<p>The Drools rule engine supports the following rule execution modes that determine how and when the Drools rule engine executes rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Passive mode</strong>: (Default) The Drools rule engine evaluates rules when a user or an application explicitly calls <code>fireAllRules()</code>. Passive mode in the Drools rule engine is best for applications that require direct control over rule evaluation and execution, or for complex event processing (CEP) applications that use the pseudo clock implementation in the Drools rule engine.</p>
<div class="listingblock">
<div class="title">Example CEP application code with the Drools rule engine in passive mode</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">KieSessionConfiguration config = KieServices.Factory.get().newKieSessionConfiguration();
config.setOption( ClockTypeOption.get("pseudo") );
KieSession session = kbase.newKieSession( conf, null );
SessionPseudoClock clock = session.getSessionClock();

session.insert( tick1 );
session.fireAllRules();

clock.advanceTime(1, TimeUnit.SECONDS);
session.insert( tick2 );
session.fireAllRules();

clock.advanceTime(1, TimeUnit.SECONDS);
session.insert( tick3 );
session.fireAllRules();

session.dispose();</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Active mode</strong>: If a user or application calls <code>fireUntilHalt()</code>, the Drools rule engine starts in active mode and evaluates rules continually until the user or application explicitly calls <code>halt()</code>. Active mode in the Drools rule engine is best for applications that delegate control of rule evaluation and execution to the Drools rule engine, or for complex event processing (CEP) applications that use the real-time clock implementation in the Drools rule engine. Active mode is also optimal for CEP applications that use active queries.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example CEP application code with the Drools rule engine in active mode</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">KieSessionConfiguration config = KieServices.Factory.get().newKieSessionConfiguration();
config.setOption( ClockTypeOption.get("realtime") );
KieSession session = kbase.newKieSession( conf, null );

new Thread( new Runnable() {
  @Override
  public void run() {
      session.fireUntilHalt();
  }
} ).start();

session.insert( tick1 );

... Thread.sleep( 1000L ); ...

session.insert( tick2 );

... Thread.sleep( 1000L ); ...

session.insert( tick3 );

session.halt();
session.dispose();</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example calls <code>fireUntilHalt()</code> from a dedicated execution thread to prevent the current thread from being blocked indefinitely while the Drools rule engine continues evaluating rules. The dedicated thread also enables you to call <code>halt()</code> at a later stage in the application code.</p>
</div>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Although you should avoid using both <code>fireAllRules()</code> and <code>fireUntilHalt()</code> calls, especially from different threads, the Drools rule engine can handle such situations safely using thread-safety logic and an internal state machine. If a <code>fireAllRules()</code> call is in progress and you call <code>fireUntilHalt()</code>, the Drools rule engine continues to run in passive mode until the <code>fireAllRules()</code> operation is complete and then starts in active mode in response to the <code>fireUntilHalt()</code> call. However, if the Drools rule engine is running in active mode following a <code>fireUntilHalt()</code> call and you call <code>fireAllRules()</code>, the <code>fireAllRules()</code> call is ignored and the Drools rule engine continues to run in active mode until you call <code>halt()</code>.</p>
</div>
<div class="paragraph">
<p>For added thread safety in active mode, the Drools rule engine supports a <code>submit()</code> method that you can use to group and perform operations on a KIE session in a thread-safe, atomic action:</p>
</div>
<div class="listingblock">
<div class="title">Example application code with <code>submit()</code> method to perform atomic operations in active mode</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">KieSession session = ...;

new Thread( new Runnable() {
  @Override
  public void run() {
      session.fireUntilHalt();
  }
} ).start();

final FactHandle fh = session.insert( fact_a );

... Thread.sleep( 1000L ); ...

session.submit( new KieSession.AtomicAction() {
  @Override
  public void execute( KieSession kieSession ) {
    fact_a.setField("value");
    kieSession.update( fh, fact_a );
    kieSession.insert( fact_1 );
    kieSession.insert( fact_2 );
    kieSession.insert( fact_3 );
  }
} );

... Thread.sleep( 1000L ); ...

session.insert( fact_z );

session.halt();
session.dispose();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Thread safety and atomic operations are also helpful from a client-side perspective. For example, you might need to insert more than one fact at a given time, but require the Drools rule engine to consider the insertions as an atomic operation and to wait until all the insertions are complete before evaluating the rules again.</p>
</div>
</div>
<div class="sect2">
<h3 id="fact-propagation-modes-con_rule-engine"><a class="anchor" href="#fact-propagation-modes-con_rule-engine"></a>Fact propagation modes in the Drools rule engine</h3>
<div class="paragraph">
<p>The Drools rule engine supports the following fact propagation modes that determine how the Drools rule engine progresses inserted facts through the engine network in preparation for rule execution:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Lazy</strong>: (Default) Facts are propagated in batch collections at rule execution, not in real time as the facts are individually inserted by a user or application. As a result, the order in which the facts are ultimately propagated through the Drools rule engine may be different from the order in which the facts were individually inserted.</p>
</li>
<li>
<p><strong>Immediate</strong>: Facts are propagated immediately in the order that they are inserted by a user or application.</p>
</li>
<li>
<p><strong>Eager</strong>: Facts are propagated lazily (in batch collections), but before rule execution. The Drools rule engine uses this propagation behavior for rules that have the <code>no-loop</code> or <code>lock-on-active</code> attribute.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By default, the Phreak rule algorithm in the Drools rule engine uses lazy fact propagation for improved rule evaluation overall. However, in few cases, this lazy propagation behavior can alter the expected result of certain rule executions that may require immediate or eager propagation.</p>
</div>
<div class="paragraph">
<p>For example, the following rule uses a specified query with a <code>?</code> prefix to invoke the query in pull-only or passive fashion:</p>
</div>
<div class="listingblock">
<div class="title">Example rule with a passive query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">query Q (Integer i)
    String( this == i.toString() )
end

rule "Rule"
  when
    $i : Integer()
    ?Q( $i; )
  then
    System.out.println( $i );
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>For this example, the rule should be executed only when a <code>String</code> that satisfies the query is inserted before the <code>Integer</code>, such as in the following example commands:</p>
</div>
<div class="listingblock">
<div class="title">Example commands that should trigger the rule execution</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">KieSession ksession = ...
ksession.insert("1");
ksession.insert(1);
ksession.fireAllRules();</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, due to the default lazy propagation behavior in Phreak, the Drools rule engine does not detect the insertion sequence of the two facts in this case, so this rule is executed regardless of <code>String</code> and <code>Integer</code> insertion order. For this example, immediate propagation is required for the expected rule evaluation.</p>
</div>
<div class="paragraph">
<p>To alter the Drools rule engine propagation mode to achieve the expected rule evaluation in this case, you can add the <code>@Propagation(&lt;type&gt;)</code> tag to your rule and set <code>&lt;type&gt;</code> to <code>LAZY</code>, <code>IMMEDIATE</code>, or <code>EAGER</code>.</p>
</div>
<div class="paragraph">
<p>In the same example rule, the immediate propagation annotation enables the rule to be evaluated only when a <code>String</code> that satisfies the query is inserted before the <code>Integer</code>, as expected:</p>
</div>
<div class="listingblock">
<div class="title">Example rule with a passive query and specified propagation mode</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">query Q (Integer i)
    String( this == i.toString() )
end

rule "Rule" @Propagation(IMMEDIATE)
  when
    $i : Integer()
    ?Q( $i; )
  then
    System.out.println( $i );
end</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="agenda-filters-con_rule-engine"><a class="anchor" href="#agenda-filters-con_rule-engine"></a>Agenda evaluation filters</h3>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/rule-engine/AgendaFilter.png" alt="AgendaFilter">
</div>
<div class="title">Figure 5. AgendaFilters</div>
</div>
<div class="paragraph">
<p>The Drools rule engine supports an <code>AgendaFilter</code> object in the filter interface that you can use to allow or deny the evaluation of specified rules during agenda evaluation. You can specify an agenda filter as part of a <code>fireAllRules()</code> call.</p>
</div>
<div class="paragraph">
<p>The following example code permits only rules ending with the string <code>"Test"</code> to be evaluated and executed. All other rules are filtered out of the Drools rule engine agenda.</p>
</div>
<div class="listingblock">
<div class="title">Example agenda filter definition</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ksession.fireAllRules( new RuleNameEndsWithAgendaFilter( "Test" ) );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="phreak-algorithm-con_rule-engine"><a class="anchor" href="#phreak-algorithm-con_rule-engine"></a>Phreak rule algorithm in the Drools rule engine</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Drools rule engine in Drools uses the Phreak algorithm for rule evaluation. Phreak evolved from the Rete algorithm, including the enhanced Rete algorithm ReteOO that was introduced in previous versions of Drools for object-oriented systems. Overall, Phreak is more scalable than Rete and ReteOO, and is faster in large systems.</p>
</div>
<div class="paragraph">
<p>While Rete is considered eager (immediate rule evaluation) and data oriented, Phreak is considered lazy (delayed rule evaluation) and goal oriented. The Rete algorithm performs many actions during the insert, update, and delete actions in order to find partial matches for all rules. This eagerness of the Rete algorithm during rule matching requires a lot of time before eventually executing rules, especially in large systems. With Phreak, this partial matching of rules is delayed deliberately to handle large amounts of data more efficiently.</p>
</div>
<div class="paragraph">
<p>The Phreak algorithm adds the following set of enhancements to previous Rete algorithms:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Three layers of contextual memory: Node, segment, and rule memory types</p>
</li>
<li>
<p>Rule-based, segment-based, and node-based linking</p>
</li>
<li>
<p>Lazy (delayed) rule evaluation</p>
</li>
<li>
<p>Stack-based evaluations with pause and resume</p>
</li>
<li>
<p>Isolated rule evaluation</p>
</li>
<li>
<p>Set-oriented propagations</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="phreak-rule-evaluation-con_rule-engine"><a class="anchor" href="#phreak-rule-evaluation-con_rule-engine"></a>Rule evaluation in Phreak</h3>
<div class="paragraph">
<p>When the Drools rule engine starts, all rules are considered to be <em>unlinked</em> from pattern-matching data that can trigger the rules. At this stage, the Phreak algorithm in the Drools rule engine does not evaluate the rules. The <code>insert</code>, <code>update</code>, and <code>delete</code> actions are queued, and Phreak uses a heuristic, based on the rule most likely to result in execution, to calculate and select the next rule for evaluation. When all the required input values are populated for a rule, the rule is considered to be <em>linked</em> to the relevant pattern-matching data. Phreak then creates a goal that represents this rule and places the goal into a priority queue that is ordered by rule salience. Only the rule for which the goal was created is evaluated, and other potential rule evaluations are delayed. While individual rules are evaluated, node sharing is still achieved through the process of segmentation.</p>
</div>
<div class="paragraph">
<p>Unlike the tuple-oriented Rete, the Phreak propagation is collection oriented. For the rule that is being evaluated, the Drools rule engine accesses the first node and processes all queued insert, update, and delete actions. The results are added to a set, and the set is propagated to the child node. In the child node, all queued insert, update, and delete actions are processed, adding the results to the same set. The set is then propagated to the next child node and the same process repeats until it reaches the terminal node. This cycle creates a batch process effect that can provide performance advantages for certain rule constructs.</p>
</div>
<div class="paragraph">
<p>The linking and unlinking of rules happens through a layered bit-mask system, based on network segmentation. When the rule network is built, segments are created for rule network nodes that are shared by the same set of rules. A rule is composed of a path of segments. In case a rule does not share any node with any other rule, it becomes a single segment.</p>
</div>
<div class="paragraph">
<p>A bit-mask offset is assigned to each node in the segment. Another bit mask is assigned to each segment in the path of the rule according to these requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If at least one input for a node exists, the node bit is set to the <code>on</code> state.</p>
</li>
<li>
<p>If each node in a segment has the bit set to the <code>on</code> state, the segment bit is also set to the <code>on</code> state.</p>
</li>
<li>
<p>If any node bit is set to the <code>off</code> state, the segment is also set to the <code>off</code> state.</p>
</li>
<li>
<p>If each segment in the path of the rule is set to the <code>on</code> state, the rule is considered linked, and a goal is created to schedule the rule for evaluation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The same bit-mask technique is used to track modified nodes, segments, and rules. This tracking ability enables an already linked rule to be unscheduled from evaluation if it has been modified since the evaluation goal for it was created. As a result, no rules can ever evaluate partial matches.</p>
</div>
<div class="paragraph">
<p>This process of rule evaluation is possible in Phreak because, as opposed to a single unit of memory in Rete, Phreak has three layers of contextual memory with node, segment, and rule memory types. This layering enables much more contextual understanding during the evaluation of a rule.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/rule-engine/LayeredMemory.png" alt="LayeredMemory">
</div>
<div class="title">Figure 6. Phreak three-layered memory system</div>
</div>
<div class="paragraph">
<p>The following examples illustrate how rules are organized and evaluated in this three-layered memory system in Phreak.</p>
</div>
<div class="paragraph">
<p><strong>Example 1:</strong> A single rule (R1) with three patterns: A, B and C. The rule forms a single segment, with bits 1, 2, and 4 for the nodes. The single segment has a bit offset of 1.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/rule-engine/segment1.png" alt="segment1">
</div>
<div class="title">Figure 7. Example 1: Single rule</div>
</div>
<div class="paragraph">
<p><strong>Example 2:</strong> Rule R2 is added and shares pattern A.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/rule-engine/segment2.png" alt="segment2">
</div>
<div class="title">Figure 8. Example 2: Two rules with pattern sharing</div>
</div>
<div class="paragraph">
<p>Pattern A is placed in its own segment, resulting in two segments for each rule. Those two segments form a path for their respective rules. The first segment is shared by both paths. When pattern A is linked, the segment becomes linked. The segment then iterates over each path that the segment is shared by, setting the bit 1 to <code>on</code>. If patterns B and C are later turned on, the second segment for path R1 is linked, and this causes bit 2 to be turned on for R1. With bit 1 and bit 2 turned on for R1, the rule is now linked and a goal is created to schedule the rule for later evaluation and execution.</p>
</div>
<div class="paragraph">
<p>When a rule is evaluated, the segments enable the results of the matching to be shared. Each segment has a staging memory to queue all inserts, updates, and deletes for that segment. When R1 is evaluated, the rule processes pattern A, and this results in a set of tuples. The algorithm detects a segmentation split, creates peered tuples for each insert, update, and delete in the set, and adds them to the R2 staging memory. Those tuples are then merged with any existing staged tuples and are executed when R2 is eventually evaluated.</p>
</div>
<div class="paragraph">
<p><strong>Example 3:</strong> Rules R3 and R4 are added and share patterns A and B.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/rule-engine/segment3.png" alt="segment3">
</div>
<div class="title">Figure 9. Example 3: Three rules with pattern sharing</div>
</div>
<div class="paragraph">
<p>Rules R3 and R4 have three segments and R1 has two segments. Patterns A and B are shared by R1, R3, and R4, while pattern D is shared by R3 and R4.</p>
</div>
<div class="paragraph">
<p><strong>Example 4:</strong> A single rule (R1) with a subnetwork and no pattern sharing.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/rule-engine/segment4.png" alt="segment4">
</div>
<div class="title">Figure 10. Example 4: Single rule with a subnetwork and no pattern sharing</div>
</div>
<div class="paragraph">
<p>Subnetworks are formed when a <code>Not</code>, <code>Exists</code>, or <code>Accumulate</code> node contains more than one element. In this example, the element <code>B not( C )</code> forms the subnetwork. The element <code>not( C )</code> is a single element that does not require a subnetwork and is therefore merged inside of the <code>Not</code> node. The subnetwork uses a dedicated segment. Rule R1 still has a path of two segments and the subnetwork forms another inner path. When the subnetwork is linked, it is also linked in the outer segment.</p>
</div>
<div class="paragraph">
<p><strong>Example 5:</strong> Rule R1 with a subnetwork that is shared by rule R2.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/rule-engine/segment5.png" alt="segment5">
</div>
<div class="title">Figure 11. Example 5: Two rules, one with a subnetwork and pattern sharing</div>
</div>
<div class="paragraph">
<p>The subnetwork nodes in a rule can be shared by another rule that does not have a subnetwork. This sharing causes the subnetwork segment to be split into two segments.</p>
</div>
<div class="paragraph">
<p>Constrained <code>Not</code> nodes and <code>Accumulate</code> nodes can never unlink a segment, and are always considered to have their bits turned on.</p>
</div>
<div class="paragraph">
<p>The Phreak evaluation algorithm is stack based instead of method-recursion based. Rule evaluation can be paused and resumed at any time when a <code>StackEntry</code> is used to represent the node currently being evaluated.</p>
</div>
<div class="paragraph">
<p>When a rule evaluation reaches a subnetwork, a <code>StackEntry</code> object is created for the outer path segment and the subnetwork segment. The subnetwork segment is evaluated first, and when the set reaches the end of the subnetwork path, the segment is merged into a staging list for the outer node that the segment feeds into. The previous <code>StackEntry</code> object is then resumed and can now process the results of the subnetwork. This process has the added benefit, especially for <code>Accumulate</code> nodes, that all work is completed in a batch, before propagating to the child node.</p>
</div>
<div class="paragraph">
<p>The same stack system is used for efficient backward chaining. When a rule evaluation reaches a query node, the evaluation is paused and the query is added to the stack. The query is then evaluated to produce a result set, which is saved in a memory location for the resumed <code>StackEntry</code> object to pick up and propagate to the child node. If the query itself called other queries, the process repeats, while the current query is paused and a new evaluation is set up for the current query node.</p>
</div>
<div class="sect3">
<h4 id="forward-and-backward-chaining-con_rule-engine"><a class="anchor" href="#forward-and-backward-chaining-con_rule-engine"></a>Rule evaluation with forward and backward chaining</h4>
<div class="paragraph">
<p>The Drools rule engine in Drools is a hybrid reasoning system that uses both forward chaining and backward chaining to evaluate rules. A forward-chaining rule system is a data-driven system that starts with a fact in the working memory of the Drools rule engine and reacts to changes to that fact. When objects are inserted into working memory, any rule conditions that become true as a result of the change are scheduled for execution by the agenda.</p>
</div>
<div class="paragraph">
<p>In contrast, a backward-chaining rule system is a goal-driven system that starts with a conclusion that the Drools rule engine attempts to satisfy, often using recursion. If the system cannot reach the conclusion or goal, it searches for subgoals, which are conclusions that complete part of the current goal. The system continues this process until either the initial conclusion is satisfied or all subgoals are satisfied.</p>
</div>
<div class="paragraph">
<p>The following diagram illustrates how the Drools rule engine evaluates rules using forward chaining overall with a backward-chaining segment in the logic flow:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/rule-engine/RuleEvaluation.png" alt="RuleEvaluation">
</div>
<div class="title">Figure 12. Rule evaluation logic using forward and backward chaining</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="rule-base-configuration-con_rule-engine"><a class="anchor" href="#rule-base-configuration-con_rule-engine"></a>Rule base configuration</h3>
<div class="paragraph">
<p>Drools contains a <code>RuleBaseConfiguration.java</code> object that you can use to configure exception handler settings, multithreaded execution, and sequential mode in the Drools rule engine.</p>
</div>
<div class="paragraph">
<p>For the rule base configuration options,
see the Drools <a href="https://github.com/apache/incubator-kie-drools/blob/10.0.x/drools-core/src/main/java/org/drools/core/RuleBaseConfiguration.java">RuleBaseConfiguration.java</a> page in GitHub.</p>
</div>
<div class="paragraph">
<p>The following rule base configuration options are available for the Drools rule engine:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">drools.consequenceExceptionHandler</dt>
<dd>
<p>When configured, this system property defines the class that manages the exceptions thrown by rule consequences. You can use this property to specify a custom exception handler for rule evaluation in the Drools rule engine.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Default value: <code>org.drools.core.runtime.rule.impl.DefaultConsequenceExceptionHandler</code></p>
</div>
<div class="paragraph">
<p>You can specify the custom exception handler using one of the following options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Specify the exception handler in a system property:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">drools.consequenceExceptionHandler=org.drools.core.runtime.rule.impl.MyCustomConsequenceExceptionHandler</code></pre>
</div>
</div>
</li>
<li>
<p>Specify the exception handler while creating the KIE base programmatically:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">KieServices ks = KieServices.Factory.get();
KieBaseConfiguration kieBaseConf = ks.newKieBaseConfiguration(); kieBaseConf.setOption(ConsequenceExceptionHandlerOption.get(MyCustomConsequenceExceptionHandler.class));
KieBase kieBase = kieContainer.newKieBase(kieBaseConf);</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">drools.parallelExecution</dt>
<dd>
<p>When in use, this system property allows the Drools rule engine to only evaluate or both evaluate and execute rules in parallel by dividing the Phreak rule network into independent partitions. You can use this property to increase the speed of rule evaluation for specific rule bases. This option has 3 possible values:</p>
<div class="ulist">
<ul>
<li>
<p><code>sequential</code> : evaluates and executes all rules sequentially</p>
</li>
<li>
<p><code>parallel_evaluation</code> : evaluates rules in parallel but fires consequence sequentially respecting the semantic imposed by salience and agenda-groups.</p>
</li>
<li>
<p><code>fully_parallel</code> : evaluates and executes everything in parallel</p>
</li>
</ul>
</div>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Default value: <code>sequential</code></p>
</div>
<div class="paragraph">
<p>You can enable parallel evaluation using one of the following options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enable the parallel evaluation system property:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">drools.parallelExecution=fully_parallel</code></pre>
</div>
</div>
</li>
<li>
<p>Enable parallel evaluation while creating the KIE base programmatically:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">KieServices ks = KieServices.Factory.get();
KieBaseConfiguration kieBaseConf = ks.newKieBaseConfiguration();
kieBaseConf.setOption(ParallelExecutionOption.FULLY_PARALLEL);
KieBase kieBase = kieContainer.newKieBase(kieBaseConf);</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In <code>fully_parallel</code> mode rules that use queries, salience, or agenda groups are currently not supported by the parallel Drools rule engine. If these rule elements are present in the KIE base, the compiler emits a warning and automatically switches back to a single-threaded evaluation. However, in some cases, the Drools rule engine might not detect the unsupported rule elements and rules might be evaluated incorrectly. For example, the Drools rule engine might not detect when rules rely on implicit salience given by rule ordering inside the DRL file, resulting in incorrect evaluation due to the unsupported salience attribute.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">drools.sequential</dt>
<dd>
<p>When enabled, this system property enables sequential mode in the Drools rule engine. In sequential mode, the Drools rule engine evaluates rules one time in the order that they are listed in the Drools rule engine agenda without regard to changes in the working memory. This means that the Drools rule engine ignores any <code>insert</code>, <code>modify</code>, or <code>update</code> statements in rules and executes rules in a single sequence. As a result, rule execution may be faster in sequential mode, but important updates may not be applied to your rules. You can use this property if you use stateless KIE sessions and you do not want the execution of rules to influence subsequent rules in the agenda. Sequential mode applies to stateless KIE sessions only.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Default value: <code>false</code></p>
</div>
<div class="paragraph">
<p>You can enable sequential mode using one of the following options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enable the sequential mode system property:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">drools.sequential=true</code></pre>
</div>
</div>
</li>
<li>
<p>Enable sequential mode while creating the KIE base programmatically:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">KieServices ks = KieServices.Factory.get();
KieBaseConfiguration kieBaseConf = ks.newKieBaseConfiguration();
kieBaseConf.setOption(SequentialOption.YES);
KieBase kieBase = kieContainer.newKieBase(kieBaseConf);</code></pre>
</div>
</div>
</li>
<li>
<p>Enable sequential mode in the KIE module descriptor file (<code>kmodule.xml</code>) for a specific Drools project:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;kmodule&gt;
  ...
  &lt;kbase name="KBase2" default="false" sequential="true" packages="org.domain.pkg2, org.domain.pkg3" includes="KBase1"&gt;
    ...
  &lt;/kbase&gt;
  ...
&lt;/kmodule&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="phreak-sequential-mode-con_rule-engine"><a class="anchor" href="#phreak-sequential-mode-con_rule-engine"></a>Sequential mode in Phreak</h3>
<div class="paragraph">
<p>Sequential mode is an advanced rule base configuration in the Drools rule engine, supported by Phreak, that enables the Drools rule engine to evaluate rules one time in the order that they are listed in the Drools rule engine agenda without regard to changes in the working memory. In sequential mode, the Drools rule engine ignores any <code>insert</code>, <code>modify</code>, or <code>update</code> statements in rules and executes rules in a single sequence. As a result, rule execution may be faster in sequential mode, but important updates may not be applied to your rules.</p>
</div>
<div class="paragraph">
<p>Sequential mode applies to only stateless KIE sessions because stateful KIE sessions inherently use data from previously invoked KIE sessions. If you use a stateless KIE session and you want the execution of rules to influence subsequent rules in the agenda, then do not enable sequential mode. Sequential mode is disabled by default in the Drools rule engine.</p>
</div>
<div class="paragraph">
<p>To enable sequential mode, use one of the following options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set the system property <code>drools.sequential</code> to <code>true</code>.</p>
</li>
<li>
<p>Enable sequential mode while creating the KIE base programmatically:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">KieServices ks = KieServices.Factory.get();
KieBaseConfiguration kieBaseConf = ks.newKieBaseConfiguration();
kieBaseConf.setOption(SequentialOption.YES);
KieBase kieBase = kieContainer.newKieBase(kieBaseConf);</code></pre>
</div>
</div>
</li>
<li>
<p>Enable sequential mode in the KIE module descriptor file (<code>kmodule.xml</code>) for a specific Drools project:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;kmodule&gt;
  ...
  &lt;kbase name="KBase2" default="false" sequential="true" packages="org.domain.pkg2, org.domain.pkg3" includes="KBase1"&gt;
    ...
  &lt;/kbase&gt;
  ...
&lt;/kmodule&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>To configure sequential mode to use a dynamic agenda, use one of the following options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set the system property <code>drools.sequential.agenda</code> to <code>dynamic</code>.</p>
</li>
<li>
<p>Set the sequential agenda option while creating the KIE base programmatically:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">KieServices ks = KieServices.Factory.get();
KieBaseConfiguration kieBaseConf = ks.newKieBaseConfiguration();
kieBaseConf.setOption(SequentialAgendaOption.DYNAMIC);
KieBase kieBase = kieContainer.newKieBase(kieBaseConf);</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>When you enable sequential mode, the Drools rule engine evaluates rules in the following way:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Rules are ordered by salience and position in the rule set.</p>
</li>
<li>
<p>An element for each possible rule match is created. The element position indicates the execution order.</p>
</li>
<li>
<p>Node memory is disabled, with the exception of the right-input object memory.</p>
</li>
<li>
<p>The left-input adapter node propagation is disconnected and the object with the node is referenced in a <code>Command</code> object. The <code>Command</code> object is added to a list in the working memory for later execution.</p>
</li>
<li>
<p>All objects are asserted, and then the list of <code>Command</code> objects is checked and executed.</p>
</li>
<li>
<p>All matches that result from executing the list are added to elements based on the sequence number of the rule.</p>
</li>
<li>
<p>The elements that contain matches are executed in a sequence. If you set a maximum number of rule executions, the Drools rule engine activates no more than that number of rules in the agenda for execution.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In sequential mode, the <code>LeftInputAdapterNode</code> node creates a <code>Command</code> object and adds it to a list in the working memory of the Drools rule engine. This <code>Command</code> object contains references to the <code>LeftInputAdapterNode</code> node and the propagated object. These references stop any left-input propagations at insertion time so that the right-input propagation never needs to attempt to join the left inputs. The references also avoid the need for the left-input memory.</p>
</div>
<div class="paragraph">
<p>All nodes have their memory turned off, including the left-input tuple memory, but excluding the right-input object memory. After all the assertions are finished and the right-input memory of all the objects is populated, the Drools rule engine iterates over the list of <code>LeftInputAdatperNode</code> <code>Command</code> objects. The objects propagate down the network, attempting to join the right-input objects, but they are not retained in the left input.</p>
</div>
<div class="paragraph">
<p>The agenda with a priority queue to schedule the tuples is replaced by an element for each rule. The sequence number of the <code>RuleTerminalNode</code> node indicates the element where to place the match. After all <code>Command</code> objects have finished, the elements are checked and existing matches are executed. To improve performance, the first and the last populated cell in the elements are retained.</p>
</div>
<div class="paragraph">
<p>When the network is constructed, each <code>RuleTerminalNode</code> node receives a sequence number based on its salience number and the order in which it was added to the network.</p>
</div>
<div class="paragraph">
<p>The right-input node memories are typically hash maps for fast object deletion. Because object deletions are not supported, Phreak uses an object list when the values of the object are not indexed. For a large number of objects, indexed hash maps provide a performance increase. If an object has only a few instances, Phreak uses an object list instead of an index.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cep-con_rule-engine"><a class="anchor" href="#cep-con_rule-engine"></a>Complex event processing (CEP)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In Drools, an event is a record of a significant change of state in the application domain at a point in time. Depending on how the domain is modeled, the change of state may be represented by a single event, multiple atomic events, or hierarchies of correlated events. From a complex event processing (CEP) perspective, an event is a type of fact or object that occurs at a specific point in time, and a business rule is a definition of how to react to the data from that fact or object. For example, in a stock broker application, a change in security prices, a change in ownership from seller to buyer, or a change in an account holder&#8217;s balance are all considered to be events because a change has occurred in the state of the application domain at a given time.</p>
</div>
<div class="paragraph">
<p>The Drools rule engine in Drools uses complex event processing (CEP) to detect and process multiple events within a collection of events, to uncover relationships that exist between events, and to infer new data from the events and their relationships.</p>
</div>
<div class="paragraph">
<p>CEP use cases share several requirements and goals with business rule use cases.</p>
</div>
<div class="paragraph">
<p>From a business perspective, business rule definitions are often defined based on the occurrence of scenarios triggered by events. In the following examples, events form the basis of business rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In an algorithmic trading application, a rule performs an action if the security price increases by X percent above the day opening price. The price increases are denoted by events on a stock trading application.</p>
</li>
<li>
<p>In a monitoring application, a rule performs an action if the temperature in the server room increases X degrees in Y minutes. The sensor readings are denoted by events.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>From a technical perspective, business rule evaluation and CEP have the following key similarities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Both business rule evaluation and CEP require seamless integration with the enterprise infrastructure and applications. This is particularly important with life-cycle management, auditing, and security.</p>
</li>
<li>
<p>Both business rule evaluation and CEP have functional requirements such as pattern matching, and non-functional requirements such as response time limits and query-rule explanations.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>CEP scenarios have the following key characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Scenarios usually process large numbers of events, but only a small percentage of the events are relevant.</p>
</li>
<li>
<p>Events are usually immutable and represent a record of change in state.</p>
</li>
<li>
<p>Rules and queries run against events and must react to detected event patterns.</p>
</li>
<li>
<p>Related events usually have a strong temporal relationship.</p>
</li>
<li>
<p>Individual events are not prioritized. The CEP system prioritizes patterns of related events and the relationships between them.</p>
</li>
<li>
<p>Events usually need to be composed and aggregated.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Given these common CEP scenario characteristics, the CEP system in Drools supports the following features and functions to optimize event processing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Event processing with proper semantics</p>
</li>
<li>
<p>Event detection, correlation, aggregation, and composition</p>
</li>
<li>
<p>Event stream processing</p>
</li>
<li>
<p>Temporal constraints to model the temporal relationships between events</p>
</li>
<li>
<p>Sliding windows of significant events</p>
</li>
<li>
<p>Session-scoped unified clock</p>
</li>
<li>
<p>Required volumes of events for CEP use cases</p>
</li>
<li>
<p>Reactive rules</p>
</li>
<li>
<p>Adapters for event input into the Drools rule engine (pipeline)</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="cep-events-con_rule-engine"><a class="anchor" href="#cep-events-con_rule-engine"></a>Events in complex event processing</h3>
<div class="paragraph">
<p>In Drools, an event is a record of a significant change of state in the application domain at a point in time. Depending on how the domain is modeled, the change of state may be represented by a single event, multiple atomic events, or hierarchies of correlated events. From a complex event processing (CEP) perspective, an event is a type of fact or object that occurs at a specific point in time, and a business rule is a definition of how to react to the data from that fact or object. For example, in a stock broker application, a change in security prices, a change in ownership from seller to buyer, or a change in an account holder&#8217;s balance are all considered to be events because a change has occurred in the state of the application domain at a given time.</p>
</div>
<div class="paragraph">
<p>Events have the following key characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Are immutable:</strong> An event is a record of change that has occurred at some time in the past and cannot be changed.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The Drools rule engine does not enforce immutability on the Java objects that represent events. This behavior makes event data enrichment possible. Your application should be able to populate unpopulated event attributes, and these attributes are used by the Drools rule engine to enrich the event with inferred data. However, you should not change event attributes that have already been populated.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p><strong>Have strong temporal constraints:</strong> Rules involving events usually require the correlation of multiple events that occur at different points in time relative to each other.</p>
</li>
<li>
<p><strong>Have managed life cycles:</strong> Because events are immutable and have temporal constraints, they are usually only relevant for a specified period of time. This means that the Drools rule engine can automatically manage the life cycle of events.</p>
</li>
<li>
<p><strong>Can use sliding windows:</strong> You can define sliding windows of time or length with events. A sliding time window is a specified period of time during which events can be processed. A sliding length window is a specified number of events that can be processed.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="cep-events-proc_rule-engine"><a class="anchor" href="#cep-events-proc_rule-engine"></a>Declaring facts as events</h3>
<div class="paragraph">
<p>You can declare facts as events in your Java class or DRL rule file so that the Drools rule engine handles the facts as events during complex event processing. You can declare the facts as interval-based events or point-in-time events. Interval-based events have a duration time and persist in the working memory of the Drools rule engine until their duration time has lapsed. Point-in-time events have no duration and are essentially interval-based events with a duration of zero.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>For the relevant fact type in your Java class or DRL rule file, enter the <code>@role( event )</code> metadata tag and parameter. The <code>@role</code> metadata tag accepts the following two values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>fact</code>: (Default) Declares the type as a regular fact</p>
</li>
<li>
<p><code>event</code>: Declares the type as an event</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, the following snippet declares that the <code>StockPoint</code> fact type in a stock broker application must be handled as an event:</p>
</div>
<div class="listingblock">
<div class="title">Declare fact type as an event</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">import some.package.StockPoint

declare StockPoint
  @role( event )
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>StockPoint</code> is a fact type declared in the DRL rule file instead of in a pre-existing class, you can declare the event in-line in your application code:</p>
</div>
<div class="listingblock">
<div class="title">Declare fact type in-line and assign it to event role</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">declare StockPoint
  @role( event )

  datetime : java.util.Date
  symbol : String
  price : double
end</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cep-modes-con_rule-engine"><a class="anchor" href="#cep-modes-con_rule-engine"></a>Event processing modes in the Drools rule engine</h3>
<div class="paragraph">
<p>The Drools rule engine runs in either cloud mode or stream mode. In cloud mode, the Drools rule engine processes facts as facts with no temporal constraints, independent of time, and in no particular order. In stream mode, the Drools rule engine processes facts as events with strong temporal constraints, in real time or near real time. Stream mode uses synchronization to make event processing possible in Drools.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Cloud mode</dt>
<dd>
<p>Cloud mode is the default operating mode of the Drools rule engine. In cloud mode, the Drools rule engine treats events as an unordered cloud. Events still have time stamps, but the Drools rule engine running in cloud mode cannot draw relevance from the time stamp because cloud mode ignores the present time. This mode uses the rule constraints to find the matching tuples to activate and execute rules.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Cloud mode does not impose any kind of additional requirements on facts. However, because the Drools rule engine in this mode has no concept of time, it cannot use temporal features such as sliding windows or automatic life-cycle management. In cloud mode, events must be explicitly retracted when they are no longer needed.</p>
</div>
<div class="paragraph">
<p>The following requirements are not imposed in cloud mode:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>No clock synchronization because the Drools rule engine has no notion of time</p>
</li>
<li>
<p>No ordering of events because the Drools rule engine processes events as an unordered cloud, against which the Drools rule engine match rules</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can specify cloud mode either by setting the system property in the relevant configuration files or by using the Java client API:</p>
</div>
<div class="listingblock">
<div class="title">Set cloud mode using system property</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">drools.eventProcessingMode=cloud</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Set cloud mode using Java client API</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.kie.api.conf.EventProcessingOption;
import org.kie.api.KieBaseConfiguration;
import org.kie.api.KieServices.Factory;

KieBaseConfiguration config = KieServices.Factory.get().newKieBaseConfiguration();

config.setOption(EventProcessingOption.CLOUD);</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also specify cloud mode using the <code>eventProcessingMode="&lt;mode&gt;"</code> KIE base attribute in the KIE module descriptor file (<code>kmodule.xml</code>) for a specific Drools project:</p>
</div>
<div class="listingblock">
<div class="title">Set cloud mode using project <code>kmodule.xml</code> file</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;kmodule&gt;
  ...
  &lt;kbase name="KBase2" default="false" eventProcessingMode="cloud" packages="org.domain.pkg2, org.domain.pkg3" includes="KBase1"&gt;
    ...
  &lt;/kbase&gt;
  ...
&lt;/kmodule&gt;</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">Stream mode</dt>
<dd>
<p>Stream mode enables the Drools rule engine to process events chronologically and in real time as they are inserted into the Drools rule engine. In stream mode, the Drools rule engine synchronizes streams of events (so that events in different streams can be processed in chronological order), implements sliding windows of time or length, and enables automatic life-cycle management.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>The following requirements apply to stream mode:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Events in each stream must be ordered chronologically.</p>
</li>
<li>
<p>A session clock must be present to synchronize event streams.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Your application does not need to enforce ordering events between streams, but using event streams that have not been synchronized may cause unexpected results.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can specify stream mode either by setting the system property in the relevant configuration files or by using the Java client API:</p>
</div>
<div class="listingblock">
<div class="title">Set stream mode using system property</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">drools.eventProcessingMode=stream</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Set stream mode using Java client API</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.kie.api.conf.EventProcessingOption;
import org.kie.api.KieBaseConfiguration;
import org.kie.api.KieServices.Factory;

KieBaseConfiguration config = KieServices.Factory.get().newKieBaseConfiguration();

config.setOption(EventProcessingOption.STREAM);</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also specify stream mode using the <code>eventProcessingMode="&lt;mode&gt;"</code> KIE base attribute in the KIE module descriptor file (<code>kmodule.xml</code>) for a specific Drools project:</p>
</div>
<div class="listingblock">
<div class="title">Set stream mode using project <code>kmodule.xml</code> file</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;kmodule&gt;
  ...
  &lt;kbase name="KBase2" default="false" eventProcessingMode="stream" packages="org.domain.pkg2, org.domain.pkg3" includes="KBase1"&gt;
    ...
  &lt;/kbase&gt;
  ...
&lt;/kmodule&gt;</code></pre>
</div>
</div>
</div>
</div>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="cep-negative-patterns_rule-engine"><a class="anchor" href="#cep-negative-patterns_rule-engine"></a>Negative patterns in Drools rule engine stream mode</h4>
<div class="paragraph">
<p>A negative pattern is a pattern for conditions that are not met. For example, the following DRL rule activates a fire alarm if a fire is detected and the sprinkler is not activated:</p>
</div>
<div class="listingblock">
<div class="title">Fire alarm rule with a negative pattern</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Sound the alarm"
when
  $f : FireDetected()
  not(SprinklerActivated())
then
  // Sound the alarm.
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>In cloud mode, the Drools rule engine assumes all facts (regular facts and events) are known in advance and evaluates negative patterns immediately. In stream mode, the Drools rule engine can support temporal constraints on facts to wait for a set time before activating a rule.</p>
</div>
<div class="paragraph">
<p>The same example rule in stream mode activates the fire alarm as usual, but applies a 10-second delay.</p>
</div>
<div class="listingblock">
<div class="title">Fire alarm rule with a negative pattern and time delay (stream mode only)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Sound the alarm"
when
  $f : FireDetected()
  not(SprinklerActivated(this after[0s,10s] $f))
then
  // Sound the alarm.
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following modified fire alarm rule expects one <code>Heartbeat</code> event to occur every 10 seconds. If the expected event does not occur, the rule is executed. This rule uses the same type of object in both the first pattern and in the negative pattern. The negative pattern has the temporal constraint to wait 0 to 10 seconds before executing and excludes the <code>Heartbeat</code> event bound to <code>$h</code> so that the rule can be executed. The bound event <code>$h</code> must be explicitly excluded in order for the rule to be executed because the temporal constraint <code>[0s, &#8230;&#8203;]</code> does not inherently exclude that event from being matched again.</p>
</div>
<div class="listingblock">
<div class="title">Fire alarm rule excluding a bound event in a negative pattern (stream mode only)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Sound the alarm"
when
  $h: Heartbeat() from entry-point "MonitoringStream"
  not(Heartbeat(this != $h, this after[0s,10s] $h) from entry-point "MonitoringStream")
then
  // Sound the alarm.
end</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="property-change-listeners-con_rule-engine"><a class="anchor" href="#property-change-listeners-con_rule-engine"></a>Property-change settings and listeners for fact types</h3>
<div class="paragraph">
<p>By default, the Drools rule engine does not re-evaluate all fact patterns for fact types each time a rule is triggered, but instead reacts only to modified properties that are constrained or bound inside a given pattern. For example, if a rule calls <code>modify()</code> as part of the rule actions but the action does not generate new data in the KIE base, the Drools rule engine does not automatically re-evaluate all fact patterns because no data was modified. This property reactivity behavior prevents unwanted recursions in the KIE base and results in more efficient rule evaluation. This behavior also means that you do not always need to use the <code>no-loop</code> rule attribute to avoid infinite recursion.</p>
</div>
<div class="paragraph">
<p>You can modify or disable this property reactivity behavior with the following <code>KnowledgeBuilderConfiguration</code> options, and then use a property-change setting in your Java class or DRL files to fine-tune property reactivity as needed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ALWAYS</code>: (Default) All types are property reactive, but you can disable property reactivity for a specific type by using the <code>@classReactive</code> property-change setting.</p>
</li>
<li>
<p><code>ALLOWED</code>: No types are property reactive, but you can enable property reactivity for a specific type by using the <code>@propertyReactive</code> property-change setting.</p>
</li>
<li>
<p><code>DISABLED</code>: No types are property reactive. All property-change listeners are ignored.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example property reactivity setting in KnowledgeBuilderConfiguration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">KnowledgeBuilderConfiguration config = KnowledgeBuilderFactory.newKnowledgeBuilderConfiguration();
config.setOption(PropertySpecificOption.ALLOWED);
KnowledgeBuilder kbuilder = KnowledgeBuilderFactory.newKnowledgeBuilder(config);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can update the <code>drools.propertySpecific</code> system property in the <code>standalone.xml</code> file of your Drools distribution:</p>
</div>
<div class="listingblock">
<div class="title">Example property reactivity setting in system properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;system-properties&gt;
  ...
  &lt;property name="drools.propertySpecific" value="ALLOWED"/&gt;
  ...
&lt;/system-properties&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Drools rule engine supports the following property-change settings and listeners for fact classes or declared DRL fact types:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">@classReactive</dt>
<dd>
<p>If property reactivity is set to <code>ALWAYS</code> in the Drools rule engine (all types are property reactive), this tag disables the default property reactivity behavior for a specific Java class or a declared DRL fact type. You can use this tag if you want the Drools rule engine to re-evaluate all fact patterns for the specified fact type each time the rule is triggered, instead of reacting only to modified properties that are constrained or bound inside a given pattern.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example: Disable default property reactivity in a DRL type declaration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">declare Person
  @classReactive
    firstName : String
    lastName : String
end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example: Disable default property reactivity in a Java class</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@classReactive
public static class Person {
    private String firstName;
    private String lastName;
}</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">@propertyReactive</dt>
<dd>
<p>If property reactivity is set to <code>ALLOWED</code> in the Drools rule engine (no types are property reactive unless specified), this tag enables property reactivity for a specific Java class or a declared DRL fact type. You can use this tag if you want the Drools rule engine to react only to modified properties that are constrained or bound inside a given pattern for the specified fact type, instead of re-evaluating all fact patterns for the fact each time the rule is triggered.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example: Enable property reactivity in a DRL type declaration (when reactivity is disabled globally)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">declare Person
  @propertyReactive
    firstName : String
    lastName : String
end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example: Enable property reactivity in a Java class (when reactivity is disabled globally)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@propertyReactive
public static class Person {
    private String firstName;
    private String lastName;
}</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">@watch</dt>
<dd>
<p>This tag enables property reactivity for additional properties that you specify in-line in fact patterns in DRL rules. This tag is supported only if property reactivity is set to <code>ALWAYS</code> in the Drools rule engine, or if property reactivity is set to <code>ALLOWED</code> and the relevant fact type uses the <code>@propertyReactive</code> tag. You can use this tag in DRL rules to add or exclude specific properties in fact property reactivity logic.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Default parameter: None</p>
</div>
<div class="paragraph">
<p>Supported parameters: Property name, <code>*</code> (all), <code>!</code> (not), <code>!*</code> (no properties)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">&lt;factPattern&gt; @watch ( &lt;property&gt; )</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example: Enable or disable property reactivity in fact patterns</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">// Listens for changes in both `firstName` (inferred) and `lastName`:
Person(firstName == $expectedFirstName) @watch( lastName )

// Listens for changes in all properties of the `Person` fact:
Person(firstName == $expectedFirstName) @watch( * )

// Listens for changes in `lastName` and explicitly excludes changes in `firstName`:
Person(firstName == $expectedFirstName) @watch( lastName, !firstName )

// Listens for changes in all properties of the `Person` fact except `age`:
Person(firstName == $expectedFirstName) @watch( *, !age )

// Excludes changes in all properties of the `Person` fact (equivalent to using `@classReactivity` tag):
Person(firstName == $expectedFirstName) @watch( !* )</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Drools rule engine generates a compilation error if you use the <code>@watch</code> tag for properties in a fact type that uses the <code>@classReactive</code> tag (disables property reactivity) or when property reactivity is set to <code>ALLOWED</code> in the Drools rule engine and the relevant fact type does not use the <code>@propertyReactive</code> tag. Compilation errors also arise if you duplicate properties in listener annotations, such as <code>@watch( firstName, ! firstName )</code>.</p>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">@propertyChangeSupport</dt>
<dd>
<p>For facts that implement support for property changes as defined in the <a href="https://download.oracle.com/otndocs/jcp/7224-javabeans-1.01-fr-spec-oth-JSpec/">JavaBeans Specification</a>, this tag enables the Drools rule engine to monitor changes in the fact properties.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example: Declare property change support in JavaBeans object</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">declare Person
    @propertyChangeSupport
end</code></pre>
</div>
</div>
</div>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="cep-temporal-operators_rule-engine"><a class="anchor" href="#cep-temporal-operators_rule-engine"></a>Temporal operators for events</h3>
<div class="paragraph">
<p>In stream mode, the Drools rule engine supports the following temporal operators for events that are inserted into the working memory of the Drools rule engine. You can use these operators to define the temporal reasoning behavior of the events that you declare in your Java class or DRL rule file. Temporal operators are not supported when the Drools rule engine is running in cloud mode.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>after</code></p>
</li>
<li>
<p><code>before</code></p>
</li>
<li>
<p><code>coincides</code></p>
</li>
<li>
<p><code>during</code></p>
</li>
<li>
<p><code>includes</code></p>
</li>
<li>
<p><code>finishes</code></p>
</li>
<li>
<p><code>finished by</code></p>
</li>
<li>
<p><code>meets</code></p>
</li>
<li>
<p><code>met by</code></p>
</li>
<li>
<p><code>overlaps</code></p>
</li>
<li>
<p><code>overlapped by</code></p>
</li>
<li>
<p><code>starts</code></p>
</li>
<li>
<p><code>started by</code></p>
<div class="dlist">
<dl>
<dt class="hdlist1">after</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>This operator specifies if the current event occurs after the correlated event. This operator can also define an amount of time after which the current event can follow the correlated event, or a delimiting time range during which the current event can follow the correlated event.</p>
</div>
<div class="paragraph">
<p>For example, the following pattern matches if <code>$eventA</code> starts between 3 minutes and 30 seconds and 4 minutes after <code>$eventB</code> finishes. If <code>$eventA</code> starts earlier than 3 minutes and 30 seconds after <code>$eventB</code> finishes, or later than 4 minutes after <code>$eventB</code> finishes, then the pattern is not matched.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA(this after[3m30s, 4m] $eventB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also express this operator in the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">3m30s &lt;= $eventA.startTimestamp - $eventB.endTimeStamp &lt;= 4m</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>after</code> operator supports up to two parameter values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If two values are defined, the interval starts on the first value (3 minutes and 30 seconds in the example) and ends on the second value (4 minutes in the example).</p>
</li>
<li>
<p>If only one value is defined, the interval starts on the provided value and runs indefinitely with no end time.</p>
</li>
<li>
<p>If no value is defined, the interval starts at 1 millisecond and runs indefinitely with no end time.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>after</code> operator also supports negative time ranges:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA(this after[-3m30s, -2m] $eventB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the first value is greater than the second value, the Drools rule engine automatically reverses them. For example, the following two patterns are interpreted by the Drools rule engine in the same way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA(this after[-3m30s, -2m] $eventB)
$eventA : EventA(this after[-2m, -3m30s] $eventB)</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">before</dt>
<dd>
<p>This operator specifies if the current event occurs before the correlated event. This operator can also define an amount of time before which the current event can precede the correlated event, or a delimiting time range during which the current event can precede the correlated event.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>For example, the following pattern matches if <code>$eventA</code> finishes between 3 minutes and 30 seconds and 4 minutes before <code>$eventB</code> starts. If <code>$eventA</code> finishes earlier than 3 minutes and 30 seconds before <code>$eventB</code> starts, or later than 4 minutes before <code>$eventB</code> starts, then the pattern is not matched.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA(this before[3m30s, 4m] $eventB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also express this operator in the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">3m30s &lt;= $eventB.startTimestamp - $eventA.endTimeStamp &lt;= 4m</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>before</code> operator supports up to two parameter values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If two values are defined, the interval starts on the first value (3 minutes and 30 seconds in the example) and ends on the second value (4 minutes in the example).</p>
</li>
<li>
<p>If only one value is defined, the interval starts on the provided value and runs indefinitely with no end time.</p>
</li>
<li>
<p>If no value is defined, the interval starts at 1 millisecond and runs indefinitely with no end time.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>before</code> operator also supports negative time ranges:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA(this before[-3m30s, -2m] $eventB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the first value is greater than the second value, the Drools rule engine automatically reverses them. For example, the following two patterns are interpreted by the Drools rule engine in the same way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA(this before[-3m30s, -2m] $eventB)
$eventA : EventA(this before[-2m, -3m30s] $eventB)</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">coincides</dt>
<dd>
<p>This operator specifies if the two events occur at the same time, with the same start and end times.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>For example, the following pattern matches if both the start and end time stamps of <code>$eventA</code> and <code>$eventB</code> are identical:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA(this coincides $eventB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>coincides</code> operator supports up to two parameter values for the distance between the event start and end times, if they are not identical:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If only one parameter is given, the parameter is used to set the threshold for both the start and end times of both events.</p>
</li>
<li>
<p>If two parameters are given, the first is used as a threshold for the start time and the second is used as a threshold for the end time.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following pattern uses start and end time thresholds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA(this coincides[15s, 10s] $eventB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The pattern matches if the following conditions are met:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">abs($eventA.startTimestamp - $eventB.startTimestamp) &lt;= 15s
&amp;&amp;
abs($eventA.endTimestamp - $eventB.endTimestamp) &lt;= 10s</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The Drools rule engine does not support negative intervals for the <code>coincides</code> operator. If you use negative intervals, the Drools rule engine generates an error.
</td>
</tr>
</table>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">during</dt>
<dd>
<p>This operator specifies if the current event occurs within the time frame of when the correlated event starts and ends. The current event must start after the correlated event starts and must end before the correlated event ends. (With the <code>coincides</code> operator, the start and end times are the same or nearly the same.)</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>For example, the following pattern matches if <code>$eventA</code> starts after <code>$eventB</code> starts and ends before <code>$eventB</code> ends:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA(this during $eventB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also express this operator in the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventB.startTimestamp &lt; $eventA.startTimestamp &lt;= $eventA.endTimestamp &lt; $eventB.endTimestamp</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>during</code> operator supports one, two, or four optional parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If one value is defined, this value is the maximum distance between the start times of the two events and the maximum distance between the end times of the two events.</p>
</li>
<li>
<p>If two values are defined, these values are a threshold between which the current event start time and end time must occur in relation to the correlated event start and end times.</p>
<div class="paragraph">
<p>For example, if the values are <code>5s</code> and <code>10s</code>, the current event must start between 5 and 10 seconds after the correlated event starts and must end between 5 and 10 seconds before the correlated event ends.</p>
</div>
</li>
<li>
<p>If four values are defined, the first and second values are the minimum and maximum distances between the start times of the events, and the third and fourth values are the minimum and maximum distances between the end times of the two events.</p>
</li>
</ul>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">includes</dt>
<dd>
<p>This operator specifies if the correlated event occurs within the time frame of when the current event occurs. The correlated event must start after the current event starts and must end before the current event ends. (The behavior of this operator is the reverse of the <code>during</code> operator behavior.)</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>For example, the following pattern matches if <code>$eventB</code> starts after <code>$eventA</code> starts and ends before <code>$eventA</code> ends:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA(this includes $eventB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also express this operator in the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA.startTimestamp &lt; $eventB.startTimestamp &lt;= $eventB.endTimestamp &lt; $eventA.endTimestamp</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>includes</code> operator supports one, two, or four optional parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If one value is defined, this value is the maximum distance between the start times of the two events and the maximum distance between the end times of the two events.</p>
</li>
<li>
<p>If two values are defined, these values are a threshold between which the correlated event start time and end time must occur in relation to the current event start and end times.</p>
<div class="paragraph">
<p>For example, if the values are <code>5s</code> and <code>10s</code>, the correlated event must start between 5 and 10 seconds after the current event starts and must end between 5 and 10 seconds before the current event ends.</p>
</div>
</li>
<li>
<p>If four values are defined, the first and second values are the minimum and maximum distances between the start times of the events, and the third and fourth values are the minimum and maximum distances between the end times of the two events.</p>
</li>
</ul>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">finishes</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>This operator specifies if the current event starts after the correlated event but both events end at the same time.</p>
</div>
<div class="paragraph">
<p>For example, the following pattern matches if <code>$eventA</code> starts after <code>$eventB</code> starts and ends at the same time when <code>$eventB</code> ends:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA(this finishes $eventB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also express this operator in the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventB.startTimestamp &lt; $eventA.startTimestamp
&amp;&amp;
$eventA.endTimestamp == $eventB.endTimestamp</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>finishes</code> operator supports one optional parameter that sets the maximum time allowed between the end times of the two events:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA(this finishes[5s] $eventB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This pattern matches if these conditions are met:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventB.startTimestamp &lt; $eventA.startTimestamp
&amp;&amp;
abs($eventA.endTimestamp - $eventB.endTimestamp) &lt;= 5s</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The Drools rule engine does not support negative intervals for the <code>finishes</code> operator. If you use negative intervals, the Drools rule engine generates an error.
</td>
</tr>
</table>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">finished by</dt>
<dd>
<p>This operator specifies if the correlated event starts after the current event but both events end at the same time. (The behavior of this operator is the reverse of the <code>finishes</code> operator behavior.)</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>For example, the following pattern matches if <code>$eventB</code> starts after <code>$eventA</code> starts and ends at the same time when <code>$eventA</code> ends:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA(this finishedby $eventB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also express this operator in the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA.startTimestamp &lt; $eventB.startTimestamp
&amp;&amp;
$eventA.endTimestamp == $eventB.endTimestamp</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>finished by</code> operator supports one optional parameter that sets the maximum time allowed between the end times of the two events:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA(this finishedby[5s] $eventB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This pattern matches if these conditions are met:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA.startTimestamp &lt; $eventB.startTimestamp
&amp;&amp;
abs($eventA.endTimestamp - $eventB.endTimestamp) &lt;= 5s</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The Drools rule engine does not support negative intervals for the <code>finished by</code> operator. If you use negative intervals, the Drools rule engine generates an error.
</td>
</tr>
</table>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">meets</dt>
<dd>
<p>This operator specifies if the current event ends at the same time when the correlated event starts.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>For example, the following pattern matches if <code>$eventA</code> ends at the same time when <code>$eventB</code> starts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA(this meets $eventB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also express this operator in the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">abs($eventB.startTimestamp - $eventA.endTimestamp) == 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>meets</code> operator supports one optional parameter that sets the maximum time allowed between the end time of the current event and the start time of the correlated event:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA(this meets[5s] $eventB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This pattern matches if these conditions are met:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">abs($eventB.startTimestamp - $eventA.endTimestamp) &lt;= 5s</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The Drools rule engine does not support negative intervals for the <code>meets</code> operator. If you use negative intervals, the Drools rule engine generates an error.
</td>
</tr>
</table>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">met by</dt>
<dd>
<p>This operator specifies if the correlated event ends at the same time when the current event starts. (The behavior of this operator is the reverse of the <code>meets</code> operator behavior.)</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>For example, the following pattern matches if <code>$eventB</code> ends at the same time when <code>$eventA</code> starts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA(this metby $eventB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also express this operator in the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">abs($eventA.startTimestamp - $eventB.endTimestamp) == 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>met by</code> operator supports one optional parameter that sets the maximum distance between the end time of the correlated event and the start time of the current event:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA(this metby[5s] $eventB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This pattern matches if these conditions are met:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">abs($eventA.startTimestamp - $eventB.endTimestamp) &lt;= 5s</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The Drools rule engine does not support negative intervals for the <code>met by</code> operator. If you use negative intervals, the Drools rule engine generates an error.
</td>
</tr>
</table>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">overlaps</dt>
<dd>
<p>This operator specifies if the current event starts before the correlated event starts and it ends during the time frame that the correlated event occurs. The current event must end between the start and end times of the correlated event.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>For example, the following pattern matches if <code>$eventA</code> starts before <code>$eventB</code> starts and then ends while <code>$eventB</code> occurs, before <code>$eventB</code> ends:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA(this overlaps $eventB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>overlaps</code> operator supports up to two parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If one parameter is defined, the value is the maximum distance between the start time of the correlated event and the end time of the current event.</p>
</li>
<li>
<p>If two parameters are defined, the values are the minimum distance (first value) and the maximum distance (second value) between the start time of the correlated event and the end time of the current event.</p>
</li>
</ul>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">overlapped by</dt>
<dd>
<p>This operator specifies if the correlated event starts before the current event starts and it ends during the time frame that the current event occurs. The correlated event must end between the start and end times of the current event. (The behavior of this operator is the reverse of the <code>overlaps</code> operator behavior.)</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>For example, the following pattern matches if <code>$eventB</code> starts before <code>$eventA</code> starts and then ends while <code>$eventA</code> occurs, before <code>$eventA</code> ends:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA(this overlappedby $eventB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>overlapped by</code> operator supports up to two parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If one parameter is defined, the value is the maximum distance between the start time of the current event and the end time of the correlated event.</p>
</li>
<li>
<p>If two parameters are defined, the values are the minimum distance (first value) and the maximum distance (second value) between the start time of the current event and the end time of the correlated event.</p>
</li>
</ul>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">starts</dt>
<dd>
<p>This operator specifies if the two events start at the same time but the current event ends before the correlated event ends.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>For example, the following pattern matches if <code>$eventA</code> and <code>$eventB</code> start at the same time, and <code>$eventA</code> ends before <code>$eventB</code> ends:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA(this starts $eventB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also express this operator in the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA.startTimestamp == $eventB.startTimestamp
&amp;&amp;
$eventA.endTimestamp &lt; $eventB.endTimestamp</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>starts</code> operator supports one optional parameter that sets the maximum distance between the start times of the two events:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA(this starts[5s] $eventB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This pattern matches if these conditions are met:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">abs($eventA.startTimestamp - $eventB.startTimestamp) &lt;= 5s
&amp;&amp;
$eventA.endTimestamp &lt; $eventB.endTimestamp</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The Drools rule engine does not support negative intervals for the <code>starts</code> operator. If you use negative intervals, the Drools rule engine generates an error.
</td>
</tr>
</table>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">started by</dt>
<dd>
<p>This operator specifies if the two events start at the same time but the correlated event ends before the current event ends. (The behavior of this operator is the reverse of the <code>starts</code> operator behavior.)</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>For example, the following pattern matches if <code>$eventA</code> and <code>$eventB</code> start at the same time, and <code>$eventB</code> ends before <code>$eventA</code> ends:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA(this startedby $eventB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also express this operator in the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA.startTimestamp == $eventB.startTimestamp
&amp;&amp;
$eventA.endTimestamp &gt; $eventB.endTimestamp</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>started by</code> operator supports one optional parameter that sets the maximum distance between the start times of the two events:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$eventA : EventA( this starts[5s] $eventB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This pattern matches if these conditions are met:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">abs( $eventA.startTimestamp - $eventB.startTimestamp ) &lt;= 5s
&amp;&amp;
$eventA.endTimestamp &gt; $eventB.endTimestamp</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The Drools rule engine does not support negative intervals for the <code>started by</code> operator. If you use negative intervals, the Drools rule engine generates an error.
</td>
</tr>
</table>
</div>
</div>
</div>
</dd>
</dl>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="cep-clock-ref_rule-engine"><a class="anchor" href="#cep-clock-ref_rule-engine"></a>Session clock implementations in the Drools rule engine</h3>
<div class="paragraph">
<p>During complex event processing, events in the Drools rule engine may have temporal constraints and therefore require a session clock that provides the current time. For example, if a rule needs to determine the average price of a given stock over the last 60 minutes, the Drools rule engine must be able to compare the stock price event time stamp with the current time in the session clock.</p>
</div>
<div class="paragraph">
<p>The Drools rule engine supports a real-time clock and a pseudo clock. You can use one or both clock types depending on the scenario:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Rules testing:</strong> Testing requires a controlled environment, and when the tests include rules with temporal constraints, you must be able to control the input rules and facts and the flow of time.</p>
</li>
<li>
<p><strong>Regular execution:</strong> The Drools rule engine reacts to events in real time and therefore requires a real-time clock.</p>
</li>
<li>
<p><strong>Special environments:</strong> Specific environments may have specific time control requirements. For example, clustered environments may require clock synchronization or Java Enterprise Edition (JEE) environments may require a clock provided by the application server.</p>
</li>
<li>
<p><strong>Rules replay or simulation:</strong> In order to replay or simulate scenarios, the application must be able to control the flow of time.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Consider your environment requirements as you decide whether to use a real-time clock or pseudo clock in the Drools rule engine.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Real-time clock</dt>
<dd>
<p>The real-time clock is the default clock implementation in the Drools rule engine and uses the system clock to determine the current time for time stamps. To configure the Drools rule engine to use the real-time clock, set the KIE session configuration parameter to <code>realtime</code>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Configure real-time clock in KIE session</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.kie.api.KieServices.Factory;
import org.kie.api.runtime.conf.ClockTypeOption;
import org.kie.api.runtime.KieSessionConfiguration;

KieSessionConfiguration config = KieServices.Factory.get().newKieSessionConfiguration();

config.setOption(ClockTypeOption.get("realtime"));</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">Pseudo clock</dt>
<dd>
<p>The pseudo clock implementation in the Drools rule engine is helpful for testing temporal rules and it can be controlled by the application. To configure the Drools rule engine to use the pseudo clock, set the KIE session configuration parameter to <code>pseudo</code>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Configure pseudo clock in KIE session</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.kie.api.runtime.conf.ClockTypeOption;
import org.kie.api.runtime.KieSessionConfiguration;
import org.kie.api.KieServices.Factory;

KieSessionConfiguration config = KieServices.Factory.get().newKieSessionConfiguration();

config.setOption(ClockTypeOption.get("pseudo"));</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use additional configurations and fact handlers to control the pseudo clock:</p>
</div>
<div class="listingblock">
<div class="title">Control pseudo clock behavior in KIE session</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import java.util.concurrent.TimeUnit;

import org.kie.api.runtime.KieSessionConfiguration;
import org.kie.api.KieServices.Factory;
import org.kie.api.runtime.KieSession;
import org.drools.core.time.SessionPseudoClock;
import org.kie.api.runtime.rule.FactHandle;
import org.kie.api.runtime.conf.ClockTypeOption;

KieSessionConfiguration conf = KieServices.Factory.get().newKieSessionConfiguration();

conf.setOption( ClockTypeOption.get("pseudo"));
KieSession session = kbase.newKieSession(conf, null);

SessionPseudoClock clock = session.getSessionClock();

// While inserting facts, advance the clock as necessary.
FactHandle handle1 = session.insert(tick1);
clock.advanceTime(10, TimeUnit.SECONDS);

FactHandle handle2 = session.insert(tick2);
clock.advanceTime(30, TimeUnit.SECONDS);

FactHandle handle3 = session.insert(tick3);</code></pre>
</div>
</div>
</div>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="cep-event-streams-con_rule-engine"><a class="anchor" href="#cep-event-streams-con_rule-engine"></a>Event streams and entry points</h3>
<div class="paragraph">
<p>The Drools rule engine can process high volumes of events in the form of event streams. In DRL rule declarations, a stream is also known as an <em>entry point</em>. When you declare an entry point in a DRL rule or Java application, the Drools rule engine, at compile time, identifies and creates the proper internal structures to use data from only that entry point to evaluate that rule.</p>
</div>
<div class="paragraph">
<p>Facts from one entry point, or stream, can join facts from any other entry point in addition to facts already in the working memory of the Drools rule engine. Facts always remain associated with the entry point through which they entered the Drools rule engine. Facts of the same type can enter the Drools rule engine through several entry points, but facts that enter the Drools rule engine through entry point A can never match a pattern from entry point B.</p>
</div>
<div class="paragraph">
<p>Event streams have the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Events in the stream are ordered by time stamp. The time stamps may have different semantics for different streams, but they are always ordered internally.</p>
</li>
<li>
<p>Event streams usually have a high volume of events.</p>
</li>
<li>
<p>Atomic events in streams are usually not useful individually, only collectively in a stream.</p>
</li>
<li>
<p>Event streams can be homogeneous and contain a single type of event, or heterogeneous and contain events of different types.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="cep-event-streams-proc_rule-engine"><a class="anchor" href="#cep-event-streams-proc_rule-engine"></a>Declaring entry points for rule data</h4>
<div class="paragraph">
<p>You can declare an entry point (event stream) for events so that the Drools rule engine uses data from only that entry point to evaluate the rules. You can declare an entry point either implicitly by referencing it in DRL rules or explicitly in your Java application.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Use one of the following methods to declare the entry point:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In the DRL rule file, specify <code>from entry-point "&lt;name&gt;"</code> for the inserted fact:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Authorize withdrawal rule with "ATM Stream" entry point</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Authorize withdrawal"
when
  WithdrawRequest($ai : accountId, $am : amount) from entry-point "ATM Stream"
  CheckingAccount(accountId == $ai, balance &gt; $am)
then
  // Authorize withdrawal.
end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Apply fee rule with "Branch Stream" entry point</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Apply fee on withdraws on branches"
when
  WithdrawRequest($ai : accountId, processed == true) from entry-point "Branch Stream"
  CheckingAccount(accountId == $ai)
then
  // Apply a $2 fee on the account.
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both example DRL rules from a banking application insert the event <code>WithdrawalRequest</code> with the fact <code>CheckingAccount</code>, but from different entry points. At run time, the Drools rule engine evaluates the <code>Authorize withdrawal</code> rule using data from only the <code>"ATM Stream"</code> entry point, and evaluates the <code>Apply fee</code> rule using data from only the <code>"Branch Stream"</code> entry point. Any events inserted into the <code>"ATM Stream"</code> can never match patterns for the <code>"Apply fee"</code> rule, and any events inserted into the <code>"Branch Stream"</code> can never match patterns for the <code>"Authorize withdrawal rule"</code>.</p>
</div>
</div>
</div>
</li>
<li>
<p>In the Java application code, use the <code>getEntryPoint()</code> method to specify and obtain an <code>EntryPoint</code> object and insert facts into that entry point accordingly:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Java application code with EntryPoint object and inserted facts</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.kie.api.runtime.KieSession;
import org.kie.api.runtime.rule.EntryPoint;

// Create your KIE base and KIE session as usual.
KieSession session = ...

// Create a reference to the entry point.
EntryPoint atmStream = session.getEntryPoint("ATM Stream");

// Start inserting your facts into the entry point.
atmStream.insert(aWithdrawRequest);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Any DRL rules that specify <code>from entry-point "ATM Stream"</code> are then evaluated based on the data in this entry point only.</p>
</div>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cep-sliding-windows-con_rule-engine"><a class="anchor" href="#cep-sliding-windows-con_rule-engine"></a>Sliding windows of time or length</h3>
<div class="paragraph">
<p>In stream mode, the Drools rule engine can process events from a specified sliding window of time or length. A sliding time window is a specified period of time during which events can be processed. A sliding length window is a specified number of events that can be processed. When you declare a sliding window in a DRL rule or Java application, the Drools rule engine, at compile time, identifies and creates the proper internal structures to use data from only that sliding window to evaluate that rule.</p>
</div>
<div class="paragraph">
<p>For example, the following DRL rule snippets instruct the Drools rule engine to process only the stock points from the last 2 minutes (sliding time window) or to process only the last 10 stock points (sliding length window):</p>
</div>
<div class="listingblock">
<div class="title">Process stock points from the last 2 minutes (sliding time window)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">StockPoint() over window:time(2m)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Process the last 10 stock points (sliding length window)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">StockPoint() over window:length(10)</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="cep-sliding-windows-proc_rule-engine"><a class="anchor" href="#cep-sliding-windows-proc_rule-engine"></a>Declaring sliding windows for rule data</h4>
<div class="paragraph">
<p>You can declare a sliding window of time (flow of time) or length (number of occurrences) for events so that the Drools rule engine uses data from only that window to evaluate the rules.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>In the DRL rule file, specify <code>over window:&lt;time_or_length&gt;(&lt;value&gt;)</code> for the inserted fact.</p>
</div>
<div class="paragraph">
<p>For example, the following two DRL rules activate a fire alarm based on an average temperature. However, the first rule uses a sliding time window to calculate the average over the last 10 minutes while the second rule uses a sliding length window to calculate the average over the last one hundred temperature readings.</p>
</div>
<div class="listingblock">
<div class="title">Average temperature over sliding time window</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Sound the alarm if temperature rises above threshold"
when
  TemperatureThreshold($max : max)
  Number(doubleValue &gt; $max) from accumulate(
    SensorReading($temp : temperature) over window:time(10m),
    average($temp))
then
  // Sound the alarm.
end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Average temperature over sliding length window</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Sound the alarm if temperature rises above threshold"
when
  TemperatureThreshold($max : max)
  Number(doubleValue &gt; $max) from accumulate(
    SensorReading($temp : temperature) over window:length(100),
    average($temp))
then
  // Sound the alarm.
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Drools rule engine discards any <code>SensorReading</code> events that are more than 10 minutes old or that are not part of the last one hundred readings, and continues recalculating the average as the minutes or readings "slide" forward in real time.</p>
</div>
<div class="paragraph">
<p>The Drools rule engine does not automatically remove outdated events from the KIE session because other rules without sliding window declarations might depend on those events. The Drools rule engine stores events in the KIE session until the events expire either by explicit rule declarations or by implicit reasoning within the Drools rule engine based on inferred data in the KIE base.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cep-memory-management-con_rule-engine"><a class="anchor" href="#cep-memory-management-con_rule-engine"></a>Memory management for events</h3>
<div class="paragraph">
<p>In stream mode, the Drools rule engine uses automatic memory management to maintain events that are stored in KIE sessions. The Drools rule engine can retract from a KIE session any events that no longer match any rule due to their temporal constraints and release any resources held by the retracted events.</p>
</div>
<div class="paragraph">
<p>The Drools rule engine uses either explicit or inferred expiration to retract outdated events:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Explicit expiration:</strong> The Drools rule engine removes events that are explicitly set to expire in rules that declare the <code>@expires</code> tag:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">DRL rule snippet with explicit expiration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">declare StockPoint
  @expires( 30m )
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example rule sets any <code>StockPoint</code> events to expire after 30 minutes and to be removed from the KIE session if no other rules use the events.</p>
</div>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>By default the expiration defined in this way is a hard expiration, which means that the Drools rule engine removes the event from the session immediately after this expiration time, regardless if there are rules that could still match the event. You can also define a soft expiration, which means that the Drools rule engine removes the event from the session only if no other rules use the event. It is possible to define a soft expiration policy for an event as it follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">declare StockPoint
  @expires( 30m, policy = TIME_SOFT )
end</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Inferred expiration:</strong> The Drools rule engine can calculate the expiration offset for a given event implicitly by analyzing the temporal constraints in the rules:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">DRL rule with temporal constraints</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Correlate orders"
when
  $bo : BuyOrder($id : id)
  $ae : AckOrder(id == $id, this after[0,10s] $bo)
then
  // Perform an action.
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>For this example rule, the Drools rule engine automatically calculates that whenever a <code>BuyOrder</code> event occurs, the Drools rule engine needs to store the event for up to 10 seconds and wait for the matching <code>AckOrder</code> event. After 10 seconds, the Drools rule engine infers the expiration and removes the event from the KIE session. An <code>AckOrder</code> event can only match an existing <code>BuyOrder</code> event, so the Drools rule engine infers the expiration if no match occurs and removes the event immediately.</p>
</div>
<div class="paragraph">
<p>The same is applied to a sliding window of time <code>window:time()</code>, but a sliding window of length <code>window:length()</code> doesn&#8217;t calculate its expiration.</p>
</div>
<div class="paragraph">
<p>The Drools rule engine analyzes the entire KIE base to find the offset for every event type and to ensure that no other rules use the events that are pending removal. Whenever an implicit expiration clashes with an explicit expiration value, the explict one takes precedence if is hard (the default) while the implicit expiration is taken into account if the explicit one is defined as soft.</p>
</div>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="engine-queries-con_rule-engine"><a class="anchor" href="#engine-queries-con_rule-engine"></a>Drools rule engine queries and live queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can use queries with the Drools rule engine to retrieve fact sets based on fact patterns as they are used in rules. The patterns might also use optional parameters.</p>
</div>
<div class="paragraph">
<p>To use queries with the Drools rule engine, you add the query definitions in DRL files and then obtain the matching results in your application code. While a query iterates over a result collection, you can use any identifier that is bound to the query to access the corresponding fact or fact field by calling the <code>get()</code> method with the binding variable name as the argument. If the binding refers to a fact object, you can retrieve the fact handle by calling <code>getFactHandle()</code> with the variable name as the parameter.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/rule-engine/QueryResults.png" alt="QueryResults">
</div>
<div class="title">Figure 13. QueryResults</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/rule-engine/QueryResultsRow.png" alt="QueryResultsRow">
</div>
<div class="title">Figure 14. QueryResultsRow</div>
</div>
<div class="listingblock">
<div class="title">Example query definition in a DRL file</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">query "people under the age of 21"
    $person : Person( age &lt; 21 )
end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example application code to obtain and iterate over query results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">QueryResults results = ksession.getQueryResults( "people under the age of 21" );
System.out.println( "we have " + results.size() + " people under the age of 21" );

System.out.println( "These people are under the age of 21:" );

for ( QueryResultsRow row : results ) {
    Person person = ( Person ) row.get( "person" );
    System.out.println( person.getName() + "\n" );
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Invoking queries and processing the results by iterating over the returned set can be difficult when you are monitoring changes over time. To alleviate this difficulty with ongoing queries, Drools provides <em>live queries</em>, which use an attached listener for change events instead of returning an iterable result set. Live queries remain open by creating a view and publishing change events for the contents of this view.</p>
</div>
<div class="paragraph">
<p>To activate a live query, start your query with parameters and monitor changes in the resulting view. You can use the <code>dispose()</code> method to terminate the query and discontinue this reactive scenario.</p>
</div>
<div class="listingblock">
<div class="title">Example query definition in a DRL file</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">query colors(String $color1, String $color2)
    TShirt(mainColor = $color1, secondColor = $color2, $price: manufactureCost)
end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example application code with an event listener and a live query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">final List updated = new ArrayList();
final List removed = new ArrayList();
final List added = new ArrayList();

ViewChangedEventListener listener = new ViewChangedEventListener() {
 public void rowUpdated(Row row) {
  updated.add( row.get( "$price" ) );
 }

 public void rowRemoved(Row row) {
  removed.add( row.get( "$price" ) );
 }

 public void rowAdded(Row row) {
  added.add( row.get( "$price" ) );
 }
};

// Open the live query:
LiveQuery query = ksession.openLiveQuery( "colors",
                                          new Object[] { "red", "blue" },
                                          listener );
...
...

// Terminate the live query:
query.dispose()</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more live query examples, see <a href="http://blog.athico.com/2010/07/glazed-lists-examples-for-drools-live.html">Glazed Lists examples for Drools Live Queries</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="engine-event-listeners-con_rule-engine"><a class="anchor" href="#engine-event-listeners-con_rule-engine"></a>Drools rule engine event listeners and debug logging</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Drools rule engine generates events when performing activities such as fact insertions and rule executions. If you register event listeners, the Drools rule engine calls every listener when an activity is performed.</p>
</div>
<div class="paragraph">
<p>Event listeners have methods that correspond to different types of activities. The Drools rule engine passes an event object to each method; this object contains information about the specific activity.</p>
</div>
<div class="paragraph">
<p>Your code can implement custom event listeners and you can also add and remove registered event listeners. In this way, your code can be notified of Drools rule engine activity, and you can separate logging and auditing work from the core of your application.</p>
</div>
<div class="paragraph">
<p>The Drools rule engine supports the following event listeners with the following methods:</p>
</div>
<div class="listingblock">
<div class="title">Agenda event listener</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public interface AgendaEventListener
    extends
    EventListener {
    void matchCreated(MatchCreatedEvent event);
    void matchCancelled(MatchCancelledEvent event);
    void beforeMatchFired(BeforeMatchFiredEvent event);
    void afterMatchFired(AfterMatchFiredEvent event);
    void agendaGroupPopped(AgendaGroupPoppedEvent event);
    void agendaGroupPushed(AgendaGroupPushedEvent event);
    void beforeRuleFlowGroupActivated(RuleFlowGroupActivatedEvent event);
    void afterRuleFlowGroupActivated(RuleFlowGroupActivatedEvent event);
    void beforeRuleFlowGroupDeactivated(RuleFlowGroupDeactivatedEvent event);
    void afterRuleFlowGroupDeactivated(RuleFlowGroupDeactivatedEvent event);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Rule runtime event listener</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public interface RuleRuntimeEventListener extends EventListener {
    void objectInserted(ObjectInsertedEvent event);
    void objectUpdated(ObjectUpdatedEvent event);
    void objectDeleted(ObjectDeletedEvent event);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the definitions of event classes, see the <a href="https://github.com/apache/incubator-kie-drools/tree/10.0.0.Final/drools-core/src/main/java/org/drools/core/event">GitHub repository</a>.</p>
</div>
<div class="paragraph">
<p>Drools includes default implementations of these listeners: <code>DefaultAgendaEventListener</code> and <code>DefaultRuleRuntimeEventListener</code>. You can extend each of these implementations to monitor specific events.</p>
</div>
<div class="paragraph">
<p>For example, the following code extends <code>DefaultAgendaEventListener</code> to monitor the  <code>AfterMatchFiredEvent</code> event and attaches this listener to a KIE session. The code prints pattern matches when rules are executed (fired):</p>
</div>
<div class="listingblock">
<div class="title">Example code to monitor and print <code>AfterMatchFiredEvent</code> events in the agenda</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ksession.addEventListener( new DefaultAgendaEventListener() {
   public void afterMatchFired(AfterMatchFiredEvent event) {
       super.afterMatchFired( event );
       System.out.println( event );
   }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Drools also includes the following Drools rule engine agenda and rule runtime event listeners for debug logging:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DebugAgendaEventListener</code></p>
</li>
<li>
<p><code>DebugRuleRuntimeEventListener</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These event listeners implement the same supported event-listener methods and include a debug print statement by default. You can add additional monitoring code for a specific supported event.</p>
</div>
<div class="paragraph">
<p>For example, the following code uses the <code>DebugRuleRuntimeEventListener</code> event listener to monitor and print all working memory (rule runtime) events:</p>
</div>
<div class="listingblock">
<div class="title">Example code to monitor and print all working memory events</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ksession.addEventListener( new DebugRuleRuntimeEventListener() );</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="engine-event-listeners-development-con_rule-engine"><a class="anchor" href="#engine-event-listeners-development-con_rule-engine"></a>Practices for development of event listeners</h3>
<div class="paragraph">
<p>The Drools rule engine calls event listeners during rule processing. The calls block the execution of the Drools rule engine. Therefore, the event listener can affect the performance of the Drools rule engine.</p>
</div>
<div class="paragraph">
<p>To ensure minimal disruption, follow the following guidelines:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Any action must be as short as possible.</p>
</li>
<li>
<p>A listener class must not have a state. The Drools rule engine can destroy and re-create a listener class at any time.</p>
</li>
<li>
<p>Do not use logic that relies on the order of execution of different event listeners.</p>
</li>
<li>
<p>Do not include interactions with different entities outside the Drools rule engine within a listener. For example, do not include REST calls for notification of events. An exception is the output of logging information; however, a logging listener must be as simple as possible.</p>
</li>
<li>
<p>You can use a listener to modify the state of the Drools rule engine, for example, to change the values of variables.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="logging-proc_rule-engine"><a class="anchor" href="#logging-proc_rule-engine"></a>Configuring a logging utility in the Drools rule engine</h3>
<div class="paragraph">
<p>The Drools rule engine uses the Java logging API SLF4J for system logging. You can use one of the following logging utilities with the Drools rule engine to investigate Drools rule engine activity, such as for troubleshooting or data gathering:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Logback</p>
</li>
<li>
<p>Apache Commons Logging</p>
</li>
<li>
<p>Apache Log4j</p>
</li>
<li>
<p><code>java.util.logging</code> package</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>For the logging utility that you want to use, add the relevant dependency to your Maven project or save the relevant XML configuration file in the <code>org.drools</code> package of your Drools distribution:</p>
</div>
<div class="listingblock">
<div class="title">Example Maven dependency for Logback</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
  &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
  &lt;version&gt;${logback.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example logback.xml configuration file in org.drools package</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;configuration&gt;
  &lt;logger name="org.drools" level="debug"/&gt;
  ...
&lt;configuration&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example log4j.xml configuration file in org.drools package</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;log4j:configuration xmlns:log4j="http://jakarta.apache.org/log4j/"&gt;
  &lt;category name="org.drools"&gt;
    &lt;priority value="debug" /&gt;
  &lt;/category&gt;
  ...
&lt;/log4j:configuration&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you are developing for an ultra light environment, use the <code>slf4j-nop</code> or <code>slf4j-simple</code> logger.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="performance-tuning-rule-engine-ref_rule-engine"><a class="anchor" href="#performance-tuning-rule-engine-ref_rule-engine"></a>Performance tuning considerations with the Drools rule engine</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following key concepts or suggested practices can help you optimize Drools rule engine performance. These concepts are summarized in this section as a convenience and are explained in more detail in the cross-referenced documentation, where applicable. This section will expand or change as needed with new releases of Drools.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Use sequential mode for stateless KIE sessions that do not require important Drools rule engine updates</dt>
<dd>
<p>Sequential mode is an advanced rule base configuration in the Drools rule engine that enables the Drools rule engine to evaluate rules one time in the order that they are listed in the Drools rule engine agenda without regard to changes in the working memory. As a result, rule execution may be faster in sequential mode, but important updates may not be applied to your rules. Sequential mode applies to stateless KIE sessions only.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>To enable sequential mode, set the system property <code>drools.sequential</code> to <code>true</code>.</p>
</div>
<div class="paragraph">
<p>For more information about sequential mode or other options for enabling it, see <a href="#phreak-sequential-mode-con_rule-engine">Sequential mode in Phreak</a>.</p>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">Use simple operations with event listeners</dt>
<dd>
<p>Limit the number of event listeners and the type of operations they perform. Use event listeners for simple operations, such as debug logging and setting properties. Complicated operations, such as network calls, in listeners can impede rule execution. After you finish working with a KIE session, remove the attached event listeners so that the session can be cleaned, as shown in the following example:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example event listener removed after use</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Listener listener = ...;
StatelessKnowledgeSession ksession = createSession();
try {
    ksession.insert(fact);
    ksession.fireAllRules();
    ...
} finally {
    if (session != null) {
        ksession.detachListener(listener);
        ksession.dispose();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For information about built-in event listeners and debug logging in the Drools rule engine, see <a href="#engine-event-listeners-con_rule-engine">Drools rule engine event listeners and debug logging</a>.</p>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">Configure <code>LambdaIntrospector</code> cache size for an executable model build</dt>
<dd>
<p>You can configure the size of <code>LambdaIntrospector.methodFingerprintsMap</code> cache, which is used in an executable model build. The default size of the cache is <code>32</code>. When you configure smaller value for the cache size, it reduces memory usage. For example, you can configure system property <code>drools.lambda.introspector.cache.size</code> to <code>0</code> for minimum memory usage. Note that smaller cache size also slows down the build performance.</p>
</dd>
<dt class="hdlist1">Use lambda externalization for executable model</dt>
<dd>
<p>Enable lambda externalization to optimize the memory consumption during runtime. It rewrites lambdas that are generated and used in the executable model. This enables you to reuse the same lambda multiple times with all the patterns and the same constraint. When the rete or phreak is instantiated, the executable model becomes garbage collectible.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>To enable lambda externalization for the executable model, include the following property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">-Ddrools.externaliseCanonicalModelLambda=true</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">Configure alpha node range index threshold</dt>
<dd>
<p>Alpha node range index is used to evaluate the rule constraint. You can configure the threshold of the alpha node range index using the <code>drools.alphaNodeRangeIndexThreshold</code> system property. The default value of the threshold is <code>9</code>, indicating that the alpha node range index is enabled when a precedent node contains more than nine alpha nodes with inequality constraints. For example, when you have nine rules similar to <code>Person(age &gt; 10)</code>, <code>Person(age &gt; 20)</code>, &#8230;&#8203;, <code>Person(age &gt; 90)</code>, then you can have similar nine alpha nodes.</p>
<div class="paragraph">
<p>The default value of the threshold is based on the related advantages and overhead. However, if you configure a smaller value for the threshold, then the performance can be improved depending on your rules. For example, you can configure the <code>drools.alphaNodeRangeIndexThreshold</code> value to <code>6</code>, enabling the alpha node range index when you have more than six alpha nodes for a precedent node. You can set a suitable value for the threshold based on the performance test results of your rules.</p>
</div>
</dd>
<dt class="hdlist1">Enable join node range index</dt>
<dd>
<p>The join node range index feature improves the performance only when there is a large number of facts to be joined, for example, 256*16 combinations. When your application inserts a large number of facts, you can enable the join node range index and evaluate the performance improvement. By default, the join node range index is disabled.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example <code>kmodule.xml</code> file</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;kbase name="KBase1" betaRangeIndex="enabled"&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">System property for <code>BetaRangeIndexOption</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">drools.betaNodeRangeIndexEnabled=true</code></pre>
</div>
</div>
</div>
</div>
</dd>
</dl>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<!--Licensed to the Apache Software Foundation (ASF) under one-->
<!--or more contributor license agreements.  See the NOTICE file-->
<!--distributed with this work for additional information-->
<!--regarding copyright ownership.  The ASF licenses this file-->
<!--to you under the Apache License, Version 2.0 (the-->
<!--"License"); you may not use this file except in compliance-->
<!--with the License.  You may obtain a copy of the License at-->

<!--http://www.apache.org/licenses/LICENSE-2.0-->

<!--Unless required by applicable law or agreed to in writing,-->
<!--software distributed under the License is distributed on an-->
<!--"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY-->
<!--KIND, either express or implied.  See the License for the-->
<!--specific language governing permissions and limitations-->
<!--under the License.-->

<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script src="../../_/js/vendor/lunr.js"></script>
<script src="../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../_/css/search.css"></script>
<script async src="../../search-index.js"></script>
  </body>
</html>
