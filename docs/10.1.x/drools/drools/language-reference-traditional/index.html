<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Rule Language Reference (Traditional) :: Drools Documentation</title>
    <link rel="canonical" href="https://docs.drools.org/latest/drools-docs/drools/language-reference-traditional/index.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<!--Licensed to the Apache Software Foundation (ASF) under one-->
<!--or more contributor license agreements.  See the NOTICE file-->
<!--distributed with this work for additional information-->
<!--regarding copyright ownership.  The ASF licenses this file-->
<!--to you under the Apache License, Version 2.0 (the-->
<!--"License"); you may not use this file except in compliance-->
<!--with the License.  You may obtain a copy of the License at-->

<!--http://www.apache.org/licenses/LICENSE-2.0-->

<!--Unless required by applicable law or agreed to in writing,-->
<!--software distributed under the License is distributed on an-->
<!--"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY-->
<!--KIND, either express or implied.  See the License for the-->
<!--specific language governing permissions and limitations-->
<!--under the License.-->

<link rel="stylesheet" href="../../_/css/search.css">
<link rel="stylesheet" href="../../_/css/menu.css">
<link rel="stylesheet" href="../../_/css/drl.css">
<!--Licensed to the Apache Software Foundation (ASF) under one-->
<!--or more contributor license agreements.  See the NOTICE file-->
<!--distributed with this work for additional information-->
<!--regarding copyright ownership.  The ASF licenses this file-->
<!--to you under the Apache License, Version 2.0 (the-->
<!--"License"); you may not use this file except in compliance-->
<!--with the License.  You may obtain a copy of the License at-->

<!--http://www.apache.org/licenses/LICENSE-2.0-->

<!--Unless required by applicable law or agreed to in writing,-->
<!--software distributed under the License is distributed on an-->
<!--"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY-->
<!--KIND, either express or implied.  See the License for the-->
<!--specific language governing permissions and limitations-->
<!--under the License.-->

<script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<!--Licensed to the Apache Software Foundation (ASF) under one-->
<!--or more contributor license agreements.  See the NOTICE file-->
<!--distributed with this work for additional information-->
<!--regarding copyright ownership.  The ASF licenses this file-->
<!--to you under the Apache License, Version 2.0 (the-->
<!--"License"); you may not use this file except in compliance-->
<!--with the License.  You may obtain a copy of the License at-->

<!--http://www.apache.org/licenses/LICENSE-2.0-->

<!--Unless required by applicable law or agreed to in writing,-->
<!--software distributed under the License is distributed on an-->
<!--"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY-->
<!--KIND, either express or implied.  See the License for the-->
<!--specific language governing permissions and limitations-->
<!--under the License.-->

<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="https://kie.apache.org/">
          <img src="../../_/img/droolsExpertLogo.png" alt="Drools logo"/>
        </a>
        <a class="navbar-item" href="https://kie.apache.org/">
          Drools Documentation
        </a>
      </div>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search docs">
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item">
          <a class="navbar-item small-item" href="https://github.com/apache/incubator-kie-drools" title="Follow Drools on GitHub"><div class="github-icon"></div></a>
          <a class="navbar-item small-item" href="https://twitter.com/KieCommunity" target="_blank" title="Follow KIE Community on Twitter for more Drools tweets"><img alt="T" src="../../_/img/twitterLogo.png"></a>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="drools" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../introduction/index.html">Drools User Guide 10.1.0</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../introduction/index.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../getting-started/index.html">Getting Started</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../KIE/index.html">Build, Deploy, Utilize and Run</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../rule-engine/index.html">Drools rule engine</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../language-reference/index.html">Rule Language Reference</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="index.html">Rule Language Reference (Traditional)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../DMN/index.html">Decision Model and Notation (DMN)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../pragmatic-ai/index.html">Pragmatic AI: Integrating Machine Learning with Drools</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../Commands/index.html">Drools Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../migration-guide/index.html">Migration Guide</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../experimental-features/index.html">Experimental features</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../release-notes/index.html">Release Notes</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Drools User Guide 10.1.0</span>
    <span class="version">default</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../introduction/index.html">Drools User Guide 10.1.0</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../introduction/index.html">default</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../introduction/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../introduction/index.html">Drools User Guide 10.1.0</a></li>
    <li><a href="index.html">Rule Language Reference (Traditional)</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Rule Language Reference (Traditional)</h1>
<div class="sect1">
<h2 id=""con-drl_drl-rules-traditional"><a class="anchor" href="#"con-drl_drl-rules-traditional"></a>Traditional DRL Syntax</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>This chapter explains the traditional DRL syntax. This syntax can be used instead of the RuleUnit and OOPath based syntax. The traditional syntax is still fully supported.</p>
</div>
<div class="sect2">
<h3 id="drl-packages-con_drl-rules-traditional"><a class="anchor" href="#drl-packages-con_drl-rules-traditional"></a>Packages in DRL</h3>
<div class="paragraph">
<p>A package is a folder of related assets in Drools, such as data objects, DRL files, decision tables, and other asset types. A package also serves as a unique namespace for each group of rules. A single rule base can contain multiple packages. You typically store all the rules for a package in the same file as the package declaration so that the package is self-contained. However, you can import objects from other packages that you want to use in the rules.</p>
</div>
<div class="paragraph">
<p>The following example is a package name and namespace for a DRL file in a mortgage application decision service:</p>
</div>
<div class="listingblock">
<div class="title">Example package definition in a DRL file</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">package org.mortgages;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following railroad diagram shows all the components that may make up a package:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/package.png" alt="package">
</div>
<div class="title">Figure 1. Package</div>
</div>
<div class="paragraph">
<p>Note that a package <em>must</em> have a namespace and be declared using standard Java conventions for package names; i.e., no spaces, unlike rule names which allow spaces.
In terms of the order of elements, they can appear in any order in the rule file, with the exception of the <code>package</code> statement, which must be at the top of the file.
In all cases, the semicolons are optional.</p>
</div>
<div class="paragraph">
<p>Notice that any rule attribute (as described the section Rule Attributes) may also be written at package level, superseding the attribute&#8217;s default value.
The modified default may still be replaced by an attribute setting within a rule.</p>
</div>
</div>
<div class="sect2">
<h3 id="drl-imports-con_drl-rules-traditional"><a class="anchor" href="#drl-imports-con_drl-rules-traditional"></a>Import statements in DRL</h3>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/import.png" alt="import">
</div>
<div class="title">Figure 2. Import</div>
</div>
<div class="paragraph">
<p>Similar to import statements in Java, imports in DRL files identify the fully qualified paths and type names for any objects that you want to use in the rules. You specify the package and data object in the format <code>packageName.objectName</code>, with multiple imports on separate lines. The Drools rule engine automatically imports classes from the Java package with the same name as the DRL package and from the package <code>java.lang</code>.</p>
</div>
<div class="paragraph">
<p>The following example is an import statement for a loan application object in a mortgage application decision service:</p>
</div>
<div class="listingblock">
<div class="title">Example import statement in a DRL file</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">import org.mortgages.LoanApplication;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="drl-functions-con_drl-rules-traditional"><a class="anchor" href="#drl-functions-con_drl-rules-traditional"></a>Functions in DRL</h3>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/function.png" alt="function">
</div>
<div class="title">Figure 3. Function</div>
</div>
<div class="paragraph">
<p>Functions in DRL files put semantic code in your rule source file instead of in Java classes. Functions are especially useful if an action (<code>then</code>) part of a rule is used repeatedly and only the parameters differ for each rule. Above the rules in the DRL file, you can declare the function or import a static method from a helper class as a function, and then use the function by name in an action (<code>then</code>) part of the rule.</p>
</div>
<div class="paragraph">
<p>The following examples illustrate a function that is either declared or an imported static method in a DRL file:</p>
</div>
<div class="listingblock">
<div class="title">Example function declaration with a rule (option 1)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">function String hello(String applicantName) {
    return "Hello " + applicantName + "!";
}

rule "Using a function"
  when
    // Empty
  then
    System.out.println( hello( "James" ) );
end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example import a static method of a Java class (option 2)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.example.applicant;

public class MyFunctions {

    public static String hello(String applicantName) {
        return "Hello " + applicantName + "!";
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">import static org.example.applicant.MyFunctions.hello;

rule "Using a function"
  when
    // Empty
  then
    System.out.println( hello( "James" ) );
end</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A function declared in a DRL file cannot be imported to a rule in a different package while a Java static method in a different package can be imported.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A function body cannot access globals.</p>
</div>
<div class="paragraph">
<p>From the RHS of a rule, you can always pass a global as a function parameter when invoking the function, for exmaple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">global List names;

rule "Using a function with parameters"
  when
    // Empty
  then
    addName( names, "James" );
end

function void addName(List names, String applicantName) {
  names.add(applicantName);
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="drl-queries-con_drl-rules-traditional"><a class="anchor" href="#drl-queries-con_drl-rules-traditional"></a>Queries in DRL</h3>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/query.png" alt="query">
</div>
<div class="title">Figure 4. Query</div>
</div>
<div class="paragraph">
<p>Queries in DRL files search the working memory of the Drools rule engine for facts related to the rules in the DRL file. You add the query definitions in DRL files and then obtain the matching results in your application code. Queries search for a set of defined conditions and do not require <code>when</code> or <code>then</code> specifications. Query names are global to the KIE base and therefore must be unique among all other rule queries in the project. To return the results of a query, you construct a <code>QueryResults</code> definition using <code>ksession.getQueryResults("name")</code>, where <code>"name"</code> is the query name. This returns a list of query results, which enable you to retrieve the objects that matched the query. You define the query and query results parameters above the rules in the DRL file.</p>
</div>
<div class="paragraph">
<p>The following example is a query definition in a DRL file for underage applicants in a mortgage application decision service, with the accompanying application code:</p>
</div>
<div class="listingblock">
<div class="title">Example query definition in a DRL file</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">query "people under the age of 21"
    $person : Person( age &lt; 21 )
end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example application code to obtain query results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">QueryResults results = ksession.getQueryResults( "people under the age of 21" );
System.out.println( "we have " + results.size() + " people under the age  of 21" );</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also iterate over the returned <code>QueryResults</code> using a standard <code>for</code> loop. Each element is a <code>QueryResultsRow</code> that you can use to access each of the columns in the tuple.</p>
</div>
<div class="listingblock">
<div class="title">Example application code to obtain and iterate over query results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">QueryResults results = ksession.getQueryResults( "people under the age of 21" );
System.out.println( "we have " + results.size() + " people under the age of 21" );

System.out.println( "These people are under the age of 21:" );

for ( QueryResultsRow row : results ) {
    Person person = ( Person ) row.get( "person" );
    System.out.println( person.getName() + "\n" );
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Support for positional syntax has been added for more compact code.
By default the declared type order in the type declaration matches the argument position.
But it possible to override these using the @position annotation.
This allows patterns to be used with positional arguments, instead of the more verbose named arguments.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">declare Cheese
    name : String @position(1)
    shop : String @position(2)
    price : int @position(0)
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>The @Position annotation, in the org.drools.definition.type package, can be used to annotate original pojos on the classpath.
Currently only fields on classes can be annotated.
Inheritance of classes is supported, but not interfaces or methods.
The isContainedIn query below demonstrates the use of positional arguments in a pattern; <code>Location(x, y;)</code> instead of <code>Location( thing == x, location == y).</code></p>
</div>
<div class="paragraph">
<p>Queries can now call other queries, this combined with optional query arguments provides derivation query style backward chaining.
Positional and named syntax is supported for arguments.
It is also possible to mix both positional and named, but positional must come first, separated by a semi colon.
Literal expressions can be passed as query arguments, but at this stage you cannot mix expressions with variables.
Here is an example of a query that calls another query.
Note that 'z' here will always be an 'out' variable.
The '?' symbol means the query is pull only, once the results are returned you will not receive further results as the underlying data changes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">declare Location
    thing : String
    location : String
end

query isContainedIn( String x, String y )
    Location(x, y;)
    or
    ( Location(z, y;) and ?isContainedIn(x, z;) )
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>As previously mentioned you can use live "open" queries to reactively receive changes over time from the query results, as the underlying data it queries against changes.
Notice the "look" rule calls the query without using '?'.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">query isContainedIn( String x, String y )
    Location(x, y;)
    or
    ( Location(z, y;) and isContainedIn(x, z;) )
end

rule look when
    Person( $l : likes )
    isContainedIn( $l, 'office'; )
then
   insertLogical( $l 'is in the office' );
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Drools supports unification for derivation queries, in short this means that arguments are optional.
It is possible to call queries from Java leaving arguments unspecified using the static field org.drools.core.runtime.rule.Variable.v - note you must use 'v' and not an alternative instance of Variable.
These are referred to as 'out' arguments.
Note that the query itself does not declare at compile time whether an argument is in or an out, this can be defined purely at runtime on each use.
The following example will return all objects contained in the office.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">results = ksession.getQueryResults( "isContainedIn", new Object[] {  Variable.v, "office" } );
l = new ArrayList&lt;List&lt;String&gt;&gt;();
for ( QueryResultsRow r : results ) {
    l.add( Arrays.asList( new String[] { (String) r.get( "x" ), (String) r.get( "y" ) } ) );
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The algorithm uses stacks to handle recursion, so the method stack will not blow up.</p>
</div>
<div class="paragraph">
<p>It is also possible to use as input argument for a query both the field of a fact as in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">query contains(String $s, String $c)
    $s := String( this.contains( $c ) )
end

rule PersonNamesWithA when
    $p : Person()
    contains( $p.name, "a"; )
then
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>and more in general any kind of valid expression like in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">query checkLength(String $s, int $l)
    $s := String( length == $l )
end

rule CheckPersonNameLength when
    $i : Integer()
    $p : Person()
    checkLength( $p.name, 1 + $i + $p.age; )
then
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following is not yet supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>List and Map unification</p>
</li>
<li>
<p>Expression unification - pred( X, X + 1, X * Y / 7 )</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="drl-declarations-con_drl-rules-traditional"><a class="anchor" href="#drl-declarations-con_drl-rules-traditional"></a>Type declarations and metadata in DRL</h3>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/type_declaration.png" alt="type declaration">
</div>
<div class="title">Figure 5. Type declaration</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/meta_data.png" alt="meta data">
</div>
<div class="title">Figure 6. Metadata</div>
</div>
<div class="paragraph">
<p>Declarations in DRL files define new fact types or metadata for fact types to be used by rules in the DRL file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>New fact types:</strong> The default fact type in the <code>java.lang</code> package of Drools is <code>Object</code>, but you can declare other types in DRL files as needed. Declaring fact types in DRL files enables you to define a new fact model directly in the Drools rule engine, without creating models in a lower-level language like Java. You can also declare a new type when a domain model is already built and you want to complement this model with additional entities that are used mainly during the reasoning process.</p>
</li>
<li>
<p><strong>Metadata for fact types:</strong> You can associate metadata in the format <code>@key(value)</code> with new or existing facts. Metadata can be any kind of data that is not represented by the fact attributes and is consistent among all instances of that fact type. The metadata can be queried at run time by the Drools rule engine and used in the reasoning process.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="drl-declarations-without-metadata-con_drl-rules-traditional"><a class="anchor" href="#drl-declarations-without-metadata-con_drl-rules-traditional"></a>Type declarations without metadata in DRL</h4>
<div class="paragraph">
<p>A declaration of a new fact does not require any metadata, but must include a list of attributes or fields. If a type declaration does not include identifying attributes, the Drools rule engine searches for an existing fact class in the classpath and raises an error if the class is missing.</p>
</div>
<div class="paragraph">
<p>The following example is a declaration of a new fact type <code>Person</code> with no metadata in a DRL file:</p>
</div>
<div class="listingblock">
<div class="title">Example declaration of a new fact type with a rule</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">declare Person
  name : String
  dateOfBirth : java.util.Date
  address : Address
end

rule "Using a declared type"
  when
    $p : Person( name == "James" )
  then   // Insert Mark, who is a customer of James.
    Person mark = new Person();
    mark.setName( "Mark" );
    insert( mark );
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the new fact type <code>Person</code> has the three attributes <code>name</code>, <code>dateOfBirth</code>, and <code>address</code>. Each attribute has a type that can be any valid Java type, including another class that you create or a fact type that you previously declared. The <code>dateOfBirth</code> attribute has the type <code>java.util.Date</code>, from the Java API, and the <code>address</code> attribute has the previously defined fact type <code>Address</code>.</p>
</div>
<div class="paragraph">
<p>To avoid writing the fully qualified name of a class every time you declare it, you can define the full class name as part of the <code>import</code> clause:</p>
</div>
<div class="listingblock">
<div class="title">Example type declaration with the fully qualified class name in the import</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">import java.util.Date

declare Person
    name : String
    dateOfBirth : Date
    address : Address
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you declare a new fact type, the Drools rule engine generates at compile time a Java class representing the fact type. The generated Java class is a one-to-one JavaBeans mapping of the type definition.</p>
</div>
<div class="paragraph">
<p>For example, the following Java class is generated from the example <code>Person</code> type declaration:</p>
</div>
<div class="listingblock">
<div class="title">Generated Java class for the Person fact type declaration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class Person implements Serializable {
    private String name;
    private java.util.Date dateOfBirth;
    private Address address;

    // Empty constructor
    public Person() {...}

    // Constructor with all fields
    public Person( String name, Date dateOfBirth, Address address ) {...}

    // If keys are defined, constructor with keys
    public Person( ...keys... ) {...}

    // Getters and setters
    // `equals` and `hashCode`
    // `toString`
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then use the generated class in your rules like any other fact, as illustrated in the previous rule example with the <code>Person</code> type declaration:</p>
</div>
<div class="listingblock">
<div class="title">Example rule that uses the declared Person fact type</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Using a declared type"
  when
    $p : Person( name == "James" )
  then   // Insert Mark, who is a customer of James.
    Person mark = new Person();
    mark.setName( "Mark" );
    insert( mark );
end</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="drl-declarations-enumerative-con_drl-rules-traditional"><a class="anchor" href="#drl-declarations-enumerative-con_drl-rules-traditional"></a>Enumerative type declarations in DRL</h4>
<div class="paragraph">
<p>DRL supports the declaration of enumerative types in the format <code>declare enum &lt;factType&gt;</code>, followed by a comma-separated list of values ending with a semicolon. You can then use the enumerative list in the rules in the DRL file.</p>
</div>
<div class="paragraph">
<p>For example, the following enumerative type declaration defines days of the week for an employee scheduling rule:</p>
</div>
<div class="listingblock">
<div class="title">Example enumerative type declaration with a scheduling rule</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">declare enum DaysOfWeek
   SUN("Sunday"),MON("Monday"),TUE("Tuesday"),WED("Wednesday"),THU("Thursday"),FRI("Friday"),SAT("Saturday");

   fullName : String
end

rule "Using a declared Enum"
when
   $emp : Employee( dayOff == DaysOfWeek.MON )
then
   ...
end</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="drl-declarations-extended-con_drl-rules-traditional"><a class="anchor" href="#drl-declarations-extended-con_drl-rules-traditional"></a>Extended type declarations in DRL</h4>
<div class="paragraph">
<p>DRL supports type declaration inheritance in the format <code>declare &lt;factType1&gt; extends &lt;factType2&gt;</code>. To extend a type declared in Java by a subtype declared in DRL, you repeat the parent type in a declaration statement without any fields.</p>
</div>
<div class="paragraph">
<p>For example, the following type declarations extend a <code>Student</code> type from a top-level <code>Person</code> type, and a <code>LongTermStudent</code> type from the <code>Student</code> subtype:</p>
</div>
<div class="listingblock">
<div class="title">Example extended type declarations</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">import org.people.Person

declare Person end

declare Student extends Person
    school : String
end

declare LongTermStudent extends Student
    years : int
    course : String
end</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="drl-declarations-with-metadata-con_drl-rules-traditional"><a class="anchor" href="#drl-declarations-with-metadata-con_drl-rules-traditional"></a>Type declarations with metadata in DRL</h4>
<div class="paragraph">
<p>You can associate metadata in the format <code>@key(value)</code> (the value is optional) with fact types or fact attributes. Metadata can be any kind of data that is not represented by the fact attributes and is consistent among all instances of that fact type. The metadata can be queried at run time by the Drools rule engine and used in the reasoning process. Any metadata that you declare before the attributes of a fact type are assigned to the fact type, while metadata that you declare after an attribute are assigned to that particular attribute.</p>
</div>
<div class="paragraph">
<p>In the following example, the two metadata attributes <code>@author</code> and <code>@dateOfCreation</code> are declared for the <code>Person</code> fact type, and the two metadata items <code>@key</code> and <code>@maxLength</code> are declared for the <code>name</code> attribute. The <code>@key</code> metadata attribute has no required value, so the parentheses and the value are omitted.</p>
</div>
<div class="listingblock">
<div class="title">Example metadata declaration for fact types and attributes</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">import java.util.Date

declare Person
    @author( Bob )
    @dateOfCreation( 01-Feb-2009 )

    name : String @key @maxLength( 30 )
    dateOfBirth : Date
    address : Address
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>For declarations of metadata attributes for existing types, you can identify the fully qualified class name as part of the <code>import</code> clause for all declarations or as part of the individual <code>declare</code> clause:</p>
</div>
<div class="listingblock">
<div class="title">Example metadata declaration for an imported type</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">import org.drools.examples.Person

declare Person
    @author( Bob )
    @dateOfCreation( 01-Feb-2009 )
end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example metadata declaration for a declared type</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">declare org.drools.examples.Person
    @author( Bob )
    @dateOfCreation( 01-Feb-2009 )
end</code></pre>
</div>
</div>
<div id="drl-declarations-metadata-tags-ref_drl-rules-traditional" class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The examples in this section that refer to the <code>VoiceCall</code> class assume that the sample application domain model includes the following class details:</p>
</div>
<div class="listingblock">
<div class="title">VoiceCall fact class in an example Telecom domain model</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class VoiceCall {
  private String  originNumber;
  private String  destinationNumber;
  private Date    callDateTime;
  private long    callDuration;  // in milliseconds

  // Constructors, getters, and setters
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">@role</dt>
<dd>
<p>This tag determines whether a given fact type is handled as a regular fact or an event in the Drools rule engine during complex event processing.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Default parameter: <code>fact</code></p>
</div>
<div class="paragraph">
<p>Supported parameters: <code>fact</code>, <code>event</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">@role( fact | event )</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example: Declare VoiceCall as event type</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">declare VoiceCall
  @role( event )
end</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">@timestamp</dt>
<dd>
<p>This tag is automatically assigned to every event in the Drools rule engine. By default, the time is provided by the session clock and assigned to the event when it is inserted into the working memory of the Drools rule engine. You can specify a custom time stamp attribute instead of the default time stamp added by the session clock.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Default parameter: The time added by the Drools rule engine session clock</p>
</div>
<div class="paragraph">
<p>Supported parameters: Session clock time or custom time stamp attribute</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">@timestamp( &lt;attributeName&gt; )</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example: Declare VoiceCall timestamp attribute</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">declare VoiceCall
  @role( event )
  @timestamp( callDateTime )
end</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">@duration</dt>
<dd>
<p>This tag determines the duration time for events in the Drools rule engine. Events can be interval-based events or point-in-time events. Interval-based events have a duration time and persist in the working memory of the Drools rule engine until their duration time has lapsed. Point-in-time events have no duration and are essentially interval-based events with a duration of zero. By default, every event in the Drools rule engine has a duration of zero. You can specify a custom duration attribute instead of the default.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Default parameter: Null (zero)</p>
</div>
<div class="paragraph">
<p>Supported parameters: Custom duration attribute</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">@duration( &lt;attributeName&gt; )</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example: Declare VoiceCall duration attribute</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">declare VoiceCall
  @role( event )
  @timestamp( callDateTime )
  @duration( callDuration )
end</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">@expires</dt>
<dd>
<p>This tag determines the time duration before an event expires in the working memory of the Drools rule engine. By default, an event expires when the event can no longer match and activate any of the current rules. You can define an amount of time after which an event should expire. This tag definition also overrides the implicit expiration offset calculated from temporal constraints and sliding windows in the KIE base. This tag is available only when the Drools rule engine is running in stream mode.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Default parameter: Null (event expires after event can no longer match and activate rules)</p>
</div>
<div class="paragraph">
<p>Supported parameters: Custom <code>timeOffset</code> attribute in the format <code>[<mark>#d][#h][#m][#s][</mark>[ms]]</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">@expires( &lt;timeOffset&gt; )</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example: Declare expiration offset for VoiceCall events</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">declare VoiceCall
  @role( event )
  @timestamp( callDateTime )
  @duration( callDuration )
  @expires( 1h35m )
end</code></pre>
</div>
</div>
</div>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="drl-declarations-access-con_drl-rules-traditional"><a class="anchor" href="#drl-declarations-access-con_drl-rules-traditional"></a>Access to DRL declared types in application code</h4>
<div class="paragraph">
<p>Declared types in DRL are typically used within the DRL files while Java models are typically used when the model is shared between rules and applications. Because declared types are generated at KIE base compile time, an application cannot access them until application run time. In some cases, an application needs to access and handle facts directly from the declared types, especially when the application wraps the Drools rule engine and provides higher-level, domain-specific user interfaces for rules management.</p>
</div>
<div class="paragraph">
<p>To handle declared types directly from the application code, you can use the <code>org.drools.definition.type.FactType</code> API in Drools. Through this API, you can instantiate, read, and write fields in the declared fact types.</p>
</div>
<div class="paragraph">
<p>The following example code modifies a <code>Person</code> fact type directly from an application:</p>
</div>
<div class="listingblock">
<div class="title">Example application code to handle a declared fact type through the FactType API</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import java.util.Date;

import org.kie.api.definition.type.FactType;
import org.kie.api.KieBase;
import org.kie.api.runtime.KieSession;

...

// Get a reference to a KIE base with the declared type:
KieBase kbase = ...

// Get the declared fact type:
FactType personType = kbase.getFactType("org.drools.examples", "Person");

// Create instances:
Object bob = personType.newInstance();

// Set attribute values:
personType.set(bob, "name", "Bob" );
personType.set(bob, "dateOfBirth", new Date());
personType.set(bob, "address", new Address("King's Road","London","404"));

// Insert the fact into a KIE session:
KieSession ksession = ...
ksession.insert(bob);
ksession.fireAllRules();

// Read attributes:
String name = (String) personType.get(bob, "name");
Date date = (Date) personType.get(bob, "dateOfBirth");</code></pre>
</div>
</div>
<div class="paragraph">
<p>The API also includes other helpful methods, such as setting all the attributes at once, reading values from a <code>Map</code> collection, or reading all attributes at once into a <code>Map</code> collection.</p>
</div>
<div class="paragraph">
<p>Although the API behavior is similar to Java reflection, the API does not use reflection and relies on more performant accessors that are implemented with generated bytecode.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="drl-globals-con_drl-rules-traditional"><a class="anchor" href="#drl-globals-con_drl-rules-traditional"></a>Global variables in DRL</h3>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/global.png" alt="global">
</div>
<div class="title">Figure 7. Global</div>
</div>
<div class="paragraph">
<p>Global variables in DRL files typically provide data or services for the rules, such as application services used in rule consequences, and return data from rules, such as logs or values added in rule consequences. You set the global value in the working memory of the Drools rule engine through a KIE session configuration or REST operation, declare the global variable above the rules in the DRL file, and then use it in an action (<code>then</code>) part of the rule. For multiple global variables, use separate lines in the DRL file.</p>
</div>
<div class="paragraph">
<p>The following example illustrates a global variable list configuration for the Drools rule engine and the corresponding global variable definition in the DRL file:</p>
</div>
<div class="listingblock">
<div class="title">Example global list configuration for the Drools rule engine</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">List&lt;String&gt; list = new ArrayList&lt;&gt;();
KieSession kieSession = kiebase.newKieSession();
kieSession.setGlobal( "myGlobalList", list );</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example global variable definition with a rule</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">global java.util.List myGlobalList;

rule "Using a global"
  when
    // Empty
  then
    myGlobalList.add( "My global list" );
end</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not use global variables to establish conditions in rules unless a global variable has a constant immutable value. Global variables are not inserted into the working memory of the Drools rule engine, so the Drools rule engine cannot track value changes of variables.</p>
</div>
<div class="paragraph">
<p>Do not use global variables to share data between rules. Rules always reason and react to the working memory state, so if you want to pass data from rule to rule, assert the data as facts into the working memory of the Drools rule engine.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A use case for a global variable might be an instance of an email service. In your integration code that is calling the Drools rule engine, you obtain your <code>emailService</code> object and then set it in the working memory of the Drools rule engine. In the DRL file, you declare that you have a global of type <code>emailService</code> and give it the name <code>"email"</code>, and then in your rule consequences, you can use actions such as <code>email.sendSMS(number, message)</code>.</p>
</div>
<div class="paragraph">
<p>If you declare global variables with the same identifier in multiple packages, then you must set all the packages with the same type so that they all reference the same global value.</p>
</div>
<div class="sect3">
<h4 id="drl-timers-calendars-con_drl-rules-traditional"><a class="anchor" href="#drl-timers-calendars-con_drl-rules-traditional"></a>Timer and calendar rule attributes in DRL</h4>
<div class="paragraph">
<p>Timers and calendars are DRL rule attributes that enable you to apply scheduling and timing constraints to your DRL rules. These attributes require additional configurations depending on the use case.</p>
</div>
<div class="paragraph">
<p>The <code>timer</code> attribute in DRL rules is a string identifying either <code>int</code> (interval) or <code>cron</code> timer definitions for scheduling a rule and supports the following formats:</p>
</div>
<div class="listingblock">
<div class="title">Timer attribute formats</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">timer ( int: &lt;initial delay&gt; &lt;repeat interval&gt; )

timer ( cron: &lt;cron expression&gt; )</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example interval timer attributes</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">// Run after a 30-second delay
timer ( int: 30s )

// Run every 5 minutes after a 30-second delay each time
timer ( int: 30s 5m )</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example cron timer attribute</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">// Run every 15 minutes
timer ( cron:* 0/15 * * * ? )</code></pre>
</div>
</div>
<div class="paragraph">
<p>Interval timers follow the semantics of <code>java.util.Timer</code> objects, with an initial delay and an optional repeat interval. Cron timers follow standard Unix cron expressions.</p>
</div>
<div class="paragraph">
<p>The following example DRL rule uses a cron timer to send an SMS text message every 15 minutes:</p>
</div>
<div class="listingblock">
<div class="title">Example DRL rule with a cron timer</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Send SMS message every 15 minutes"
  timer ( cron:* 0/15 * * * ? )
  when
    $a : Alarm( on == true )
  then
    channels[ "sms" ].insert( new Sms( $a.mobileNumber, "The alarm is still on." );
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Generally, a rule that is controlled by a timer becomes active when the rule is triggered and the rule consequence is executed repeatedly, according to the timer settings. The execution stops when the rule condition no longer matches incoming facts. However, the way the Drools rule engine handles rules with timers depends on whether the Drools rule engine is in <em>active mode</em> or in <em>passive mode</em>.</p>
</div>
<div class="paragraph">
<p>By default, the Drools rule engine runs in <em>passive mode</em> and evaluates rules, according to the defined timer settings, when a user or an application explicitly calls <code>fireAllRules()</code>. Conversely, if a user or application calls <code>fireUntilHalt()</code>, the Drools rule engine starts in <em>active mode</em> and evaluates rules continually until the user or application explicitly calls <code>halt()</code>.</p>
</div>
<div class="paragraph">
<p>When the Drools rule engine is in active mode, rule consequences are executed even after control returns from a call to <code>fireUntilHalt()</code> and the Drools rule engine remains <em>reactive</em> to any changes made to the working memory. For example, removing a fact that was involved in triggering the timer rule execution causes the repeated execution to terminate, and inserting a fact so that some rule matches causes that rule to be executed. However, the Drools rule engine is not continually <em>active</em>, but is active only after a rule is executed. Therefore, the Drools rule engine does not react to asynchronous fact insertions until the next execution of a timer-controlled rule. Disposing a KIE session terminates all timer activity.</p>
</div>
<div class="paragraph">
<p>When the Drools rule engine is in passive mode, rule consequences of timed rules are evaluated only when <code>fireAllRules()</code> is invoked again. However, you can change the default timer-execution behavior in passive mode by configuring the KIE session with a <code>TimedRuleExecutionOption</code> option, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="title">KIE session configuration to automatically execute timed rules in passive mode</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">KieSessionConfiguration ksconf = KieServices.Factory.get().newKieSessionConfiguration();
ksconf.setOption( TimedRuleExecutionOption.YES );
KSession ksession = kbase.newKieSession(ksconf, null);</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can additionally set a <code>FILTERED</code> specification on the <code>TimedRuleExecutionOption</code> option that enables you to define a
callback to filter those rules, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="title">KIE session configuration to filter which timed rules are automatically executed</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">KieSessionConfiguration ksconf = KieServices.Factory.get().newKieSessionConfiguration();
conf.setOption( new TimedRuleExecutionOption.FILTERED(new TimedRuleExecutionFilter() {
    public boolean accept(Rule[] rules) {
        return rules[0].getName().equals("MyRule");
    }
}) );</code></pre>
</div>
</div>
<div class="paragraph">
<p>For interval timers, you can also use an expression timer with <code>expr</code> instead of <code>int</code> to define both the delay and interval as an expression instead of a fixed value.</p>
</div>
<div class="paragraph">
<p>The following example DRL file declares a fact type with a delay and period that are then used in the subsequent rule with an expression timer:</p>
</div>
<div class="listingblock">
<div class="title">Example rule with an expression timer</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">declare Bean
  delay   : String = "30s"
  period  : long = 60000
end

rule "Expression timer"
  timer ( expr: $d, $p )
  when
    Bean( $d : delay, $p : period )
  then
    // Actions
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>The expressions, such as <code>$d</code> and <code>$p</code> in this example, can use any variable defined in the pattern-matching part of the rule. The variable can be any <code>String</code> value that can be parsed into a time duration or any numeric value that is internally converted in a <code>long</code> value for a duration in milliseconds.</p>
</div>
<div class="paragraph">
<p>Both interval and expression timers can use the following optional parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>start</code> and <code>end</code>: A <code>Date</code> or a <code>String</code> representing a <code>Date</code> or a <code>long</code> value. The value can also be a <code>Number</code> that is transformed into a Java <code>Date</code> in the format <code>new Date( ((Number) n).longValue() )</code>.</p>
</li>
<li>
<p><code>repeat-limit</code>: An integer that defines the maximum number of repetitions allowed by the timer. If both the <code>end</code> and the <code>repeat-limit</code> parameters are set, the timer stops when the first of the two is reached.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example timer attribute with optional <code>start</code>, <code>end</code>, and <code>repeat-limit</code> parameters</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">timer (int: 30s 1h; start=3-JAN-2020, end=4-JAN-2020, repeat-limit=50)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the rule is scheduled for every hour, after a delay of 30 seconds each hour, beginning on 3 January 2020 and ending either on 4 January 2020 or when the cycle repeats 50 times.</p>
</div>
<div class="paragraph">
<p>If the system is paused (for example, the session is serialized and then later deserialized), the rule is scheduled only one time to recover from missing activations regardless of how many activations were missed during the pause, and then the rule is subsequently scheduled again to continue in sync with the timer setting.</p>
</div>
<div class="paragraph">
<p>The <code>calendar</code> attribute in DRL rules is a <a href="http://www.quartz-scheduler.org/">Quartz</a> style cron expression for scheduling a rule and supports the following format:</p>
</div>
<div class="listingblock">
<div class="title">Calendar attribute format</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">calendars "&lt;definition or registered name&gt;"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example calendar attributes</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">// Exclude non-business hours
calendars "* * 0-7,18-23 ? * *"

// Weekdays only, as registered in the KIE session
calendars "weekday"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can define a custom calendar and then register it in the KIE session, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="title">Defining a Calendar</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">private static final org.kie.api.time.Calendar WEEKDAY = timestamp -&gt; {
    final Calendar c = Calendar.getInstance();
    c.setTimeInMillis(timestamp);

    final int day = c.get(Calendar.DAY_OF_WEEK);
    return day != Calendar.SATURDAY &amp;&amp; day != Calendar.SUNDAY;
};</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Registering the calendar in the KIE session</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ksession.getCalendars().set( "weekday", WEEKDAY );</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use calendars with standard rules and with rules that use timers. The calendar attribute can contain one or more comma-separated calendar names written as <code>String</code> literals.</p>
</div>
<div class="paragraph">
<p>The following example rules use both calendars and timers to schedule the rules:</p>
</div>
<div class="listingblock">
<div class="title">Example rules with calendars and timers</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Weekdays are high priority"
  calendars "weekday"
  timer ( int:0 1h )
  when
    Alarm()
  then
    send( "priority high - we have an alarm" );
end

rule "Weekends are low priority"
  calendars "weekend"
  timer ( int:0 4h )
  when
    Alarm()
  then
    send( "priority low - we have an alarm" );
end</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="drl-rules-WHEN-con_drl-rules-traditional"><a class="anchor" href="#drl-rules-WHEN-con_drl-rules-traditional"></a>Rule conditions in DRL (WHEN)</h3>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/rule.png" alt="rule">
</div>
<div class="title">Figure 8. Rule</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/lhs.png" alt="lhs">
</div>
<div class="title">Figure 9. Conditional element in a rule</div>
</div>
<div class="paragraph">
<p>The <code>when</code> part of a DRL rule (also known as the <em>Left Hand Side (LHS)</em> of the rule) contains the conditions that must be met to execute an action. Conditions consist of a series of stated <em>patterns</em> and <em>constraints</em>, with optional <em>bindings</em> and supported rule condition elements (keywords), based on the available data objects in the package. For example, if a bank requires loan applicants to have over 21 years of age, then the <code>when</code> condition of an <code>"Underage"</code> rule would be <code>Applicant( age &lt; 21 )</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
DRL uses <code>when</code> instead of <code>if</code> because <code>if</code> is typically part of a procedural execution flow during which a condition is checked at a specific point in time. In contrast, <code>when</code> indicates that the condition evaluation is not limited to a specific evaluation sequence or point in time, but instead occurs continually at any time. Whenever the condition is met, the actions are executed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the <code>when</code> section is empty, then the conditions are considered to be true and the actions in the <code>then</code> section are executed the first time a <code>fireAllRules()</code> call is made in the Drools rule engine. This is useful if you want to use rules to set up the Drools rule engine state.</p>
</div>
<div class="paragraph">
<p>The following example rule uses empty conditions to insert a fact every time the rule is executed:</p>
</div>
<div class="listingblock">
<div class="title">Example rule without conditions</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Always insert applicant"
  when
    // Empty
  then   // Actions to be executed once
    insert( new Applicant() );
end

// The rule is internally rewritten in the following way:

rule "Always insert applicant"
  when
    eval( true )
  then
    insert( new Applicant() );
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>If rule conditions use multiple patterns with no defined keyword conjunctions (such as <code>and</code>, <code>or</code>, or <code>not</code>), the default conjunction is <code>and</code>:</p>
</div>
<div class="listingblock">
<div class="title">Example rule without keyword conjunctions</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Underage"
  when
    application : LoanApplication()
    Applicant( age &lt; 21 )
  then
    // Actions
end

// The rule is internally rewritten in the following way:

rule "Underage"
  when
    application : LoanApplication()
    and Applicant( age &lt; 21 )
  then
    // Actions
end</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_patterns_and_constraints"><a class="anchor" href="#_patterns_and_constraints"></a>Patterns and constraints</h4>
<div class="paragraph">
<p>A <em>pattern</em> in a DRL rule condition is the segment to be matched by the Drools rule engine. A pattern can potentially match each fact that is inserted into the working memory of the Drools rule engine. A pattern can also contain <em>constraints</em> to further define the facts to be matched.</p>
</div>
<div class="paragraph">
<p>The railroad diagram below shows the syntax for this:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/Pattern.png" alt="Pattern">
</div>
<div class="title">Figure 10. Pattern</div>
</div>
<div class="paragraph">
<p>In the simplest form, with no constraints, a pattern matches a fact of the given type. In the following example, the type is <code>Person</code>, so the pattern will match against all <code>Person</code> objects in the working memory of the Drools rule engine:</p>
</div>
<div class="listingblock">
<div class="title">Example pattern for a single fact type</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The type does not need to be the actual class of some fact object. Patterns can refer to superclasses or even interfaces, potentially matching facts from many different classes. For example, the following pattern matches all objects in the working memory of the Drools rule engine:</p>
</div>
<div class="listingblock">
<div class="title">Example pattern for all objects</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Object() // Matches all objects in the working memory</code></pre>
</div>
</div>
<div class="paragraph">
<p>The parentheses of a pattern enclose the constraints, such as the following constraint on the person&#8217;s age:</p>
</div>
<div class="listingblock">
<div class="title">Example pattern with a constraint</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( age == 50 )</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <em>constraint</em> is an expression that returns <code>true</code> or <code>false</code>. Pattern constraints in DRL are essentially Java expressions with some enhancements, such as property access, and some differences, such as <code>equals()</code> and <code>!equals()</code> semantics for <code>==</code> and <code>!=</code> (instead of the usual <code>same</code> and <code>not same</code> semantics).</p>
</div>
<div class="paragraph">
<p>Any JavaBeans property can be accessed directly from pattern constraints. A bean property is exposed internally using a standard JavaBeans getter that takes no arguments and returns something. For example, the <code>age</code> property is written as <code>age</code> in DRL instead of the getter <code>getAge()</code>:</p>
</div>
<div class="listingblock">
<div class="title">DRL constraint syntax with JavaBeans properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( age == 50 )

// This is the same as the following getter format:

Person( getAge() == 50 )</code></pre>
</div>
</div>
<div class="paragraph">
<p>Drools uses the standard JDK <code>Introspector</code> class to achieve this mapping, so it follows the standard JavaBeans specification. For optimal Drools rule engine performance, use the property access format, such as <code>age</code>, instead of using getters explicitly, such as <code>getAge()</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not use property accessors to change the state of the object in a way that might affect the rules because the Drools rule engine caches the results of the match between invocations for higher efficiency.</p>
</div>
<div class="paragraph">
<p>For example, do not use property accessors in the following ways:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public int getAge() {
    age++; // Do not do this.
    return age;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public int getAge() {
    Date now = DateUtil.now(); // Do not do this.
    return DateUtil.differenceInYears(now, birthday);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of following the second example, insert a fact that wraps the current date in the working memory and update that fact between <code>fireAllRules()</code> as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>However, if the getter of a property cannot be found, the compiler uses the property name as a fallback method name, without arguments:</p>
</div>
<div class="listingblock">
<div class="title">Fallback method if object is not found</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( age == 50 )

// If `Person.getAge()` does not exist, the compiler uses the following syntax:

Person( age() == 50 )</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also nest access properties in patterns, as shown in the following example. Nested properties are indexed by the Drools rule engine.</p>
</div>
<div class="listingblock">
<div class="title">Example pattern with nested property access</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( address.houseNumber == 50 )

// This is the same as the following format:

Person( getAddress().getHouseNumber() == 50 )</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
In stateful KIE sessions, use nested accessors carefully because the working memory of the Drools rule engine is not aware of any of the nested values and does not detect when they change. Either consider the nested values immutable while any of their parent references are inserted into the working memory, or, if you want to modify a nested value, mark all of the outer facts as updated. In the previous example, when the <code>houseNumber</code> property changes, any <code>Person</code> with that <code>Address</code> must be marked as updated.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can use any Java expression that returns a <code>boolean</code> value as a constraint inside the parentheses of a pattern. Java expressions can be mixed with other expression enhancements, such as property access:</p>
</div>
<div class="listingblock">
<div class="title">Example pattern with a constraint using property access and Java expression</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( age == 50 )</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can change the evaluation priority by using parentheses, as in any logical or mathematical expression:</p>
</div>
<div class="listingblock">
<div class="title">Example evaluation order of constraints</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( age &gt; 100 &amp;&amp; ( age % 10 == 0 ) )</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also reuse Java methods in constraints, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="title">Example constraints with reused Java methods</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( Math.round( weight / ( height * height ) ) &lt; 25.0 )</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not use constraints to change the state of the object in a way that might affect the rules because the Drools rule engine caches the results of the match between invocations for higher efficiency. Any method that is executed on a fact in the rule conditions must be a read-only method. Also, the state of a fact should not change between rule invocations unless those facts are marked as updated in the working memory on every change.</p>
</div>
<div class="paragraph">
<p>For example, do not use a pattern constraint in the following ways:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( incrementAndGetAge() == 10 ) // Do not do this.</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( System.currentTimeMillis() % 1000 == 0 ) // Do not do this.</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Standard Java operator precedence applies to constraint operators in DRL, and DRL operators follow standard Java semantics except for the <code>==</code> and <code>!=</code> operators.</p>
</div>
<div class="paragraph">
<p>The <code>==</code> operator uses null-safe <code>equals()</code> semantics instead of the usual <code>same</code> semantics. For example, the pattern <code>Person( firstName == "John" )</code> is similar to <code>java.util.Objects.equals(person.getFirstName(), "John")</code>, and because <code>"John"</code> is not null, the pattern is also similar to <code>"John".equals(person.getFirstName())</code>.</p>
</div>
<div class="paragraph">
<p>The <code>!=</code> operator uses null-safe <code>!equals()</code> semantics instead of the usual <code>not same</code> semantics. For example, the pattern <code>Person( firstName != "John" )</code> is similar to <code>!java.util.Objects.equals(person.getFirstName(), "John")</code>.</p>
</div>
<div class="paragraph">
<p>If the field and the value of a constraint are of different types, the Drools rule engine uses type coercion to resolve the conflict and reduce compilation errors. For instance, if <code>"ten"</code> is provided as a string in a numeric evaluator, a compilation error occurs, whereas <code>"10"</code> is coerced to a numeric 10. In coercion, the field type always takes precedence over the value type:</p>
</div>
<div class="listingblock">
<div class="title">Example constraint with a value that is coerced</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( age == "10" ) // "10" is coerced to 10</code></pre>
</div>
</div>
<div class="paragraph">
<p>For groups of constraints, you can use a delimiting comma <code>,</code> to use implicit <code>and</code> connective semantics:</p>
</div>
<div class="listingblock">
<div class="title">Example patterns with multiple constraints</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">// Person is more than 50 years old and weighs more than 80 kilograms:
Person( age &gt; 50, weight &gt; 80 )

// Person is more than 50 years old, weighs more than 80 kilograms, and is taller than 2 meters:
Person( age &gt; 50, weight &gt; 80, height &gt; 2 )</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Although the <code>&amp;&amp;</code> and <code>,</code> operators have the same semantics, they are resolved with different priorities. The <code>&amp;&amp;</code> operator precedes the <code>||</code> operator, and both the <code>&amp;&amp;</code> and <code>||</code> operators together precede the <code>,</code> operator. Use the comma operator at the top-level constraint for optimal Drools rule engine performance and human readability.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You cannot embed a comma operator in a composite constraint expression, such as in parentheses:</p>
</div>
<div class="listingblock">
<div class="title">Example of misused comma in composite constraint expression</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">// Do not use the following format:
Person( ( age &gt; 50, weight &gt; 80 ) || height &gt; 2 )

// Use the following format instead:
Person( ( age &gt; 50 &amp;&amp; weight &gt; 80 ) || height &gt; 2 )</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_bound_variables_in_patterns_and_constraints"><a class="anchor" href="#_bound_variables_in_patterns_and_constraints"></a>Bound variables in patterns and constraints</h4>
<div class="paragraph">
<p>You can bind variables to patterns and constraints to refer to matched objects in other portions of a rule. Bound variables can help you define rules more efficiently or more consistently with how you annotate facts in your data model. To differentiate more easily between variables and fields in a rule, use the standard format <code>$variable</code> for variables, especially in complex rules. This convention is helpful but not required in DRL.</p>
</div>
<div class="paragraph">
<p>For example, the following DRL rule uses the variable <code>$p</code> for a pattern with the <code>Person</code> fact:</p>
</div>
<div class="listingblock">
<div class="title">Pattern with a bound variable</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "simple rule"
  when
    $p : Person()
  then
    System.out.println( "Person " + $p );
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, you can also bind variables to properties in pattern constraints, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">// Two persons of the same age:
Person( $firstAge : age ) // Binding
Person( age == $firstAge ) // Constraint expression</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Constraint binding considers only the first atomic expression that follows it. In the following example the pattern only binds the age of the person to the variable <code>$a</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( $a : age * 2 &lt; 100 )</code></pre>
</div>
</div>
<div class="paragraph">
<p>For clearer and more efficient rule definitions, separate constraint bindings and constraint expressions. Although mixed bindings and expressions are supported, which can complicate patterns and affect evaluation efficiency.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">// Do not use the following format:
Person( $a : age * 2 &lt; 100 )

// Use the following format instead:
Person( age * 2 &lt; 100, $a : age )</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the preceding example, if you want to bind to the variable <code>$a</code> the double of the person&#8217;s age, you must make it an atomic expression by wrapping it in parentheses as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( $a : (age * 2) )</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Drools rule engine does not support bindings to the same declaration, but does support <em>unification</em> of arguments across several properties. While positional arguments are always processed with unification, the unification symbol <code>:=</code> exists for named arguments.</p>
</div>
<div class="paragraph">
<p>The following example patterns unify the <code>age</code> property across two <code>Person</code> facts:</p>
</div>
<div class="listingblock">
<div class="title">Example pattern with unification</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( $age := age )
Person( $age := age )</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unification declares a binding for the first occurrence and constrains to the same value of the bound field for sequence occurrences.</p>
</div>
</div>
<div class="sect3">
<h4 id="_nested_constraints_and_inline_casts"><a class="anchor" href="#_nested_constraints_and_inline_casts"></a>Nested constraints and inline casts</h4>
<div class="paragraph">
<p>In some cases, you might need to access multiple properties of a nested object, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="title">Example pattern to access multiple properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( name == "mark", address.city == "london", address.country == "uk" )</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can group these property accessors to nested objects with the syntax <code>.( &lt;constraints&gt; )</code> for more readable rules, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="title">Example pattern with grouped constraints</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( name == "mark", address.( city == "london", country == "uk") )</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The period prefix <code>.</code> differentiates the nested object constraints from a method call.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When you work with nested objects in patterns, you can use the syntax <code>&lt;type&gt;#&lt;subtype&gt;</code> to cast to a subtype and make the getters from the parent type available to the subtype. You can use either the object name or fully qualified class name, and you can cast to one or multiple subtypes, as shown in the following examples:</p>
</div>
<div class="listingblock">
<div class="title">Example patterns with inline casting to a subtype</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">// Inline casting with subtype name:
Person( name == "mark", address#LongAddress.country == "uk" )

// Inline casting with fully qualified class name:
Person( name == "mark", address#org.domain.LongAddress.country == "uk" )

// Multiple inline casts:
Person( name == "mark", address#LongAddress.country#DetailedCountry.population &gt; 10000000 )</code></pre>
</div>
</div>
<div class="paragraph">
<p>These example patterns cast <code>Address</code> to <code>LongAddress</code>, and additionally to <code>DetailedCountry</code> in the last example, making the parent getters available to the subtypes in each case.</p>
</div>
<div class="paragraph">
<p>You can use the <code>instanceof</code> operator to infer the results of the specified type in subsequent uses of that field with the pattern, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( name == "mark", address instanceof LongAddress, address.country == "uk" )</code></pre>
</div>
</div>
<div class="paragraph">
<p>If an inline cast is not possible (for example, if <code>instanceof</code> returns <code>false</code>), the evaluation is considered <code>false</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_date_literal_in_constraints"><a class="anchor" href="#_date_literal_in_constraints"></a>Date literal in constraints</h4>
<div class="paragraph">
<p>By default, the Drools rule engine supports the date format <code>dd-mmm-yyyy</code>. You can customize the date format, including a time format mask if needed, by providing an alternative format mask with the system property <code>drools.dateformat="dd-mmm-yyyy hh:mm"</code>. You can also customize the date format by changing the language locale with the <code>drools.defaultlanguage</code> and <code>drools.defaultcountry</code> system properties (for example, the locale of Thailand is set as <code>drools.defaultlanguage=th</code> and <code>drools.defaultcountry=TH</code>).</p>
</div>
<div class="listingblock">
<div class="title">Example pattern with a date literal restriction</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( bornBefore &lt; "27-Oct-2009" )</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_auto_boxing_and_primitive_types"><a class="anchor" href="#_auto_boxing_and_primitive_types"></a>Auto-boxing and primitive types</h4>
<div class="paragraph">
<p>Drools attempts to preserve numbers in their primitive or object wrapper form, so a variable bound to an int primitive when used in a code block or expression will no longer need manual unboxing; unlike early Drools versions where all primitives were autoboxed, requiring manual unboxing.
A variable bound to an object wrapper will remain as an object; the existing JDK 1.5 and JDK 5 rules to handle auto-boxing and unboxing apply in this case.
When evaluating field constraints, the system attempts to coerce one of the values into a comparable format; so a primitive is comparable to an object wrapper.</p>
</div>
</div>
<div class="sect3">
<h4 id="drl-operators-ref_drl-rules-traditional"><a class="anchor" href="#drl-operators-ref_drl-rules-traditional"></a>Supported operators in DRL pattern constraints</h4>
<div class="paragraph">
<p>DRL supports standard Java semantics for operators in pattern constraints, with some exceptions and with some additional operators that are unique in DRL. The following list summarizes the operators that are handled differently in DRL constraints than in standard Java semantics or that are unique in DRL constraints.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>.()</code>, <code>#</code></dt>
<dd>
<p>Use the <code>.()</code> operator to group property accessors to nested objects, and use the <code>#</code> operator to cast to a subtype in nested objects. Casting to a subtype makes the getters from the parent type available to the subtype. You can use either the object name or fully qualified class name, and you can cast to one or multiple subtypes.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example patterns with nested objects</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">// Ungrouped property accessors:
Person( name == "mark", address.city == "london", address.country == "uk" )

// Grouped property accessors:
Person( name == "mark", address.( city == "london", country == "uk") )</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The period prefix <code>.</code> differentiates the nested object constraints from a method call.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example patterns with inline casting to a subtype</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">// Inline casting with subtype name:
Person( name == "mark", address#LongAddress.country == "uk" )

// Inline casting with fully qualified class name:
Person( name == "mark", address#org.domain.LongAddress.country == "uk" )

// Multiple inline casts:
Person( name == "mark", address#LongAddress.country#DetailedCountry.population &gt; 10000000 )</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>!.</code></dt>
<dd>
<p>Use this operator to dereference a property in a null-safe way. The value to the left of the <code>!.</code> operator must be not null (interpreted as <code>!= null</code>) in order to give a positive result for pattern matching.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example constraint with null-safe dereferencing</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( $streetName : address!.street )

// This is internally rewritten in the following way:

Person( address != null, $streetName : address.street )</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>[]</code></dt>
<dd>
<p>Use this operator to access a <code>List</code> value by index or a <code>Map</code> value by key.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example constraints with <code>List</code> and <code>Map</code> access</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">// The following format is the same as `childList(0).getAge() == 18`:
Person(childList[0].age == 18)

// The following format is the same as `credentialMap.get("jdoe").isValid()`:
Person(credentialMap["jdoe"].valid)</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>&lt;</code>, <code>&lt;=</code>, <code>&gt;</code>, <code>&gt;=</code></dt>
<dd>
<p>Use these operators on properties with natural ordering. For example, for <code>Date</code> fields, the <code>&lt;</code> operator means <em>before</em>, and for <code>String</code> fields, the operator means <em>alphabetically before</em>. These properties apply only to comparable properties.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example constraints with <code>before</code> operator</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( birthDate &lt; $otherBirthDate )

Person( firstName &lt; $otherFirstName )</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>==</code>, <code>!=</code></dt>
<dd>
<p>Use these operators as <code>equals()</code> and <code>!equals()</code> methods in constraints, instead of the usual <code>same</code> and <code>not same</code> semantics.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example constraint with null-safe equality</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( firstName == "John" )

// This is similar to the following formats:

java.util.Objects.equals(person.getFirstName(), "John")
"John".equals(person.getFirstName())</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example constraint with null-safe not equality</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( firstName != "John" )

// This is similar to the following format:

!java.util.Objects.equals(person.getFirstName(), "John")</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>&amp;&amp;</code>, <code>||</code></dt>
<dd>
<p>Use these operators to create an abbreviated combined relation condition that adds more than one restriction on a field. You can group constraints with parentheses <code>()</code> to create a recursive syntax pattern.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example constraints with abbreviated combined relation</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">// Simple abbreviated combined relation condition using a single `&amp;&amp;`:
Person(age &gt; 30 &amp;&amp; &lt; 40)

// Complex abbreviated combined relation using groupings:
Person(age ((&gt; 30 &amp;&amp; &lt; 40) || (&gt; 20 &amp;&amp; &lt; 25)))

// Mixing abbreviated combined relation with constraint connectives:
Person(age &gt; 30 &amp;&amp; &lt; 40 || location == "london")</code></pre>
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/abbreviatedCombinedRelationCondition.png" alt="abbreviatedCombinedRelationCondition">
</div>
<div class="title">Figure 11. Abbreviated combined relation condition</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/abbreviatedCombinedRelationConditionGroup.png" alt="abbreviatedCombinedRelationConditionGroup">
</div>
<div class="title">Figure 12. Abbreviated combined relation condition withparentheses</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>matches</code>, <code>not matches</code></dt>
<dd>
<p>Use these operators to indicate that a field matches or does not match a specified Java regular expression. Typically, the regular expression is a <code>String</code> literal, but variables that resolve to a valid regular expression are also supported. These operators apply only to <code>String</code> properties. If you use <code>matches</code> against a <code>null</code> value, the resulting evaluation is always <code>false</code>. If you use <code>not matches</code> against a <code>null</code> value, the resulting evaluation is always <code>true</code>. As in Java, regular expressions that you write as <code>String</code> literals must use a double backslash <code>\\</code> to escape.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example constraint to match or not match a regular expression</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( country matches "(USA)?\\S*UK" )

Person( country not matches "(USA)?\\S*UK" )</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>contains</code>, <code>not contains</code></dt>
<dd>
<p>Use these operators to verify whether a field that is an <code>Array</code> or a <code>Collection</code> contains or does not contain a specified value. These operators apply to <code>Array</code> or <code>Collection</code> properties, but you can also use these operators in place of <code>String.contains()</code> and <code>!String.contains()</code> constraints checks.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example constraints with <code>contains</code> and <code>not contains</code> for a Collection</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">// Collection with a specified field:
FamilyTree( countries contains "UK" )

FamilyTree( countries not contains "UK" )


// Collection with a variable:
FamilyTree( countries contains $var )

FamilyTree( countries not contains $var )</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example constraints with <code>contains</code> and <code>not contains</code> for a String literal</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">// Sting literal with a specified field:
Person( fullName contains "Jr" )

Person( fullName not contains "Jr" )


// String literal with a variable:
Person( fullName contains $var )

Person( fullName not contains $var )</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For backward compatibility, the <code>excludes</code> operator is a supported synonym for <code>not contains</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>memberOf</code>, <code>not memberOf</code></dt>
<dd>
<p>Use these operators to verify whether a field is a member of or is not a member of an <code>Array</code> or a <code>Collection</code> that is defined as a variable. The <code>Array</code> or <code>Collection</code> must be a variable.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example constraints with <code>memberOf</code> and <code>not memberOf</code> with a Collection</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">FamilyTree( person memberOf $europeanDescendants )

FamilyTree( person not memberOf $europeanDescendants )</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>soundslike</code></dt>
<dd>
<p>Use this operator to verify whether a word has almost the same sound, using English pronunciation, as the given value (similar to the <code>matches</code> operator). This operator uses the Soundex algorithm.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example constraint with <code>soundslike</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">// Match firstName "Jon" or "John":
Person( firstName soundslike "John" )</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>str</code></dt>
<dd>
<p>Use this operator to verify whether a field that is a <code>String</code> starts with or ends with a specified value. You can also use this operator to verify the length of the <code>String</code>.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example constraints with <code>str</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">// Verify what the String starts with:
Message( routingValue str[startsWith] "R1" )

// Verify what the String ends with:
Message( routingValue str[endsWith] "R2" )

// Verify the length of the String:
Message( routingValue str[length] 17 )</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>in</code>, <code>notin</code></dt>
<dd>
<p>Use these operators to specify more than one possible value to match in a constraint (compound value restriction). This functionality of compound value restriction is supported only in the <code>in</code> and <code>not in</code> operators. The second operand of these operators must be a comma-separated list of values enclosed in parentheses. You can provide values as variables, literals, return values, or qualified identifiers. These operators are internally rewritten as a list of multiple restrictions using the operators <code>==</code> or <code>!=</code>.</p>
<div class="openblock">
<div class="content">
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/compoundValueRestriction.png" alt="compoundValueRestriction">
</div>
<div class="title">Figure 13. compoundValueRestriction</div>
</div>
<div class="listingblock">
<div class="title">Example constraints with <code>in</code> and <code>notin</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( $color : favoriteColor )
Color( type in ( "red", "blue", $color ) )

Person( $color : favoriteColor )
Color( type notin ( "red", "blue", $color ) )</code></pre>
</div>
</div>
</div>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="drl-operator-precedence-ref_drl-rules-traditional"><a class="anchor" href="#drl-operator-precedence-ref_drl-rules-traditional"></a>Operator precedence in DRL pattern constraints</h4>
<div class="paragraph">
<p>DRL supports standard Java operator precedence for applicable constraint operators, with some exceptions and with some additional operators that are unique in DRL. The following table lists DRL operator precedence where applicable, from highest to lowest precedence:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Operator precedence in DRL pattern constraints</caption>
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 28.5714%;">
<col style="width: 42.8572%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operator type</th>
<th class="tableblock halign-left valign-top">Operators</th>
<th class="tableblock halign-left valign-top">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nested or null-safe property access</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.</code>, <code>.()</code>, <code>!.</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not standard Java semantics</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>List</code> or <code>Map</code> access</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not standard Java semantics</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Constraint binding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not standard Java semantics</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multiplicative</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>*</code>, <code>/%</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Additive</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>+</code>, <code>-</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shift</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&gt;&gt;</code>, <code>&gt;&gt;&gt;</code>, <code>&lt;&lt;</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Relational</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;</code>, <code>&lt;=</code>, <code>&gt;</code>, <code>&gt;=</code>, <code>instanceof</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Equality</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>== !=</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses <code>equals()</code> and <code>!equals()</code> semantics, not standard Java <code>same</code> and <code>not same</code> semantics</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Non-short-circuiting <code>AND</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&amp;</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Non-short-circuiting exclusive <code>OR</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>^</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Non-short-circuiting inclusive <code>OR</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>|</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logical <code>AND</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&amp;&amp;</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logical <code>OR</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>||</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ternary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>? :</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comma-separated <code>AND</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>,</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not standard Java semantics</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="drl-rules-WHEN-elements-ref_drl-rules-traditional"><a class="anchor" href="#drl-rules-WHEN-elements-ref_drl-rules-traditional"></a>Supported rule condition elements in DRL (keywords)</h4>
<div class="paragraph">
<p>DRL supports the following rule condition elements (keywords) that you can use with the patterns that you define in DRL rule conditions:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>and</code></dt>
<dd>
<p>Use this to group conditional components into a logical conjunction. Infix and prefix <code>and</code> are supported. You can group patterns explicitly with parentheses <code>()</code>. By default, all listed patterns are combined with <code>and</code> when no conjunction is specified.</p>
<div class="openblock">
<div class="content">
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/infixAnd.png" alt="infixAnd">
</div>
<div class="title">Figure 14. infixAnd</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/prefixAnd.png" alt="prefixAnd">
</div>
<div class="title">Figure 15. prefixAnd</div>
</div>
<div class="listingblock">
<div class="title">Example patterns with <code>and</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">//Infix `and`:
Color( colorType : type ) and Person( favoriteColor == colorType )

//Infix `and` with grouping:
(Color( colorType : type ) and (Person( favoriteColor == colorType ) or Person( favoriteColor == colorType ))

// Prefix `and`:
(and Color( colorType : type ) Person( favoriteColor == colorType ))

// Default implicit `and`:
Color( colorType : type )
Person( favoriteColor == colorType )</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not use a leading declaration binding with the <code>and</code> keyword (as you can with <code>or</code>, for example). A declaration can only reference a single fact at a time, and if you use a declaration binding with <code>and</code>, then when <code>and</code> is satisfied, it matches both facts and results in an error.</p>
</div>
<div class="listingblock">
<div class="title">Example misuse of <code>and</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">// Causes compile error:
$person : (Person( name == "Romeo" ) and Person( name == "Juliet"))</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>or</code></dt>
<dd>
<p>Use this to group conditional components into a logical disjunction. Infix and prefix <code>or</code> are supported. You can group patterns explicitly with parentheses <code>()</code>. You can also use pattern binding with <code>or</code>, but each pattern must be bound separately.</p>
<div class="openblock">
<div class="content">
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/infixOr.png" alt="infixOr">
</div>
<div class="title">Figure 16. infixOr</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/prefixOr.png" alt="prefixOr">
</div>
<div class="title">Figure 17. prefixOr</div>
</div>
<div class="listingblock">
<div class="title">Example patterns with <code>or</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">//Infix `or`:
Color( colorType : type ) or Person( favoriteColor == colorType )

//Infix `or` with grouping:
(Color( colorType : type ) or (Person( favoriteColor == colorType ) and Person( favoriteColor == colorType ))

// Prefix `or`:
(or Color( colorType : type ) Person( favoriteColor == colorType ))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example patterns with <code>or</code> and pattern binding</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">pensioner : (Person( sex == "f", age &gt; 60 ) or Person( sex == "m", age &gt; 65 ))

(or pensioner : Person( sex == "f", age &gt; 60 )
    pensioner : Person( sex == "m", age &gt; 65 ))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Drools rule engine does not directly interpret the <code>or</code> element but uses logical transformations to rewrite a rule with <code>or</code> as a number of sub-rules. This process ultimately results in a rule that has a single <code>or</code> as the root node and one sub-rule for each of its condition elements. Each sub-rule is activated and executed like any normal rule, with no special behavior or interaction between the sub-rules.</p>
</div>
<div class="paragraph">
<p>Therefore, consider the <code>or</code> condition element a shortcut for generating two or more similar rules that, in turn, can create multiple activations when two or more terms of the disjunction are true.</p>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>exists</code></dt>
<dd>
<p>Use this to specify facts and constraints that must exist. This option is triggered on only the first match, not subsequent matches. If you use this element with multiple patterns, enclose the patterns with parentheses <code>()</code>.</p>
<div class="openblock">
<div class="content">
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/exists.png" alt="exists">
</div>
<div class="title">Figure 18. Exists</div>
</div>
<div class="listingblock">
<div class="title">Example patterns with <code>exists</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">exists Person( firstName == "John")

exists (Person( firstName == "John", age == 42 ))

exists (Person( firstName == "John" ) and
        Person( lastName == "Doe" ))</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>not</code></dt>
<dd>
<p>Use this to specify facts and constraints that must not exist. If you use this element with multiple patterns, enclose the patterns with parentheses <code>()</code>.</p>
<div class="openblock">
<div class="content">
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/not.png" alt="not">
</div>
<div class="title">Figure 19. Not</div>
</div>
<div class="listingblock">
<div class="title">Example patterns with <code>not</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">not Person( firstName == "John")

not (Person( firstName == "John", age == 42 ))

not (Person( firstName == "John" ) and
     Person( lastName == "Doe" ))</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>forall</code></dt>
<dd>
<p>Use this to verify whether all facts that match the first pattern match all the remaining patterns. When a <code>forall</code> construct is satisfied, the rule evaluates to <code>true</code>. This element is a scope delimiter, so it can use any previously bound variable, but no variable bound inside of it is available for use outside of it.</p>
<div class="openblock">
<div class="content">
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/forall.png" alt="forall">
</div>
<div class="title">Figure 20. Forall</div>
</div>
<div class="listingblock">
<div class="title">Example rule with <code>forall</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "All full-time employees have red ID badges"
  when
    forall( $emp : Employee( type == "fulltime" )
                   Employee( this == $emp, badgeColor == "red" ) )
  then
    // True, all full-time employees have red ID badges.
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the rule selects all <code>Employee</code> objects whose type is <code>"fulltime"</code>. For each fact that matches this pattern, the rule evaluates the patterns that follow (badge color) and if they match, the rule evaluates to <code>true</code>.</p>
</div>
<div class="paragraph">
<p>To state that all facts of a given type in the working memory of the Drools rule engine must match a set of constraints, you can use <code>forall</code> with a single pattern for simplicity.</p>
</div>
<div class="listingblock">
<div class="title">Example rule with <code>forall</code> and a single pattern</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "All employees have red ID badges"
  when
    forall( Employee( badgeColor == "red" ) )
  then
    // True, all employees have red ID badges.
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use <code>forall</code> constructs with multiple patterns or nest them with other condition elements, such as inside a <code>not</code> element construct.</p>
</div>
<div class="listingblock">
<div class="title">Example rule with <code>forall</code> and multiple patterns</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "All employees have health and dental care programs"
  when
    forall( $emp : Employee()
            HealthCare( employee == $emp )
            DentalCare( employee == $emp )
          )
  then
    // True, all employees have health and dental care.
end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example rule with <code>forall</code> and <code>not</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Not all employees have health and dental care"
  when
    not ( forall( $emp : Employee()
                  HealthCare( employee == $emp )
                  DentalCare( employee == $emp ) )
        )
  then
    // True, not all employees have health and dental care.
end</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The format <code>forall( p1 p2 p3 &#8230;&#8203;)</code> is equivalent to <code>not( p1 and not( and p2 p3 &#8230;&#8203; ) )</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>from</code></dt>
<dd>
<p>Use this to specify a data source for a pattern. This enables the Drools rule engine to reason over data that is not in the working memory. The data source can be a sub-field on a bound variable or the result of a method call. The expression used to define the object source is any expression that follows regular MVEL syntax. Therefore, the <code>from</code> element enables you to easily use object property navigation, execute method calls, and access maps and collection elements.</p>
<div class="openblock">
<div class="content">
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/from.png" alt="from">
</div>
<div class="title">Figure 21. from</div>
</div>
<div class="listingblock">
<div class="title">Example rule with <code>from</code> and pattern binding</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Validate zipcode"
  when
    Person( $personAddress : address )
    Address( zipcode == "23920W" ) from $personAddress
  then
    // Zip code is okay.
end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example rule with <code>from</code> and a graph notation</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Validate zipcode"
  when
    $p : Person()
    $a : Address( zipcode == "23920W" ) from $p.address
  then
    // Zip code is okay.
end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example rule with <code>from</code> to iterate over all objects</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Apply 10% discount to all items over US$ 100 in an order"
  when
    $order : Order()
    $item  : OrderItem( value &gt; 100 ) from $order.items
  then
    // Apply discount to `$item`.
end</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For large collections of objects, instead of adding an object with a large graph that the Drools rule engine must iterate over frequently, add the collection directly to the KIE session and then join the collection in the condition, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">when
  $order : Order()
  OrderItem( value &gt; 100, order == $order )</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example rule with <code>from</code> and <code>lock-on-active</code> rule attribute</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Assign people in North Carolina (NC) to sales region 1"
  ruleflow-group "test"
  lock-on-active true
  when
    $p : Person()
    $a : Address( state == "NC" ) from $p.address
  then
    modify ($p) {} // Assign the person to sales region 1.
end

rule "Apply a discount to people in the city of Raleigh"
  ruleflow-group "test"
  lock-on-active true
  when
    $p : Person()
    $a : Address( city == "Raleigh" ) from $p.address
  then
    modify ($p) {} // Apply discount to the person.
end</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Using <code>from</code> with <code>lock-on-active</code> rule attribute can result in rules not being executed. You can address this issue in one of the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Avoid using the <code>from</code> element when you can insert all facts into the working memory of the Drools rule engine or use nested object references in your constraint expressions.</p>
</li>
<li>
<p>Place the variable used in the <code>modify()</code> block as the last sentence in your rule condition.</p>
</li>
<li>
<p>Avoid using the <code>lock-on-active</code> rule attribute when you can explicitly manage how rules within the same ruleflow group place activations on one another.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The pattern that contains a <code>from</code> clause cannot be followed by another pattern starting with a parenthesis. The reason for this restriction is that the DRL parser reads the <code>from</code> expression as <code>"from $l (String() or Number())"</code> and it cannot differentiate this expression from a function call. The simplest workaround to this is to wrap the <code>from</code> clause in parentheses, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="title">Example rules with <code>from</code> used incorrectly and correctly</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">// Do not use `from` in this way:
rule R
  when
    $l : List()
    String() from $l
    (String() or Number())
  then
    // Actions
end

// Use `from` in this way instead:
rule R
  when
    $l : List()
    (String() from $l)
    (String() or Number())
  then
    // Actions
end</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>entry-point</code></dt>
<dd>
<p>Use this to define an entry point, or <em>event stream</em>, corresponding to a data source for the pattern. This element is typically used with the <code>from</code> condition element. You can declare an entry point for events so that the Drools rule engine uses data from only that entry point to evaluate the rules. You can declare an entry point either implicitly by referencing it in DRL rules or explicitly in your Java application.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example rule with <code>from entry-point</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Authorize withdrawal"
  when
    WithdrawRequest( $ai : accountId, $am : amount ) from entry-point "ATM Stream"
    CheckingAccount( accountId == $ai, balance &gt; $am )
  then
    // Authorize withdrawal.
end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example Java application code with EntryPoint object and inserted facts</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.kie.api.runtime.KieSession;
import org.kie.api.runtime.rule.EntryPoint;

// Create your KIE base and KIE session as usual:
KieSession session = ...

// Create a reference to the entry point:
EntryPoint atmStream = session.getEntryPoint("ATM Stream");

// Start inserting your facts into the entry point:
atmStream.insert(aWithdrawRequest);</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>collect</code></dt>
<dd>
<p>Use this to define a collection of objects that the rule can use as part of the condition. The rule obtains the collection either from a specified source or from the working memory of the Drools rule engine. The result pattern of the <code>collect</code> element can be any concrete class that implements the <code>java.util.Collection</code> interface and provides a default no-arg public constructor. You can use Java collections like <code>List</code>, <code>LinkedList</code>, and <code>HashSet</code>, or your own class. If variables are bound before the <code>collect</code> element in a condition, you can use the variables to constrain both your source and result patterns. However, any binding made inside the <code>collect</code> element is not available for use outside of it.</p>
<div class="openblock">
<div class="content">
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/collect.png" alt="collect">
</div>
<div class="title">Figure 22. Collect</div>
</div>
<div class="listingblock">
<div class="title">Example rule with <code>collect</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">import java.util.List

rule "Raise priority when system has more than three pending alarms"
  when
    $system : System()
    $alarms : List( size &gt;= 3 )
              from collect( Alarm( system == $system, status == 'pending' ) )
  then
    // Raise priority because `$system` has three or more `$alarms` pending.
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the rule assesses all pending alarms in the working memory of the Drools rule engine for each given system and groups them in a <code>List</code>. If three or more alarms are found for a given system, the rule is executed.</p>
</div>
<div class="paragraph">
<p>You can also use the <code>collect</code> element with nested <code>from</code> elements, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="title">Example rule with <code>collect</code> and nested <code>from</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">import java.util.LinkedList;

rule "Send a message to all parents"
  when
    $town : Town( name == 'Paris' )
    $mothers : LinkedList()
               from collect( Person( children &gt; 0 )
                             from $town.getPeople()
                           )
  then
    // Send a message to all parents.
end</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>accumulate</code></dt>
<dd>
<p>Use this to iterate over a collection of objects, execute custom actions for each of the elements, and return one or more result objects (if the constraints evaluate to <code>true</code>). This element is a more flexible and powerful form of the <code>collect</code> condition element. You can use predefined functions in your <code>accumulate</code> conditions or implement custom functions as needed. You can also use the abbreviation <code>acc</code> for <code>accumulate</code> in rule conditions.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Use the following format to define <code>accumulate</code> conditions in rules:</p>
</div>
<div class="listingblock">
<div class="title">Preferred format for <code>accumulate</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">accumulate( &lt;source pattern&gt;; &lt;functions&gt; [;&lt;constraints&gt;] )</code></pre>
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/accumulate.png" alt="accumulate">
</div>
<div class="title">Figure 23. Accumulate</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Although the Drools rule engine supports alternate formats for the <code>accumulate</code> element for backward compatibility, this format is preferred for optimal performance in rules and applications.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Drools rule engine supports the following predefined <code>accumulate</code> functions. These functions accept any expression as input.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>average</code></p>
</li>
<li>
<p><code>min</code></p>
</li>
<li>
<p><code>max</code></p>
</li>
<li>
<p><code>count</code></p>
</li>
<li>
<p><code>sum</code></p>
</li>
<li>
<p><code>collectList</code></p>
</li>
<li>
<p><code>collectSet</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the following example rule, <code>min</code>, <code>max</code>, and <code>average</code> are <code>accumulate</code> functions that calculate the minimum, maximum, and average temperature values over all the readings for each sensor:</p>
</div>
<div class="listingblock">
<div class="title">Example rule with <code>accumulate</code> to calculate temperature values</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Raise alarm"
  when
    $s : Sensor()
    accumulate( Reading( sensor == $s, $temp : temperature );
                $min : min( $temp ),
                $max : max( $temp ),
                $avg : average( $temp );
                $min &lt; 20, $avg &gt; 70 )
  then
    // Raise the alarm.
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example rule uses the <code>average</code> function with <code>accumulate</code> to calculate the average profit for all items in an order:</p>
</div>
<div class="listingblock">
<div class="title">Example rule with <code>accumulate</code> to calculate average profit</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Average profit"
  when
    $order : Order()
    accumulate( OrderItem( order == $order, $cost : cost, $price : price );
                $avgProfit : average( 1 - $cost / $price ) )
  then
    // Average profit for `$order` is `$avgProfit`.
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use custom, domain-specific functions in <code>accumulate</code> conditions, create a Java class that implements the <code>org.kie.api.runtime.rule.AccumulateFunction</code> interface. For example, the following Java class defines a custom implementation of an <code>AverageData</code> function:</p>
</div>
<div class="listingblock">
<div class="title">Example Java class with custom implementation of <code>average</code> function</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// An implementation of an accumulator capable of calculating average values

public class AverageAccumulateFunction implements org.kie.api.runtime.rule.AccumulateFunction&lt;AverageAccumulateFunction.AverageData&gt; {

    public void readExternal(ObjectInput in) throws IOException, ClassNotFoundException {

    }

    public void writeExternal(ObjectOutput out) throws IOException {

    }

    public static class AverageData implements Externalizable {
        public int    count = 0;
        public double total = 0;

        public AverageData() {}

        public void readExternal(ObjectInput in) throws IOException, ClassNotFoundException {
            count   = in.readInt();
            total   = in.readDouble();
        }

        public void writeExternal(ObjectOutput out) throws IOException {
            out.writeInt(count);
            out.writeDouble(total);
        }

    }

    /* (non-Javadoc)
     * @see org.kie.api.runtime.rule.AccumulateFunction#createContext()
     */
    public AverageData createContext() {
        return new AverageData();
    }

    /* (non-Javadoc)
     * @see org.kie.api.runtime.rule.AccumulateFunction#init(java.io.Serializable)
     */
    public void init(AverageData context) {
        context.count = 0;
        context.total = 0;
    }

    /* (non-Javadoc)
     * @see org.kie.api.runtime.rule.AccumulateFunction#accumulate(java.io.Serializable, java.lang.Object)
     */
    public void accumulate(AverageData context,
                           Object value) {
        context.count++;
        context.total += ((Number) value).doubleValue();
    }

    /* (non-Javadoc)
     * @see org.kie.api.runtime.rule.AccumulateFunction#reverse(java.io.Serializable, java.lang.Object)
     */
    public void reverse(AverageData context, Object value) {
        context.count--;
        context.total -= ((Number) value).doubleValue();
    }

    /* (non-Javadoc)
     * @see org.kie.api.runtime.rule.AccumulateFunction#getResult(java.io.Serializable)
     */
    public Object getResult(AverageData context) {
        return new Double( context.count == 0 ? 0 : context.total / context.count );
    }

    /* (non-Javadoc)
     * @see org.kie.api.runtime.rule.AccumulateFunction#supportsReverse()
     */
    public boolean supportsReverse() {
        return true;
    }

    /* (non-Javadoc)
     * @see org.kie.api.runtime.rule.AccumulateFunction#getResultType()
     */
    public Class&lt; ? &gt; getResultType() {
        return Number.class;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use the custom function in a DRL rule, import the function using the <code>import accumulate</code> statement:</p>
</div>
<div class="listingblock">
<div class="title">Format to import a custom function</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">import accumulate &lt;class_name&gt; &lt;function_name&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example rule with the imported <code>average</code> function</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">import accumulate AverageAccumulateFunction.AverageData average

rule "Average profit"
  when
    $order : Order()
    accumulate( OrderItem( order == $order, $cost : cost, $price : price );
                $avgProfit : average( 1 - $cost / $price ) )
  then
    // Average profit for `$order` is `$avgProfit`.
end</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For backward compatibility, the Drools rule engine also supports the configuration of <code>accumulate</code> functions through configuration files and system properties, but this is a deprecated method. To configure the <code>average</code> function from the previous example using the configuration file or system property, set a property as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">drools.accumulate.function.average = AverageAccumulateFunction.AverageData</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>drools.accumulate.function</code> is a required prefix, <code>average</code> is how the function is used in the DRL files, and <code>AverageAccumulateFunction.AverageData</code> is the fully qualified name of the class that implements the function behavior.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>accumulate</code> alternate syntax for a single function with return type</dt>
<dd>
<p>The accumulate syntax evolved over time with the goal of becoming more compact and expressive.
Nevertheless, Drools still supports previous syntaxes for backward compatibility purposes.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>In case the rule is using a single accumulate function on a given accumulate, the author may add a pattern for the result object and use the "from" keyword to link it to the accumulate result.</p>
</div>
<div class="paragraph">
<p>Example: a rule to apply a 10% discount on orders over $100 could be written in the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Apply 10% discount to orders over US$ 100,00"
when
    $order : Order()
    $total : Number( doubleValue &gt; 100 )
             from accumulate( OrderItem( order == $order, $value : value ),
                              sum( $value ) )
then
    // apply discount to $order
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the previous example, the accumulate element is using only one function (sum), and so, the rules author opted to explicitly write a pattern for the result type of the accumulate function (Number) and write the constraints inside it.
There are no problems in using this syntax over the compact syntax presented before, except that is is a bit more verbose.
Also note that it is not allowed to use both the return type and the functions binding in the same accumulate statement.</p>
</div>
<div class="paragraph">
<p>Compile-time checks are performed in order to ensure the pattern used with the "<code>from</code>" keyword is  assignable from the result of the accumulate function used.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>With this syntax, the "<code>from</code>" binds to the single result returned by the accumulate function, and it does not iterate.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the previous example, "<code>$total</code>" is bound to the result returned by the accumulate sum() function.</p>
</div>
<div class="paragraph">
<p>As another example however, if the result of the accumulate function is a collection, "<code>from</code>" still binds to the single result and it does not iterate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Person names"
when
  $x : Object() from accumulate(MyPerson( $val : name );
                                collectList( $val ) )
then
  // $x is a List
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>The bound "<code>$x : Object()</code>" is the List itself, returned by the collectList accumulate function used.</p>
</div>
<div class="paragraph">
<p>This is an important distinction to highlight, as the "<code>from</code>" keyword can also be used separately of accumulate, to iterate over the elements of a collection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Iterate the numbers"
when
    $xs : List()
    $x : Integer() from $xs
then
  // $x matches and binds to each Integer in the collection
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>While this syntax is still supported for backward compatibility purposes, for this and other reasons we encourage rule authors to make use instead of the preferred <code>accumulate</code> syntax (described previously), to avoid any potential pitfalls.</p>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>accumulate</code> with inline custom code</dt>
<dd>
<p>Another possible syntax for the <code>accumulate</code> is to define inline custom code, instead of using accumulate functions.</p>
<div class="openblock">
<div class="content">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The use of accumulate with inline custom code is not a good practice for several reasons, including difficulties on maintaining and testing rules that use them, as well as the inability of reusing that code.
Implementing your own accumulate functions is very simple and straightforward, they are easy to unit test and to use.
This form of accumulate is supported for backward compatibility only.</p>
</div>
<div class="paragraph">
<p>Only limited support for inline accumulate is provided while using the executable model.
For example, you cannot use an external binding in the code while using the MVEL dialect:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule R
dialect "mvel"
when
    String( $l : length )
    $sum : Integer() from accumulate (
                           Person( age &gt; 18, $age : age ),
                           init( int sum = 0 * $l; ),
                           action( sum += $age; ),
                           reverse( sum -= $age; ),
                           result( sum )
                     )</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The general syntax of the <code>accumulate</code> CE with inline custom code is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">&lt;result pattern&gt; from accumulate( &lt;source pattern&gt;,
                                  init( &lt;init code&gt; ),
                                  action( &lt;action code&gt; ),
                                  reverse( &lt;reverse code&gt; ),
                                  result( &lt;result expression&gt; ) )</code></pre>
</div>
</div>
<div class="paragraph">
<p>The meaning of each of the elements is the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>&lt;source pattern&gt;</em>: the source pattern is a regular pattern that the Drools rule engine will try to match against each of the source objects.</p>
</li>
<li>
<p><em>&lt;init code&gt;</em>: this is a semantic block of code in the selected dialect that will be executed once for each tuple, before iterating over the source objects.</p>
</li>
<li>
<p><em>&lt;action code&gt;</em>: this is a semantic block of code in the selected dialect that will be executed for each of the source objects.</p>
</li>
<li>
<p><em>&lt;reverse code&gt;</em>: this is an optional semantic block of code in the selected dialect that if present will be executed for each source object that no longer matches the source pattern. The objective of this code block is to undo any calculation done in the <em>&lt;action code&gt;</em> block, so that the Drools rule engine can do decremental calculation when a source object is modified or deleted, hugely improving performance of these operations.</p>
</li>
<li>
<p><em>&lt;result expression&gt;</em>: this is a semantic expression in the selected dialect that is executed after all source objects are iterated.</p>
</li>
<li>
<p><em>&lt;result pattern&gt;</em>: this is a regular pattern that the Drools rule engine tries to match against the object returned from the <em>&lt;result expression&gt;</em>. If it matches, the <code>accumulate</code> conditional element evaluates to <em>true</em> and the Drools rule engine proceeds with the evaluation of the next CE in the rule. If it does not matches, the <code>accumulate</code> CE evaluates to <em>false</em> and the Drools rule engine stops evaluating CEs for that rule.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is easier to understand if we look at an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Apply 10% discount to orders over US$ 100,00"
when
    $order : Order()
    $total : Number( doubleValue &gt; 100 )
             from accumulate( OrderItem( order == $order, $value : value ),
                              init( double total = 0; ),
                              action( total += $value; ),
                              reverse( total -= $value; ),
                              result( total ) )
then
    // apply discount to $order
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the previous example, for each <code>Order</code> in the Working Memory, the Drools rule engine will execute the <em>init
          code</em> initializing the total variable to zero.
Then it will iterate over all <code>OrderItem</code> objects for that order, executing the <em>action</em> for each one (in the example, it will sum the value of all items into the total variable). After iterating over all <code>OrderItem</code> objects, it will return the value corresponding to the <em>result
          expression</em> (in the previous example, the value of variable <code>total</code>). Finally, the Drools rule engine will try to match the result with the <code>Number</code> pattern, and if the double value is greater than 100, the rule will fire.</p>
</div>
<div class="paragraph">
<p>The example used Java as the semantic dialect, and as such, note that the usage of the semicolon as statement delimiter is mandatory in the init, action and reverse code blocks.
The result is an expression and, as such, it does not admit ';'. If the user uses any other dialect, he must comply to that dialect&#8217;s specific syntax.</p>
</div>
<div class="paragraph">
<p>As mentioned before, the <em>reverse code</em> is optional, but it is strongly recommended that the user writes it in order to benefit from the <em>improved performance on update
          and delete</em>.</p>
</div>
<div class="paragraph">
<p>The <code>accumulate</code> CE can be used to execute any action on source objects.
The following example instantiates and populates a custom object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Accumulate using custom objects"
when
    $person   : Person( $likes : likes )
    $cheesery : Cheesery( totalAmount &gt; 100 )
                from accumulate( $cheese : Cheese( type == $likes ),
                                 init( Cheesery cheesery = new Cheesery(); ),
                                 action( cheesery.addCheese( $cheese ); ),
                                 reverse( cheesery.removeCheese( $cheese ); ),
                                 result( cheesery ) );
then
    // do something
end</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>eval</code></dt>
<dd>
<p>The conditional element <code>eval</code> is essentially a catch-all which allows any semantic code (that returns a primitive boolean) to be executed.
This code can refer to variables that were bound in the conditions of the rule and functions in the rule package.
Overuse of <code>eval</code> reduces the declarativeness of your rules and can result in a poorly performing Drools rule engine.
While <code>eval</code> can be used anywhere in the patterns, it is typically added as the last conditional element in the conditions of a rule.</p>
<div class="openblock">
<div class="content">
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/eval.png" alt="eval">
</div>
<div class="title">Figure 24. Eval</div>
</div>
<div class="paragraph">
<p>Instances of <code>eval</code> cannot be indexed and thus are not as efficient as Field Constraints.
However this makes them ideal for being used when functions return values that change over time, which is not allowed within Field Constraints.</p>
</div>
<div class="paragraph">
<p>For those who are familiar with Drools 2.x lineage, the old Drools parameter and condition tags are equivalent to binding a variable to an appropriate type, and then using it in an <code>eval</code> node.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">p1 : Parameter()
p2 : Parameter()
eval( p1.getList().containsKey( p2.getItem() ) )</code></pre>
</div>
</div>
<div class="paragraph">
<p></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">p1 : Parameter()
p2 : Parameter()
// call function isValid in the LHS
eval( isValid( p1, p2 ) )</code></pre>
</div>
</div>
</div>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="drl-rules-THEN-con_drl-rules-traditional"><a class="anchor" href="#drl-rules-THEN-con_drl-rules-traditional"></a>Rule actions in DRL (THEN)</h3>
<div class="paragraph">
<p>The <code>then</code> part of the rule (also known as the <em>Right Hand Side (RHS)</em> of the rule) contains the actions to be performed when the conditional part of the rule has been met. Actions consist of one or more <em>methods</em> that execute consequences based on the rule conditions and on available data objects in the package. For example, if a bank requires loan applicants to be over 21 years of age (with a rule condition <code>Applicant( age &lt; 21 )</code>) and a loan applicant is under 21 years old, the <code>then</code> action of an <code>"Underage"</code> rule would be <code>setApproved( false )</code>, declining the loan because the applicant is under age.</p>
</div>
<div class="paragraph">
<p>The main purpose of rule actions is to insert, delete, or modify data in the working memory of the Drools rule engine. Effective rule actions are small, declarative, and readable. If you need to use imperative or conditional code in rule actions, then divide the rule into multiple smaller and more declarative rules.</p>
</div>
<div class="listingblock">
<div class="title">Example rule for loan application age limit</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Underage"
  when
    application : LoanApplication()
    Applicant( age &lt; 21 )
  then
    application.setApproved( false );
    application.setExplanation( "Underage" );
end</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="drl-rules-THEN-methods-ref_drl-rules-traditional"><a class="anchor" href="#drl-rules-THEN-methods-ref_drl-rules-traditional"></a>Supported rule action methods in DRL</h4>
<div class="paragraph">
<p>DRL supports the following rule action methods that you can use in DRL rule actions. You can use these methods to modify the working memory of the Drools rule engine without having to first reference a working memory instance. These methods act as shortcuts to the methods provided by the <code>RuleContext</code> class in your Drools distribution.</p>
</div>
<div class="paragraph">
<p>For all rule action methods,
see the Drools <a href="https://github.com/apache/incubator-kie-drools/blob/10.1.x/kie-api/src/main/java/org/kie/api/runtime/rule/RuleContext.java">RuleContext.java</a> page in GitHub.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>set</code></dt>
<dd>
<p>Use this to set the value of a field.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">set&lt;field&gt; ( &lt;value&gt; )</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example rule action to set the values of a loan application approval</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$application.setApproved ( false );
$application.setExplanation( "has been bankrupt" );</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>modify</code></dt>
<dd>
<p>Use this to specify fields to be modified for a fact and to notify the Drools rule engine of the change. This method provides a structured approach to fact updates. It combines the <code>update</code> operation with setter calls to change object fields.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">modify ( &lt;fact-expression&gt; ) {
    &lt;expression&gt;,
    &lt;expression&gt;,
    ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example rule action to modify a loan application amount and approval</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">modify( LoanApplication ) {
        setAmount( 100 ),
        setApproved ( true )
}</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>update</code></dt>
<dd>
<p>Use this to specify fields and the entire related fact to be updated and to notify the Drools rule engine of the change. After a fact has changed, you must call <code>update</code> before changing another fact that might be affected by the updated values. To avoid this added step, use the <code>modify</code> method instead.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">update ( &lt;object, &lt;handle&gt; )  // Informs the Drools rule engine that an object has changed

update ( &lt;object&gt; )  // Causes `KieSession` to search for a fact handle of the object</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example rule action to update a loan application amount and approval</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">LoanApplication.setAmount( 100 );
update( LoanApplication );</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you provide property-change listeners, you do not need to call this method when an object changes. For more information about property-change listeners, see
<a href="#property-change-listeners-con_decision-engine">[property-change-listeners-con_decision-engine]</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>insert</code></dt>
<dd>
<p>Use this to insert a <code>new</code> fact into the working memory of the Drools rule engine and to define resulting fields and values as needed for the fact.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">insert( new &lt;object&gt; );</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example rule action to insert a new loan applicant object</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">insert( new Applicant() );</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>insertLogical</code></dt>
<dd>
<p>Use this to insert a <code>new</code> fact logically into the Drools rule engine. The Drools rule engine is responsible for logical decisions on insertions and retractions of facts. After regular or stated insertions, facts must be retracted explicitly. After logical insertions, the facts that were inserted are automatically retracted when the conditions in the rules that inserted the facts are no longer true.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">insertLogical( new &lt;object&gt; );</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example rule action to logically insert a new loan applicant object</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">insertLogical( new Applicant() );</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>delete</code></dt>
<dd>
<p>Use this to remove an object from the Drools rule engine. The keyword <code>retract</code> is also supported in DRL and executes the same action, but <code>delete</code> is typically preferred in DRL code for consistency with the keyword <code>insert</code>.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">delete( &lt;object&gt; );</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example rule action to delete a loan applicant object</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">delete( Applicant );</code></pre>
</div>
</div>
</div>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="drl-rules-THEN-methods-variables-ref_drl-rules-traditional"><a class="anchor" href="#drl-rules-THEN-methods-variables-ref_drl-rules-traditional"></a>Other rule action methods from <code>drools</code> variable</h4>
<div class="paragraph">
<p>In addition to the standard rule action methods, the Drools rule engine supports methods in conjunction with the predefined <code>drools</code> variable that you can also use in rule actions.</p>
</div>
<div class="paragraph">
<p>You can use the <code>drools</code> variable to call methods from the <code>org.kie.api.runtime.rule.RuleContext</code> class in your Drools distribution, which is also the class that the standard rule action methods are based on. For all <code>drools</code> rule action options,
see the Drools <a href="https://github.com/apache/incubator-kie-drools/blob/10.1.x/kie-api/src/main/java/org/kie/api/runtime/rule/RuleContext.java">RuleContext.java</a> page in GitHub.</p>
</div>
<div class="paragraph">
<p>The <code>drools</code> variable contains methods that provide information about the firing rule and the set of facts that activated the firing rule:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>drools.getRule().getName()</code>: Returns the name of the currently firing rule.</p>
</li>
<li>
<p><code>drools.getMatch()</code>: Returns the <code>Match</code> that activated the currently firing rule. It contains information that is useful for logging and debugging purposes, for instance <code>drools.getMatch().getObjects()</code> returns the list of objects, enabling rule to fire in the proper tuple order.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>From the <code>drools</code> variable, you can also obtain a reference to the <code>KieRuntime</code> providing useful methods to interact with the running session, for example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>drools.getKieRuntime().halt()</code>: Terminates rule execution if a user or application previously called <code>fireUntilHalt()</code>. When a user or application calls <code>fireUntilHalt()</code> method, the Drools rule engine starts in <code>active</code> mode and evaluates rules until the user or application explicitly calls <code>halt()</code> method. Otherwise, by default, the Drools rule engine runs in <code>passive</code> mode and evaluates rules only when a user or an application explicitly calls <code>fireAllRules()</code> method.</p>
</li>
<li>
<p><code>drools.getKieRuntime().getAgenda()</code>: Returns a reference to the KIE session <code>Agenda</code>, and in turn provides access to rule activation groups, rule agenda groups, and ruleflow groups.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example call to access agenda group "CleanUp" and set the focus</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">drools.getKieRuntime().getAgenda().getAgendaGroup( "CleanUp" ).setFocus();</code></pre>
</div>
</div>
<div class="paragraph">
<p>+
This example sets the focus to a specified agenda group to which the rule belongs.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>drools.getKieRuntime().setGlobal()</code>, <code>~.getGlobal()</code>, <code>~.getGlobals()</code>: Sets or retrieves global variables.</p>
</li>
<li>
<p><code>drools.getKieRuntime().getEnvironment()</code>: Returns the runtime <code>Environment</code>, similar to your operating system environment.</p>
</li>
<li>
<p><code>drools.getKieRuntime().getQueryResults(&lt;string&gt; query)</code>: Runs a query and returns the results.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="drl-rules-THEN-advanced-con_drl-rules-traditional"><a class="anchor" href="#drl-rules-THEN-advanced-con_drl-rules-traditional"></a>Advanced rule actions with conditional and named consequences</h4>
<div class="paragraph">
<p>In general, effective rule actions are small, declarative, and readable. However, in some cases, the limitation of having a single consequence for each rule can be challenging and lead to verbose and repetitive rule syntax, as shown in the following example rules:</p>
</div>
<div class="listingblock">
<div class="title">Example rules with verbose and repetitive syntax</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Give 10% discount to customers older than 60"
  when
    $customer : Customer( age &gt; 60 )
  then
    modify($customer) { setDiscount( 0.1 ) };
end

rule "Give free parking to customers older than 60"
  when
    $customer : Customer( age &gt; 60 )
    $car : Car( owner == $customer )
  then
    modify($car) { setFreeParking( true ) };
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>A partial solution to the repetition is to make the second rule extend the first rule, as shown in the following modified example:</p>
</div>
<div class="listingblock">
<div class="title">Partially enhanced example rules with an extended condition</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Give 10% discount to customers older than 60"
  when
    $customer : Customer( age &gt; 60 )
  then
    modify($customer) { setDiscount( 0.1 ) };
end

rule "Give free parking to customers older than 60"
    extends "Give 10% discount to customers older than 60"
  when
    $car : Car( owner == $customer )
  then
    modify($car) { setFreeParking( true ) };
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>As a more efficient alternative, you can consolidate the two rules into a single rule with modified conditions and labelled corresponding rule actions, as shown in the following consolidated example:</p>
</div>
<div class="listingblock">
<div class="title">Consolidated example rule with conditional and named consequences</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Give 10% discount and free parking to customers older than 60"
  when
    $customer : Customer( age &gt; 60 )
    do[giveDiscount]
    $car : Car( owner == $customer )
  then
    modify($car) { setFreeParking( true ) };
  then[giveDiscount]
    modify($customer) { setDiscount( 0.1 ) };
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example rule uses two actions: the usual default action and another action named <code>giveDiscount</code>. The <code>giveDiscount</code> action is activated in the condition with the keyword <code>do</code> when a customer older than 60 years old is found in the KIE base, regardless of whether or not the customer owns a car.</p>
</div>
<div class="paragraph">
<p>You can configure the activation of a named consequence with an additional condition, such as the <code>if</code> statement in the following example. The condition in the <code>if</code> statement is always evaluated on the pattern that immediately precedes it.</p>
</div>
<div class="listingblock">
<div class="title">Consolidated example rule with an additional condition</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Give free parking to customers older than 60 and 10% discount to golden ones among them"
  when
    $customer : Customer( age &gt; 60 )
    if ( type == "Golden" ) do[giveDiscount]
    $car : Car( owner == $customer )
  then
    modify($car) { setFreeParking( true ) };
  then[giveDiscount]
    modify($customer) { setDiscount( 0.1 ) };
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also evaluate different rule conditions using a nested <code>if</code> and <code>else if</code> construct, as shown in the following more complex example:</p>
</div>
<div class="listingblock">
<div class="title">Consolidated example rule with more complex conditions</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Give free parking and 10% discount to over 60 Golden customer and 5% to Silver ones"
  when
    $customer : Customer( age &gt; 60 )
    if ( type == "Golden" ) do[giveDiscount10]
    else if ( type == "Silver" ) break[giveDiscount5]
    $car : Car( owner == $customer )
  then
    modify($car) { setFreeParking( true ) };
  then[giveDiscount10]
    modify($customer) { setDiscount( 0.1 ) };
  then[giveDiscount5]
    modify($customer) { setDiscount( 0.05 ) };
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example rule gives a 10% discount and free parking to Golden customers over 60, but only a 5% discount without free parking to Silver customers. The rule activates the consequence named <code>giveDiscount5</code> with the keyword <code>break</code> instead of <code>do</code>. The keyword <code>do</code> schedules a consequence in the Drools rule engine agenda, enabling the remaining part of the rule conditions to continue being evaluated, while <code>break</code> blocks any further condition evaluation. If a named consequence does not correspond to any condition with <code>do</code> but is activated with <code>break</code>, the rule fails to compile because the conditional part of the rule is never reached.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="drl-rules-comments-con_drl-rules-traditional"><a class="anchor" href="#drl-rules-comments-con_drl-rules-traditional"></a>Comments in DRL files</h3>
<div class="paragraph">
<p>DRL supports single-line comments prefixed with a double forward slash <code>//</code> and multi-line comments enclosed with a forward slash and asterisk <code>/* &#8230;&#8203; */</code>. You can use DRL comments to annotate rules or any related components in DRL files. DRL comments are ignored by the Drools rule engine when the DRL file is processed.</p>
</div>
<div class="listingblock">
<div class="title">Example rule with comments</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Underage"
  // This is a single-line comment.
  when
    $application : LoanApplication()  // This is an in-line comment.
    Applicant( age &lt; 21 )
  then
    /* This is a multi-line comment
    in the rule actions. */
    $application.setApproved( false );
    $application.setExplanation( "Underage" );
end</code></pre>
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/multi_line_comment.png" alt="multi line comment">
</div>
<div class="title">Figure 25. Multi-line comment</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The hash symbol <code>#</code> is not supported for DRL comments.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="drl-rules-errors-ref_drl-rules-traditional"><a class="anchor" href="#drl-rules-errors-ref_drl-rules-traditional"></a>Error messages for DRL troubleshooting</h3>
<div class="paragraph">
<p>Drools provides standardized messages for DRL errors to help you troubleshoot and resolve problems in your DRL files. The error messages use the following format:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/language-reference/error_message.png" alt="error message">
</div>
<div class="title">Figure 26. Error message format for DRL file problems</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>1st Block:</strong> Error code</p>
</li>
<li>
<p><strong>2nd Block:</strong> Line and column in the DRL source where the error occurred</p>
</li>
<li>
<p><strong>3rd Block:</strong> Description of the problem</p>
</li>
<li>
<p><strong>4th Block:</strong> Component in the DRL source (rule, function, query) where the error occurred</p>
</li>
<li>
<p><strong>5th Block:</strong> Pattern in the DRL source where the error occurred (if applicable)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Drools supports the following standardized error messages:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">101: no viable alternative</dt>
<dd>
<p>Indicates that the parser reached a decision point but could not identify an alternative.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example rule with incorrect spelling</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">1: rule "simple rule"
2:   when
3:     exists Person()
4:     exits Student()  // Must be `exists`
5:   then
6: end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Error message</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[ERR 101] Line 4:4 no viable alternative at input 'exits' in rule "simple rule"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example rule without a rule name</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">1: package org.drools.examples;
2: rule    // Must be `rule "rule name"` (or `rule rule_name` if no spacing)
3:   when
4:     Object()
5:   then
6:     System.out.println("A RHS");
7: end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Error message</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[ERR 101] Line 3:2 no viable alternative at input 'when'</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the parser encountered the keyword <code>when</code> but expected the rule name, so it flags <code>when</code> as the incorrect expected token.</p>
</div>
<div class="listingblock">
<div class="title">Example rule with incorrect syntax</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">1: rule "simple rule"
2:   when
3:     Student( name == "Andy )  // Must be `"Andy"`
4:   then
5: end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Error message</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[ERR 101] Line 0:-1 no viable alternative at input '&lt;eof&gt;' in rule "simple rule" in pattern Student</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A line and column value of <code>0:-1</code> means the parser reached the end of the source file (<code>&lt;eof&gt;</code>) but encountered incomplete constructs, usually due to missing quotation marks <code>"&#8230;&#8203;"</code>, apostrophes <code>'&#8230;&#8203;'</code>, or parentheses <code>(&#8230;&#8203;)</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">102: mismatched input</dt>
<dd>
<p>Indicates that the parser expected a particular symbol that is missing at the current input position.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example rule with an incomplete rule statement</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">1: rule simple_rule
2:   when
3:     $p : Person(
        // Must be a complete rule statement</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Error message</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[ERR 102] Line 0:-1 mismatched input '&lt;eof&gt;' expecting ')' in rule "simple rule" in pattern Person</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A line and column value of <code>0:-1</code> means the parser reached the end of the source file (<code>&lt;eof&gt;</code>) but encountered incomplete constructs, usually due to missing quotation marks <code>"&#8230;&#8203;"</code>, apostrophes <code>'&#8230;&#8203;'</code>, or parentheses <code>(&#8230;&#8203;)</code>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example rule with incorrect syntax</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">1: package org.drools.examples;
2:
3: rule "Wrong syntax"
4:   when
5:     not( Car( ( type == "tesla", price == 10000 ) || ( type == "kia", price == 1000 ) ) from $carList )
       // Must use `&amp;&amp;` operators instead of commas `,`
6:   then
7:     System.out.println("OK");
8: end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Error messages</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[ERR 102] Line 5:36 mismatched input ',' expecting ')' in rule "Wrong syntax" in pattern Car
[ERR 101] Line 5:57 no viable alternative at input 'type' in rule "Wrong syntax"
[ERR 102] Line 5:106 mismatched input ')' expecting 'then' in rule "Wrong syntax"</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the syntactic problem results in multiple error messages related to each other. The single solution of replacing the commas <code>,</code> with <code>&amp;&amp;</code> operators resolves all errors. If you encounter multiple errors, resolve one at a time in case errors are consequences of previous errors.</p>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">103: failed predicate</dt>
<dd>
<p>Indicates that a validating semantic predicate evaluated to <code>false</code>. These semantic predicates are typically used to identify component keywords in DRL files, such as <code>declare</code>, <code>rule</code>, <code>exists</code>, <code>not</code>, and others.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example rule with an invalid keyword</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"> 1: package nesting;
 2:
 3: import org.drools.compiler.Person
 4: import org.drools.compiler.Address
 5:
 6: Some text  // Must be a valid DRL keyword
 7:
 8: rule "test something"
 9:   when
10:     $p: Person( name=="Michael" )
11:   then
12:     $p.name = "other";
13:     System.out.println(p.name);
14: end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Error message</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[ERR 103] Line 6:0 rule 'rule_key' failed predicate: {(validateIdentifierKey(DroolsSoftKeywords.RULE))}? in rule</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Some text</code> line is invalid because it does not begin with or is not a part of a DRL keyword construct, so the parser fails to validate the rest of the DRL file.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This error is similar to <code>102: mismatched input</code>, but usually involves DRL keywords.
</td>
</tr>
</table>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">104: trailing semi-colon not allowed</dt>
<dd>
<p>Indicates that an <code>eval()</code> clause in a rule condition uses a semicolon <code>;</code> but must not use one.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example rule with <code>eval()</code> and trailing semicolon</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">1: rule "simple rule"
2:   when
3:     eval( abc(); )  // Must not use semicolon `;`
4:   then
5: end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Error message</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[ERR 104] Line 3:4 trailing semi-colon not allowed in rule "simple rule"</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">105: did not match anything</dt>
<dd>
<p>Indicates that the parser reached a sub-rule in the grammar that must match an alternative at least once, but the sub-rule did not match anything. The parser has entered a branch with no way out.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example rule with invalid text in an empty condition</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">1: rule "empty condition"
2:   when
3:     None  // Must remove `None` if condition is empty
4:   then
5:      insert( new Person() );
6: end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Error message</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[ERR 105] Line 2:2 required (...)+ loop did not match anything at input 'WHEN' in rule "empty condition"</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the condition is intended to be empty but the word <code>None</code> is used. This error is resolved by removing <code>None</code>, which is not a valid DRL keyword, data type, or pattern construct.</p>
</div>
</div>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_domain_specific_languages"><a class="anchor" href="#_domain_specific_languages"></a>Domain Specific Languages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>
Domain Specific Languages (or DSLs) are a way of creating a rule language that is dedicated to your problem domain.
A set of DSL definitions consists of transformations from DSL "sentences" to DRL constructs, which lets you use of all the underlying rule language and engine features.
Given a DSL, you write rules in DSL rule (or DSLR) files, which will be translated into DRL files.</p>
</div>
<div class="paragraph">
<p>DSL and DSLR files are plain text files, and you can use any text editor to create and modify them.
But there are also DSL and DSLR editors, both in the IDE as well as in the web based BRMS, and you can use those as well, although they may not provide you with the full DSL functionality.</p>
</div>
<div class="sect2">
<h3 id="_when_to_use_a_dsl"><a class="anchor" href="#_when_to_use_a_dsl"></a>When to Use a DSL</h3>
<div class="paragraph">
<p>DSLs can serve as a layer of separation between rule authoring (and rule authors) and the technical intricacies resulting from the modelling of domain object and the Drools rule engine&#8217;s native language and methods.
If your rules need to be read and validated by domain experts (such as business analysts, for instance) who are not programmers, you should consider  using a DSL; it hides implementation details and focuses on the rule logic proper.
DSL sentences can also act as "templates" for conditional elements and consequence actions that are used repeatedly in your rules, possibly with minor variations.
You may define DSL sentences as being mapped to these repeated phrases, with parameters providing a means for accommodating those variations.</p>
</div>
<div class="paragraph">
<p>DSLs have no impact on the Drools rule engine at runtime, they are just a compile time feature, requiring a special parser and transformer.</p>
</div>
</div>
<div class="sect2">
<h3 id="_dsl_basics"><a class="anchor" href="#_dsl_basics"></a>DSL Basics</h3>
<div class="paragraph">
<p>The Drools DSL mechanism allows you to customise conditional expressions and consequence actions.
A global substitution mechanism ("keyword") is also available.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Example  DSL mapping</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[when]Something is {colour}=Something(colour=="{colour}")</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In the preceding example, <code>[when]</code> indicates the scope of the expression, i.e., whether it is valid for the LHS or the RHS of a rule.
The part after the bracketed keyword is the expression that you use in the rule; typically a natural language expression, but it doesn&#8217;t have to be.
The part to the right of the equal sign ("=") is the mapping of the expression into the rule language.
The form of this string depends on its destination, RHS or  LHS.
If it is for the LHS, then it ought to be a term according to the regular LHS syntax; if it is for the RHS then it might be a Java statement.</p>
</div>
<div class="paragraph">
<p>Whenever the DSL parser matches a line from the rule file written in the DSL with an expression in the DSL definition, it performs three steps of string manipulation.
First, it extracts the string values appearing where the expression contains variable names in braces (here: <code>{colour}</code>). Then, the values obtained from these captures are then interpolated wherever that name, again enclosed in braces, occurs on the right hand side of the mapping.
Finally, the interpolated string replaces whatever was matched by the entire expression in the line of the DSL rule file.</p>
</div>
<div class="paragraph">
<p>Note that the expressions (i.e., the strings on the left hand side of the equal sign) are used as regular expressions in a pattern matching operation against a line of the DSL rule file, matching all or part of a line.
This means you can use (for instance) a '?' to indicate that the preceding character is optional.
One good reason to use this is to overcome variations in natural language phrases of your DSL.
But, given that these expressions are regular expression patterns, this also means that all "magic" characters of Java&#8217;s pattern syntax have to be escaped with a preceding backslash ('\').</p>
</div>
<div class="paragraph">
<p>It is important to note that the compiler transforms DSL rule files line by line.
In the previous example, all the text after "Something is " to the end of the line is captured as the replacement value for "{colour}", and this is used for interpolating the target string.
This may not be exactly what you want.
For instance, when you intend to merge different DSL expressions to generate a composite DRL pattern, you need to transform a DSLR line in several independent operations.
The best way to achieve this is to ensure that the captures are surrounded by characteristic text - words or  even single characters.
As a result, the matching operation done by the parser plucks out a substring from  somewhere within the line.
In the example below, quotes are used as  distinctive characters.
Note that the characters that surround the capture are not included during interpolation, just the contents between them.</p>
</div>
<div class="paragraph">
<p>As a rule of thumb, use quotes for textual data that a rule editor may want to enter.
You can also enclose the capture with words to ensure that the text is correctly matched.
Both is illustrated by the following example.
Note that a single line such as <code>Something is "green" and
    another solid thing</code> is now correctly expanded.</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. Example with quotes</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[when]something is "{colour}"=Something(colour=="{colour}")
[when]another {state} thing=OtherThing(state=="{state})"</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It is a good idea to avoid punctuation (other than quotes or apostrophes) in your DSL expressions as much as possible.
The main reason is that punctuation is easy to forget for rule authors using your DSL.
Another reason is that parentheses, the period and the question mark are magic characters, requiring escaping in the DSL definition.</p>
</div>
<div class="paragraph">
<p>In a DSL mapping, the braces "{" and "}" should only be used to enclose a variable definition or reference, resulting in a capture.
If they should occur literally, either in the expression or within the replacement text on the right hand side, they must be escaped with a preceding backslash ("\"):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[then]do something= if (foo) \{ doSomething(); \}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If braces "{" and "}" should appear in the replacement string of a DSL definition, escape them with a backslash ('\').</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 3. Examples of DSL mapping entries</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># This is a comment to be ignored.
[when]There is a person with name of "{name}"=Person(name=="{name}")
[when]Person is at least {age} years old and lives in "{location}"=
      Person(age &gt;= {age}, location=="{location}")
[then]Log "{message}"=System.out.println("{message}");
[when]And = and</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Given the above DSL examples, the following examples show the expansion of various DSLR snippets:</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. Examples of DSL expansions</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">There is a person with name of "Kitty"
   ==&gt; Person(name="Kitty")
Person is at least 42 years old and lives in "Atlanta"
   ==&gt; Person(age &gt;= 42, location="Atlanta")
Log "boo"
   ==&gt; System.out.println("boo");
There is a person with name of "Bob" And Person is at least 30 years old and lives in "Utah"
   ==&gt; Person(name="Bob") and Person(age &gt;= 30, location="Utah")</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Don&#8217;t forget that if you are capturing plain text from a DSL rule line and want to use it as a string literal in the expansion, you must provide the quotes on the right hand side of the mapping.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can chain DSL expressions together on one line, as long as it is clear to the parser where one ends and the next one begins and where the text representing a parameter ends.
(Otherwise you risk getting all the text until the end of the line as a parameter value.) The DSL expressions are tried, one after the other, according to their order in the DSL definition file.
After any match, all remaining DSL expressions are investigated, too.</p>
</div>
<div class="paragraph">
<p>The resulting DRL text may consist of more than one line.
Line ends are in the replacement text are written as <code>\n</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_adding_constraints_to_facts"><a class="anchor" href="#_adding_constraints_to_facts"></a>Adding Constraints to Facts</h3>
<div class="paragraph">
<p>A common requirement when writing rule conditions is to be able to add an arbitrary combination of constraints to a pattern.
Given that a fact type may have many fields, having to provide an individual DSL statement for each combination would be plain folly.</p>
</div>
<div class="paragraph">
<p>The DSL facility allows you to add constraints to a pattern by a simple convention: if your DSL expression starts with a hyphen (minus character, "-") it is assumed to be a field constraint and, consequently, is is added to the last pattern line preceding it.</p>
</div>
<div class="paragraph">
<p>For an example, lets take look at class <code>Cheese</code>, with the following fields: type, price, age and country.
We can express some LHS condition in normal DRL like the following</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Cheese(age &lt; 5, price == 20, type=="stilton", country=="ch")</code></pre>
</div>
</div>
<div class="paragraph">
<p>The DSL definitions given below result in three DSL phrases which may be used to create any combination of constraint involving these fields.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[when]There is a Cheese with=Cheese()
[when]- age is less than {age}=age&lt;{age}
[when]- type is '{type}'=type=='{type}'
[when]- country equal to '{country}'=country=='{country}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then write rules with conditions like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">There is a Cheese with
        - age is less than 42
        - type is 'stilton'</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre> The parser will pick up a line beginning with "-" and add it as a constraint to  the preceding pattern, inserting a comma when it is required.
For the preceding example, the resulting DRL is:</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Cheese(age&lt;42, type=='stilton')</code></pre>
</div>
</div>
<div class="paragraph">
<p>Combining all numeric fields with all relational operators (according to the DSL expression "age is less than&#8230;&#8203;" in the preceding example) produces an unwieldy amount of DSL entries.
But you can define DSL phrases for the various operators and even a generic expression that handles any field constraint, as shown below.
(Notice that the expression definition contains a regular expression in addition to the variable name.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[when][]is less than or equal to=&lt;=
[when][]is less than=&lt;
[when][]is greater than or equal to=&gt;=
[when][]is greater than=&gt;
[when][]is equal to===
[when][]equals===
[when][]There is a Cheese with=Cheese()
[when][]- {field:\w*} {operator} {value:\d*}={field} {operator} {value}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Given these DSL definitions, you can write rules with conditions such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">There is a Cheese with
   - age is less than 42
   - rating is greater than 50
   - type equals 'stilton'</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this specific case, a phrase such as "is less than" is replaced by <code>&lt;</code>, and then the line matches the last DSL entry.
This removes the hyphen, but the final result is still added as a constraint to the preceding pattern.
After processing all of the lines, the resulting DRL text is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Cheese(age&lt;42, rating &gt; 50, type=='stilton')</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The order of the entries in the DSL is important if separate DSL expressions are intended to match the same line, one after the other.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_developing_a_dsl"><a class="anchor" href="#_developing_a_dsl"></a>Developing a DSL</h3>
<div class="paragraph">
<p>A good way to get started is to write representative samples of the rules your application requires, and to test them as you develop.
This will provide you with a stable framework of conditional elements and their constraints.
Rules, both in DRL and in DSLR, refer to entities according to the data model representing the application data that should be subject to the reasoning process defined in rules.
Notice that writing rules is generally easier if most of the data model&#8217;s types are facts.</p>
</div>
<div class="paragraph">
<p>Given an initial set of rules, it should be possible to identify recurring or similar code snippets and to mark variable parts as parameters.
This provides reliable leads as to what might be a handy DSL entry.
Also, make sure you have a full grasp of the jargon the  domain experts are using, and base your DSL phrases on this vocabulary.</p>
</div>
<div class="paragraph">
<p>You may postpone implementation decisions concerning conditions and actions during this first design phase by leaving certain conditional elements and actions in their DRL form by prefixing a line with a greater sign ("&gt;"). (This is also handy for inserting debugging statements.)</p>
</div>
<div class="paragraph">
<p>During the next development phase, you should find that the DSL configuration stabilizes pretty quickly.
New rules can be written by reusing the existing DSL definitions, or by adding a parameter to an existing condition or consequence entry.</p>
</div>
<div class="paragraph">
<p>Try to keep the number of DSL entries small.
Using parameters lets you apply the same DSL sentence for similar rule patterns or constraints.
But do not exaggerate: authors using the DSL should still be able to identify DSL phrases by some fixed text.</p>
</div>
</div>
<div class="sect2">
<h3 id="_dsl_and_dslr_reference"><a class="anchor" href="#_dsl_and_dslr_reference"></a>DSL and DSLR Reference</h3>
<div class="paragraph">
<p>A DSL file is a text file in a line-oriented format.
Its entries are used for transforming a DSLR file into a file according to DRL syntax.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A line starting with "<mark>" or "//" (with or without preceding white space) is treated as a comment. A comment line starting with "</mark>/" is scanned for words requesting a debug option, see below.</p>
</li>
<li>
<p>Any line starting with an opening bracket ("[") is assumed to be the first line of a DSL entry definition.</p>
</li>
<li>
<p>Any other line is appended to the preceding DSL entry definition, with the line end replaced by a space.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A DSL entry consists of the following four parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A scope definition, written as one of the keywords "when" or "condition", "then" or "consequence", "*" and "keyword", enclosed in brackets ("[" and "]"). This indicates whether the DSL entry is valid for the condition or the consequence of a rule, or both. A scope indication of "keyword" means that the entry has global significance, i.e., it is recognized anywhere in a DSLR file.</p>
</li>
<li>
<p>A type definition, written as a Java class name, enclosed in brackets. This part is optional unless the next part begins with an opening bracket. An empty pair of brackets is valid, too.</p>
</li>
<li>
<p>A DSL expression consists of a (Java) regular expression, with any number of embedded <em>variable definitions,</em> terminated by an equal sign ("="). A variable definition is enclosed in braces ("{" and "}"). It consists of a variable name and two optional attachments, separated by colons (":"). If there is one attachment, it is a regular expression for matching text that is to be assigned to the variable; if there are two attachments, the first one is a hint for the GUI editor and the second one the regular expression.</p>
<div class="paragraph">
<p>Note that all characters that are "magic" in regular expressions must be escaped with a preceding backslash ("\") if they should occur literally within the expression.</p>
</div>
</li>
<li>
<p>The remaining part of the line after the delimiting equal sign is the replacement text for any DSLR text matching the regular expression. It may contain variable references, i.e., a variable name enclosed in braces. Optionally, the variable name may be followed by an exclamation mark ("!") and a transformation function, see below.</p>
<div class="paragraph">
<p>Note that braces ("{" and "}") must be escaped with a preceding backslash ("\") if they should occur literally within the replacement string.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Debugging of DSL expansion can be turned on, selectively, by using a comment line starting with "#/" which may contain one or more words from the table presented below.
The resulting output is written to standard output.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Debug options for DSL expansion</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Word</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">result</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prints the resulting DRL text, with line numbers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">steps</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prints each expansion step of condition and consequence
            lines.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">keyword</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dumps the internal representation of all DSL entries with
            scope "keyword".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">when</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dumps the internal representation of all DSL entries with
            scope "when" or "*".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">then</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dumps the internal representation of all DSL entries with
            scope "then" or "*".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">usage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Displays a usage statistic of all DSL entries.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Below are some sample DSL definitions, with comments describing the language features they illustrate.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># Comment: DSL examples

#/ debug: display result and usage

# keyword definition: replaces "regula" by "rule"
[keyword][]regula=rule

# conditional element: "T" or "t", "a" or "an", convert matched word
[when][][Tt]here is an? {entity:\w+}=
        ${entity!lc}: {entity!ucfirst} ()

# consequence statement: convert matched word, literal braces
[then][]update {entity:\w+}=modify( ${entity!lc} )\{ \}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The transformation of a DSLR file proceeds as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The text is read into memory.</p>
</li>
<li>
<p>Each of the "keyword" entries is applied to the entire text. First, the regular expression from the keyword definition is modified by replacing white space sequences with a pattern matching any number of white space characters, and by replacing variable definitions with a capture made from the regular expression provided with the definition, or with the default (".*?"). Then, the DSLR text is searched exhaustively for occurrences of strings matching the modified regular expression. Substrings of a matching string corresponding to variable captures are extracted and replace variable references in the corresponding replacement text, and this text replaces the matching string in the DSLR text.</p>
</li>
<li>
<p>Sections of the DSLR text between "when" and "then", and "then" and "end", respectively, are located and processed in a uniform manner, line by line, as described below.</p>
<div class="paragraph">
<p>For a line, each DSL entry pertaining to the line&#8217;s section is taken in turn, in the order it appears in the DSL file.
Its regular expression part is modified: white space is replaced by a pattern matching any number of white space characters; variable definitions with a regular expression are replaced by a capture with this regular expression, its default being ".*?". If the resulting regular expression matches all or part of the line, the matched part is replaced by the suitably modified replacement text.</p>
</div>
<div class="paragraph">
<p>Modification of the replacement text is done by replacing variable references with the text corresponding to the regular expression capture.
This text may be modified according to the string transformation function given in the variable reference; see below for details.</p>
</div>
<div class="paragraph">
<p>If there is a variable reference naming a variable that is not defined in the same entry, the expander substitutes a value bound to a variable of that name, provided it was defined in one of the preceding lines of the current rule.</p>
</div>
</li>
<li>
<p>If a DSLR line in a condition is written with a leading hyphen, the expanded result is inserted into the last line, which should contain a pattern CE, i.e., a type name followed by a pair of parentheses. if this pair is empty, the expanded line (which should contain a valid constraint) is simply inserted, otherwise a comma (",") is inserted beforehand.</p>
<div class="paragraph">
<p>If a DSLR line in a consequence is written with a leading hyphen, the expanded result is inserted into the last line, which should contain a "modify" statement, ending in a pair of braces ("{" and "}"). If this pair is empty, the expanded line (which should contain a valid method call) is simply inserted, otherwise a comma (",") is inserted beforehand.</p>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is currently <em>not</em> possible to use a line with a leading hyphen to insert text into other conditional element forms (e.g., "accumulate") or it may only work for the first insertion (e.g., "eval").</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All string transformation functions are described in the following table.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. String transformation functions</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts all letters to upper case.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts all letters to lower case.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ucfirst</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts the first letter to upper case, and
            all other letters to lower case.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">num</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extracts all digits and "-" from the string. If the
            last two digits in the original string are preceded by "." or
            ",", a decimal period is inserted in the corresponding position.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>a</em>?<em>b</em>/<em>c</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compares the string with string <em>a</em>, and if they
            are equal, replaces it with <em>b</em>, otherwise with
            <em>c</em>. But <em>c</em> can be another triplet
            <em>a</em>, <em>b</em>, <em>c</em>, so
            that the entire structure is, in fact, a translation table.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following DSL examples show how to use string transformation functions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># definitions for conditions
[when][]There is an? {entity}=${entity!lc}: {entity!ucfirst}()
[when][]- with an? {attr} greater than {amount}={attr} &lt;= {amount!num}
[when][]- with a {what} {attr}={attr} {what!positive?&gt;0/negative?%lt;0/zero?==0/ERROR}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A file containing a DSL definition has to be put under the resources folder or any of its subfolders like any other drools artifact.
It must have the extension <code>.dsl</code>, or alternatively be marked with type <code>ResourceType.DSL</code>.
when programmatically added to a <code>KieFileSystem</code>.
For a file using DSL definition, the extension <code>.dslr</code> should be used, while it can be added to a <code>KieFileSystem</code> with type <code>ResourceType.DSLR</code>.</p>
</div>
<div class="paragraph">
<p>For parsing and expanding a DSLR file the DSL configuration is read and supplied to the parser.
Thus, the parser can "recognize" the DSL expressions and transform them into native rule language expressions.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_custom_operators"><a class="anchor" href="#_custom_operators"></a>Custom Operators</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Drools supports custom operators, which are defined in Java code and can be used in DRL rules.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Java static methods can be an alternative to custom operators. Typically, Java static methods are more flexible and easier to maintain than custom operators, while custom operators are more concise and easier to read in rules.</p>
</div>
<div class="listingblock">
<div class="title">Java static method example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( supersetOf(addresses, $alice.addresses) )</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Custom operator example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Person( addresses supersetOf $alice.addresses)</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_define_custom_operators"><a class="anchor" href="#_define_custom_operators"></a>Define Custom Operators</h3>
<div class="paragraph">
<p>Let&#8217;s say you want to define a custom operator called <code>supersetOf</code> that checks if one collection is a superset of another.</p>
</div>
<div class="paragraph">
<p>To define a custom operator, you need to create a Java class that implements the <code>EvaluatorDefinition</code> interface, which registers the operator and returns an instance of <code>Evaluator</code> that implements the logic for the operator.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class SupersetOfEvaluatorDefinition implements EvaluatorDefinition {

    public static final Operator SUPERSET_OF = Operator.addOperatorToRegistry("supersetOf", false);
    public static final Operator NOT_SUPERSET_OF = Operator.addOperatorToRegistry("supersetOf", true);
    private static final String[] SUPPORTED_IDS = {SUPERSET_OF.getOperatorString()};

    private Evaluator[] evaluator;

    public SupersetOfEvaluatorDefinition() {
    }

    @Override
    public String[] getEvaluatorIds() {
        return SupersetOfEvaluatorDefinition.SUPPORTED_IDS;
    }

    @Override
    public boolean isNegatable() {
        return true;
    }

    @Override
    public Evaluator getEvaluator(final ValueType type, final String operatorId, final boolean isNegated, final String parameterText, final Target leftTarget, final Target rightTarget) {
        return new SupersetOfEvaluator(type, isNegated);
    }

    @Override
    public Evaluator getEvaluator(final ValueType type, final String operatorId, final boolean isNegated, final String parameterText) {
        return getEvaluator(type, operatorId, isNegated, parameterText, Target.FACT, Target.FACT);
    }

    @Override
    public Evaluator getEvaluator(final ValueType type, final Operator operator, final String parameterText) {
        return this.getEvaluator(type, operator.getOperatorString(), operator.isNegated(), parameterText);
    }

    @Override
    public Evaluator getEvaluator(final ValueType type, final Operator operator) {
        return this.getEvaluator(type, operator.getOperatorString(), operator.isNegated(), null);
    }

    @Override
    public boolean supportsType(final ValueType vt) {
        return true;
    }

    @Override
    public Target getTarget() {
        return Target.FACT;
    }

    @Override
    public void writeExternal(final ObjectOutput out) throws IOException {
        out.writeObject(evaluator);
    }

    @Override
    public void readExternal(final ObjectInput in) throws IOException, ClassNotFoundException {
        evaluator = (Evaluator[]) in.readObject();
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class SupersetOfEvaluator extends BaseEvaluator {

    public SupersetOfEvaluator() {
    }

    public SupersetOfEvaluator(final ValueType type, final boolean isNegated) {
        super(type, isNegated ? SupersetOfEvaluatorDefinition.NOT_SUPERSET_OF : SupersetOfEvaluatorDefinition.SUPERSET_OF);
    }

    @Override
    public boolean evaluate(final ValueResolver valueResolver, final ReadAccessor extractor, final FactHandle factHandle, final FieldValue value) {
        final Object objectValue = extractor.getValue(valueResolver, factHandle);
        return evaluateExpression((Collection) objectValue, (Collection) value.getValue());
    }

    @Override
    public boolean evaluate(final ValueResolver valueResolver, final ReadAccessor ira, final FactHandle leftOperandFact, final ReadAccessor ira1, final FactHandle rightOperandFact) {
        return evaluateExpression((Collection) leftOperandFact.getObject(), (Collection) rightOperandFact.getObject());
    }

    @Override
    public boolean evaluateCachedLeft(final ValueResolver valueResolver, final VariableRestriction.VariableContextEntry context, final FactHandle right) {
        final Object valRight = context.extractor.getValue(valueResolver, right.getObject());
        // a left input is a right operand. a right input is a left operand. so swapped.
        return evaluateExpression((Collection) valRight, (Collection) ((VariableRestriction.ObjectVariableContextEntry) context).left);
    }

    @Override
    public boolean evaluateCachedRight(final ValueResolver reteEvaluator, final VariableRestriction.VariableContextEntry context, final FactHandle left) {
        final Object varLeft = context.declaration.getExtractor().getValue(reteEvaluator, left);
        // a left input is a right operand. a right input is a left operand. so swapped.
        return evaluateExpression((Collection) ((VariableRestriction.ObjectVariableContextEntry) context).right, (Collection) varLeft);
    }

    private boolean evaluateExpression(final Collection leftOperandCollection, final Collection rightOperandCollection) {
        return getOperator().isNegated() ^ leftOperandCollection.containsAll(rightOperandCollection);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_use_custom_operators"><a class="anchor" href="#_use_custom_operators"></a>Use Custom Operators</h3>
<div class="paragraph">
<p>Once you have the Java classes, create <code>kie.default.properties.conf</code> file under <code>META-INF</code> directory in your project and add the following line to make the engine aware of the evaluator definition class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">drools.evaluator.supersetOf = com.sample.SupersetOfEvaluatorDefinition</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can use the new operator in your rules, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "Find persons whose addresses are a superset of Alice's"
when
    $alice : Person( name == "Alice" )
    $person : Person( addresses supersetOf $alice.addresses )
then
    System.out.println($person.getName() + "'s addresses are a superset of Alice's addresses.");
end</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Custom operators cannot use brackets in their names. In other words, you cannot define an operator like <code>myStr[startsWith]</code>. Instead, you should use a name without brackets, such as <code>myStrStartsWith</code>. Drools has built-in operators like <code>str[startsWith]</code>, but they are an exceptional case and just kept for backward compatibility.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In Language Level DRL10, custom operators must be prefixed with <code><mark></code> to avoid ambiguity with other syntax. For example, the operator <code>supersetOf</code> should be used as <code></mark>supersetOf</code> in DRL10.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<!--Licensed to the Apache Software Foundation (ASF) under one-->
<!--or more contributor license agreements.  See the NOTICE file-->
<!--distributed with this work for additional information-->
<!--regarding copyright ownership.  The ASF licenses this file-->
<!--to you under the Apache License, Version 2.0 (the-->
<!--"License"); you may not use this file except in compliance-->
<!--with the License.  You may obtain a copy of the License at-->

<!--http://www.apache.org/licenses/LICENSE-2.0-->

<!--Unless required by applicable law or agreed to in writing,-->
<!--software distributed under the License is distributed on an-->
<!--"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY-->
<!--KIND, either express or implied.  See the License for the-->
<!--specific language governing permissions and limitations-->
<!--under the License.-->

<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script src="../../_/js/vendor/lunr.js"></script>
<script src="../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../_/css/search.css"></script>
<script async src="../../search-index.js"></script>
  </body>
</html>
