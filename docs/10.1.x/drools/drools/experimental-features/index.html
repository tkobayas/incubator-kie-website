<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Experimental features :: Drools Documentation</title>
    <link rel="canonical" href="https://docs.drools.org/latest/drools-docs/drools/experimental-features/index.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<!--Licensed to the Apache Software Foundation (ASF) under one-->
<!--or more contributor license agreements.  See the NOTICE file-->
<!--distributed with this work for additional information-->
<!--regarding copyright ownership.  The ASF licenses this file-->
<!--to you under the Apache License, Version 2.0 (the-->
<!--"License"); you may not use this file except in compliance-->
<!--with the License.  You may obtain a copy of the License at-->

<!--http://www.apache.org/licenses/LICENSE-2.0-->

<!--Unless required by applicable law or agreed to in writing,-->
<!--software distributed under the License is distributed on an-->
<!--"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY-->
<!--KIND, either express or implied.  See the License for the-->
<!--specific language governing permissions and limitations-->
<!--under the License.-->

<link rel="stylesheet" href="../../_/css/search.css">
<link rel="stylesheet" href="../../_/css/menu.css">
<link rel="stylesheet" href="../../_/css/drl.css">
<!--Licensed to the Apache Software Foundation (ASF) under one-->
<!--or more contributor license agreements.  See the NOTICE file-->
<!--distributed with this work for additional information-->
<!--regarding copyright ownership.  The ASF licenses this file-->
<!--to you under the Apache License, Version 2.0 (the-->
<!--"License"); you may not use this file except in compliance-->
<!--with the License.  You may obtain a copy of the License at-->

<!--http://www.apache.org/licenses/LICENSE-2.0-->

<!--Unless required by applicable law or agreed to in writing,-->
<!--software distributed under the License is distributed on an-->
<!--"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY-->
<!--KIND, either express or implied.  See the License for the-->
<!--specific language governing permissions and limitations-->
<!--under the License.-->

<script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<!--Licensed to the Apache Software Foundation (ASF) under one-->
<!--or more contributor license agreements.  See the NOTICE file-->
<!--distributed with this work for additional information-->
<!--regarding copyright ownership.  The ASF licenses this file-->
<!--to you under the Apache License, Version 2.0 (the-->
<!--"License"); you may not use this file except in compliance-->
<!--with the License.  You may obtain a copy of the License at-->

<!--http://www.apache.org/licenses/LICENSE-2.0-->

<!--Unless required by applicable law or agreed to in writing,-->
<!--software distributed under the License is distributed on an-->
<!--"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY-->
<!--KIND, either express or implied.  See the License for the-->
<!--specific language governing permissions and limitations-->
<!--under the License.-->

<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="https://kie.apache.org/">
          <img src="../../_/img/droolsExpertLogo.png" alt="Drools logo"/>
        </a>
        <a class="navbar-item" href="https://kie.apache.org/">
          Drools Documentation
        </a>
      </div>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search docs">
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item">
          <a class="navbar-item small-item" href="https://github.com/apache/incubator-kie-drools" title="Follow Drools on GitHub"><div class="github-icon"></div></a>
          <a class="navbar-item small-item" href="https://twitter.com/KieCommunity" target="_blank" title="Follow KIE Community on Twitter for more Drools tweets"><img alt="T" src="../../_/img/twitterLogo.png"></a>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="drools" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../introduction/index.html">Drools User Guide 10.1.0</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../introduction/index.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../getting-started/index.html">Getting Started</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../KIE/index.html">Build, Deploy, Utilize and Run</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../rule-engine/index.html">Drools rule engine</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../language-reference/index.html">Rule Language Reference</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../language-reference-traditional/index.html">Rule Language Reference (Traditional)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../DMN/index.html">Decision Model and Notation (DMN)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../pragmatic-ai/index.html">Pragmatic AI: Integrating Machine Learning with Drools</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../Commands/index.html">Drools Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../migration-guide/index.html">Migration Guide</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="index.html">Experimental features</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../release-notes/index.html">Release Notes</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Drools User Guide 10.1.0</span>
    <span class="version">default</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../introduction/index.html">Drools User Guide 10.1.0</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../introduction/index.html">default</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../introduction/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../introduction/index.html">Drools User Guide 10.1.0</a></li>
    <li><a href="index.html">Experimental features</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Experimental features</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This chapter documents experimental features that are part of the Drools projects group. As these features are experimental, they may not be finished or stable enough for common use. All aspects of these features are highly likely to change in the future.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="experimental-declarative-agenda_experimental-features"><a class="anchor" href="#experimental-declarative-agenda_experimental-features"></a>Declarative agenda</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The declarative agenda allows to use rules to control which other rules can fire and when. While this will add a lot more overhead than the simple use of salience, the advantage is it is declarative and thus more readable and maintainable and should allow more use cases to be achieved in a simpler fashion.</p>
</div>
<div class="paragraph">
<p>As this feature is highly experimental and will be subject to change, it is off by default and must be explicitly enabled. It can be activated on a given KieBase by adding the <code>declarativeAgenda="enabled"</code> attribute in the corresponding <code>kbase</code> tag of the kmodule.xml file, as is specified in the following example.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Enabling the Declarative Agenda</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;kmodule xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns="http://www.drools.org/xsd/kmodule"&gt;
      &lt;kbase name="DeclarativeKBase" declarativeAgenda="enabled"&gt;
      &lt;ksession name="KSession"/&gt;
      &lt;/kbase&gt;
      &lt;/kmodule&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The basic idea is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All rule&#8217;s matches are inserted into working memory as facts, represented as instances of <code>Match</code> class. So you can now do pattern matching against a <code>Match</code> instance. The rule&#8217;s metadata and declarations are available as fields on the <code>Match</code> instance.</p>
</li>
<li>
<p>You can use the <code>kcontext.blockMatch(Match match)</code> call in a rule to block a selected match. Only when that rule becomes false will the match be eligible for firing. If it is already eligible for firing and is later blocked, it will be removed from the agenda until it is unblocked.</p>
</li>
<li>
<p>A match may have multiple blockers, so a count is kept. All blockers must become false for the counter to reach zero to enable the <code>Match</code> to be eligible for firing.</p>
</li>
<li>
<p><code>kcontext.unblockAllMatches(Match match)</code> is an over-ride rule that will remove all blockers regardless.</p>
</li>
<li>
<p>An internalMatch may also be cancelled using <code>cancelMatch</code> call, so it never fires.</p>
</li>
<li>
<p>An unblocked <code>Match</code> is added to the agenda and obeys normal salience, agenda groups, ruleflow groups etc. definitions.</p>
</li>
<li>
<p>The <code>@Direct</code> annotation allows a rule to fire as soon as it&#8217;s matched. This is supposed to be used for rules that block/unblock matches, it is not desirable for these rules to have side effects that impact else where.</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="title">Example 2. New RuleContext methods</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">void blockMatch(Match match);
void unblockAllMatches(Match match);
void cancelMatch(Match match);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Here is a basic example that will block all matches from rules that have metadata <code>@department('sales')</code>. They will stay blocked until the blockerAllSalesRules rule becomes false, i.e. "go2" is retracted.</p>
</div>
<div class="exampleblock">
<div class="title">Example 3. Block rules based on rule metadata</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "rule1" @Eager @department('sales')
when
    $s: String(this == 'go1')
then
    System.out.println("rule1 fired!");
end

rule "rule2" @Eager @department('sales')
when
    $s: String(this == 'go1')
then
    System.out.println("rule2 fired!");
end

rule "blockerAllSalesRules" @Direct @Eager
when
    $s: String(this == 'go2')
    $i: Match(department == 'sales')
then
    kcontext.blockMatch($i);
end</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is necessary to annotate all the rules that could be potentially blocked by rule with <code>@Direct</code> annotation with the annotation <code>@Eager</code>. This is because the potentially blocked rules must be evaluated immediately, so they produce <code>Match</code> instances, that can be evaluated by the blocking rule.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This example shows how you can use a property to count the number of active or inactive (already fired) matches.</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. Count the number of active/inactive Matches</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">rule "rule1" @Eager @department('sales')
when
    $s: String(this == 'go1')
then
    System.out.println("rule1 fired!");
end

rule "rule2" @Eager @department('sales')
when
    $s: String(this == 'go1')
then
    System.out.println("rule2 fired!");
end

rule "rule3" @Eager @department('sales')
when
    $s: String(this == 'go1')
then
    System.out.println("rule3 fired!");
end

rule "countActivateInActive" @Direct @Eager
when
    $s: String(this == 'go2')
    $active: Number(this == 1) from accumulate(
        $a: Match(department == 'sales', active == true),
        count($a))
    $inActive: Number(this == 2) from accumulate(
        $a : Match(department == 'sales', active == false),
        count($a))
then
    kcontext.halt();
end</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="experimental-traits_experimental-features"><a class="anchor" href="#experimental-traits_experimental-features"></a>Traits</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The same fact may have multiple dynamic types which do not fit naturally in a class hierarchy. Traits allow to model this very common scenario. A trait is a type that can be applied to (and eventually removed from) an individual object at runtime. To create a trait rather than a traditional bean, one has to declare it explicitly as in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">declare trait GoldenCustomer
    // fields will map to getters/setters
    code     : String
    balance  : long
    discount : int
    maxExpense : long
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>At runtime, this declaration results in an interface, which can be used to write patterns, but can not be instantiated directly. In order to apply a trait to an object, we provide the new <code>don</code> keyword, which can be used as simply as this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">when
    $c : Customer()
then
    GoldenCustomer gc = don( $c, GoldenCustomer.class );
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>When a trait is applied to a fact, a proxy class is created on the fly (one such class will be generated lazily for each fact/trait class combination). The proxy instance, which wraps the fact and implements the trait interface, is inserted automatically and will possibly activate other rules. An immediate advantage of declaring and using interfaces and getting the implementation proxy is that multiple inheritance hierarchies can be exploited when writing rules. The fact declarations, however, need not implement any of those interfaces statically. To be possible to assign a trait to a fact, the fact type definition must contain the annotation <code>@Traitable</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">import org.drools.base.factmodel.traits.Traitable;
declare Customer
    @Traitable
    code: String
    balance: long
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>The only connection between fact classes and trait interfaces is at the proxy level: a trait is not specifically tied to a fact class. This means that the same trait can be applied to totally different facts. For this reason, the trait does not transparently expose the fields of its fact object. So, when writing a rule using a trait interface, only the fields of the interface will be available, as usual. However, any field in the interface that corresponds to a fact field, will be mapped by the proxy class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">when
    $o: OrderItem($p: price, $code: custCode)
    $c: GoldenCustomer(code == $code,$a : balance,$d: discount)
then
    $c.setBalance($a - $p*$d);
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the <code>code</code> and <code>balance</code> would be read from the underlying <code>Customer</code> object. Likewise, the <code>setAccount</code> will modify the underlying object, preserving a strongly typed access to the data structures. A hard field is a field that must have the same name and type both in the fact class and all trait interfaces. The name is used to establish the mapping: if two fields have the same name, then they must also have the same declared type. The annotation <code>@org.drools.base.factmodel.traits.Alias</code> allows to relax this restriction. If an <code>@Alias</code> is provided, its value string will be used to resolve mappings instead of the original field name. <code>@Alias</code> can be applied both to traits and core beans.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">import org.drools.base.factmodel.traits.*;
declare trait GoldenCustomer
    balance: long @Alias("org.acme.foo.accountBalance")
end

declare Person
    @Traitable
    name: String
    savings: long @Alias("org.acme.foo.accountBalance")
end

when
    GoldenCustomer(balance &gt; 1000) // will react to new Person(2000)
then
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>More work is being done on relaxing this constraint (see the experimental section on "logical" traits later). Now, one might wonder what happens when a fact class does NOT provide the implementation for a field defined in an interface. We call hard fields those trait fields which are also fact fields and thus readily available, while we define soft those fields which are NOT provided by the fact class. Hidden fields, instead, are fields in the fact class not exposed by the interface.</p>
</div>
<div class="paragraph">
<p>So, while hard field management is intuitive, there remains the problem of soft and hidden fields. Hidden fields are normally only accessible using the fact class directly. However, one can also use the "fields" <code>Map</code> on a trait interface to access a hidden field. If the field can&#8217;t be resolved, <code>null</code> will be returned. Notice that this feature is likely to change in the future.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">when
    $sc: GoldenCustomer(fields["age"] &gt; 18)  // age is declared by the underlying fact class, but not by GoldenCustomer
then</code></pre>
</div>
</div>
<div class="paragraph">
<p>Soft fields, instead, are stored in a Map-like data structure that is specific to each fact object and referenced by the proxy(es), so that they are effectively shared even when an object has multiple traits assigned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">when
    $sc: GoldenCustomer($c: code, // hard getter
                        $maxExpense: maxExpense &gt; 1000 // soft getter)
then
    $sc.setDiscount(...); // soft setter
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>A fact object also holds a reference to all its proxies, so that it is possible to track which traits have been added to an object, using a sort of dynamic "instanceof" operator, which we named <code>isA</code>. The operator can accept a <code>String</code>, a class literal or a list of class literals. In the latter case, the constraint is satisfied only if all the specified traits have been assigned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$sc: GoldenCustomer($maxExpense: maxExpense &gt; 1000,
                    this isA "SeniorCustomer",
                    this isA [NationalCustomer.class, OnlineCustomer.class])</code></pre>
</div>
</div>
<div class="paragraph">
<p>Eventually, the business logic may require that a trait is removed from a fact object. For this, we provide two options. The first is a "logical don", which will result in a logical insertion of the proxy resulting from the trait assignment. The Truth Maintenance System will ensure that the trait is removed when its logical support is removed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">then
    don($x, // core object
        Customer.class, // trait class
        true // optional flag for logical insertion)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second option is the use of the <code>shed</code> keyword, which causes the removal of any type that is a subtype (or equivalent) of the one passed as an argument.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">then
    Thing t = shed($x, GoldenCustomer.class)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This operation returns another proxy implementing the <code>org.drools.base.factmodel.traits.Thing</code> interface, where the <code>getFields()</code> and <code>getCore()</code> methods are defined. Internally, in fact, all declared traits are generated to extend this interface (in addition to any others specified). This allows to preserve the wrapper with the soft fields which would otherwise be lost.</p>
</div>
<div class="paragraph">
<p>A trait and its proxies are also correlated in another way. Whenever a fact object is "modified", its proxies are "modified" automatically as well, to allow trait-based patterns to react to potential changes in hard fields. Likewise, whenever a trait proxy (matched by a trait pattern) is modified, the modification is propagated to the fact class and the other traits. Moreover, whenever a <code>don</code> operation is performed, the fact object is also modified automatically, to reevaluate any <code>isA</code> operation which may be triggered.</p>
</div>
<div class="paragraph">
<p>Potentially, this may result in a high number of modifications, impacting performance (and correctness) heavily. So two solutions are currently implemented. First, whenever a fact object is modified, only the most specific traits (in the sense of inheritance between trait interfaces) are updated and an internal blocking mechanism is in place to ensure that each potentially matching pattern is evaluated once and only once. So, in the following situation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">declare trait GoldenCustomer end
declare trait NationalGoldenCustomer extends GoldenCustomer end
declare trait SeniorGoldenCustomer extends GoldenCustomer end</code></pre>
</div>
</div>
<div class="paragraph">
<p>A modification of an object that is both a <code>GoldenCustomer</code>, a <code>NationalGoldenCustomer</code> and a <code>SeniorGoldenCustomer</code> would cause only the latter two proxies to be actually modified. The first would match any pattern for <code>GoldenCustomer</code> and <code>NationalGoldenCustomer</code>, the latter would instead be prevented from rematching <code>GoldenCustomer</code>, but would be allowed to match <code>SeniorGoldenCustomer</code> patterns. It is not necessary, instead, to modify the <code>GoldenCustomer</code> proxy since it is already covered by at least one other more specific trait.</p>
</div>
<div class="paragraph">
<p>The second method, up to the user, is to mark traits as <code>@PropertyReactive</code>.
Property reactivity is trait-enabled and takes into account the trait field mappings, so to block unnecessary propagations.</p>
</div>
<div class="sect2">
<h3 id="_cascading_traits"><a class="anchor" href="#_cascading_traits"></a>Cascading traits</h3>
<div class="paragraph">
<p><strong>WARNING</strong> : This feature is extremely experimental and subject to changes.</p>
</div>
<div class="paragraph">
<p>Normally, a hard field must be exposed with its original type by all traits assigned to an object, to prevent situations such as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">declare Person
  @Traitable
  name: String
  id: String
end

declare trait Customer
  id: String
end

declare trait Patient
  id: long  // Person can't don Patient, or an exception will be thrown
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Should a <code>Person</code> get assigned both <code>Customer</code> and <code>Patient</code> traits, the type of the hard field <code>id</code> would be ambiguous. However, consider the following example, where <code>GoldenCustomers</code> refer their best friends so that they become <code>Customers</code> as well:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">declare Person
  @Traitable(logical = true)
  bestFriend: Person
end

declare trait Customer end

declare trait GoldenCustomer extends Customer
  refers: Customer @Alias("bestFriend")
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Aside from the <code>@Alias</code>, a Person-as-GoldenCustomer&#8217;s best friend may be compatible with the requirements of the trait <code>GoldenCustomer</code>, provided that they are some kind of <code>Customer</code> themselves. Marking a <code>Person</code> as "logically traitable" - i.e. adding the annotation <code>@Traitable(logical = true)</code> - will instruct the Drools rule engine to try and preserve the logical consistency rather than throwing an exception due to a hard field with different type declarations (<code>Person</code> vs <code>Customer</code>). The following operations would then work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Person p1 = new Person();
Person p2 = new Person();
p1.setBestFriend(p2);
...
Customer c2 = don(p2, Customer.class);
...
GoldenCustomer gc1 = don(p1, GoldenCustomer.class);
...
p1.getBestFriend(); // returns p2
gc1.getRefers(); // returns c2, a Customer proxy wrapping p2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that, by the time <code>p1</code> becomes <code>GoldenCustomer</code>, <code>p2</code> must have already become a <code>Customer</code> themselves, otherwise a runtime exception will be thrown since the very definition of <code>GoldenCustomer</code> would have been violated.</p>
</div>
<div class="paragraph">
<p>In some cases, however, one may want to infer, rather than verify, that <code>p2</code> is a <code>Customer</code> by virtue that <code>p1</code> is a <code>GoldenCustomer</code>. This modality can be enabled by marking <code>Customer</code> as "logical", using the annotation <code>@org.drools.base.factmodel.traits.Trait(logical = true)</code>. In this case, should <code>p2</code> not be a <code>Customer</code> by the time that <code>p1</code> becomes a <code>GoldenCustomer</code>, it will be automatically assigned the trait <code>Customer</code> to preserve the logical integrity of the system.</p>
</div>
<div class="paragraph">
<p>Notice that the annotation on the fact class enables the dynamic type management for its fields, whereas the annotation on the traits determines whether they will be enforced as integrity constraints or cascaded dynamically.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">import org.drools.factmodel.traits.*;

declare trait Customer
    @Trait(logical = true)
end</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="experimental-impact-analysis_experimental-features"><a class="anchor" href="#experimental-impact-analysis_experimental-features"></a>Impact analysis</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The impact analysis feature analyzes the relationships between the rules and generates a graph. When you specify a rule to be changed, the impact analysis feature analyzes the rules that are impacted by the change and renders the rules in the generated graph.</p>
</div>
<div class="paragraph">
<p>The generated graph supports DOT, SVG, and PNG formats with simple text output.</p>
</div>
<div class="sect2">
<h3 id="_using_the_impact_analysis_feature"><a class="anchor" href="#_using_the_impact_analysis_feature"></a>Using the impact analysis feature</h3>
<div class="paragraph">
<p>You can find an example usage in <code>ExampleUsageTest.java</code> under <code>drools-impact-analysis/drools-impact-analysis-itests</code></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Configure the following dependency.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">    &lt;dependency&gt;
      &lt;groupId&gt;org.drools&lt;/groupId&gt;
      &lt;artifactId&gt;drools-impact-analysis-graph-graphviz&lt;/artifactId&gt;
      &lt;version&gt;${drools.version}&lt;/version&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Create a <code>KieFileSystem</code> to store your assets and call <code>KieBuilder.buildAll(ImpactAnalysisProject.class)</code> method.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">      // set up KieFileSystem
      ...
      KieBuilder kieBuilder = KieServices.Factory.get().newKieBuilder(kfs).buildAll(ImpactAnalysisProject.class);
      ImpactAnalysisKieModule analysisKieModule = (ImpactAnalysisKieModule) kieBuilder.getKieModule();
      AnalysisModel analysisModel = analysisKieModule.getAnalysisModel();</code></pre>
</div>
</div>
<div class="paragraph">
<p>You get <code>AnalysisModel</code>.</p>
</div>
</li>
<li>
<p>Convert the <code>AnalysisModel</code> to <code>Graph</code> using <code>ModelToGraphConverter</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">      ModelToGraphConverter converter = new ModelToGraphConverter();
      Graph graph = converter.toGraph(analysisModel);</code></pre>
</div>
</div>
</li>
<li>
<p>Specify a rule that you plan to change. The <code>ImpactAnalysisHelper</code> generates a graph, containing the changed rule and the impacted rules.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">      ImpactAnalysisHelper impactFilter = new ImpactAnalysisHelper();
      Graph impactedSubGraph = impactFilter.filterImpactedNodes(graph, "org.drools.impact.analysis.example.PriceCheck_11");</code></pre>
</div>
</div>
</li>
<li>
<p>Generate a graph image using <code>GraphImageGenerator</code>. You can choose the format from DOT, SVG, and PNG.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">      GraphImageGenerator generator = new GraphImageGenerator("example-impacted-sub-graph");
      generator.generateSvg(impactedSubGraph);</code></pre>
</div>
</div>
</li>
<li>
<p>Simple text output is also available using <code>TextReporter</code>. You can choose the format from <code>HierarchyText</code> and <code>FlatText</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">      String hierarchyText = TextReporter.toHierarchyText(impactedSubGraph);
      System.out.println(hierarchyText);</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>In a generated graph, red node represents a changed rule and yellow nodes represent the impacted rules. A solid arrow in a generated graph indicates a positive impact, in which the source rule activates the target rule. However, a dashed arrow indicates a negative impact, in which the source rule deactivates the target rule. Also, a dotted arrow represents an unknown impact, in which the source rule might activate or deactivate the target rule.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/experimental-features/impactAnalysis1.svg" alt="impactAnalysis1">
</div>
</div>
<div class="paragraph">
<p>You can collapse a graph based on the rule name prefix or RuleSet in a spreadsheet using the <code>GraphCollapsionHelper</code>. This enables you to view the overview of a graph. Also, you can use <code>ImpactAnalysisHelper</code> to the collapsed graph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">      Graph collapsedGraph = new GraphCollapsionHelper().collapseWithRuleNamePrefix(graph);
      Graph impactedCollapsedSubGraph = impactFilter.filterImpactedNodes(collapsedGraph, "org.drools.impact.analysis.example.PriceCheck");</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you only want to view the positive relations in a graph, set the <code>positiveOnly</code> to <code>true</code> for <code>ModelToGraphConverter</code>, <code>ImpactAnalysisHelper</code>, and <code>GraphCollapsionHelper</code> constructor.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">      ModelToGraphConverter converter = new ModelToGraphConverter(true);
      Graph graph = converter.toGraph(analysisModel);
      ImpactAnalysisHelper impactFilter = new ImpactAnalysisHelper(true);
      Graph impactedSubGraph = impactFilter.filterImpactedNodes(graph, "org.drools.impact.analysis.example.PriceCheck_11");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Text output is useful for a large number of rules. In a text output, <code>[*]</code> represents a changed rule, and <code>[+]</code> represents impacted rules.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">--- toHierarchyText ---
Inventory shortage[+]
PriceCheck_11[*]
  StatusCheck_12[+]
  (Inventory shortage)
  StatusCheck_13[+]
  StatusCheck_11[+]
    (PriceCheck_11)

--- toFlatText ---
Inventory shortage[+]
PriceCheck_11[*]
StatusCheck_11[+]
StatusCheck_12[+]
StatusCheck_13[+]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_troubleshooting"><a class="anchor" href="#_troubleshooting"></a>Troubleshooting</h3>
<div class="paragraph">
<p>If you get the warning message when rendering SVG or PNG:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>graphviz-java failed to render an image. Solutions would be:
1. Install graphviz tools in your local machine. graphviz-java will use graphviz command line binary (e.g. /usr/bin/dot) if available.
2. Consider generating a graph in DOT format and then visualize it with an external tool.</pre>
</div>
</div>
<div class="paragraph">
<p>You would need to install graphviz tools in your local machine. If not possible, you would need to generate the graph in DOT format so that you can render it with another tool later on.</p>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<!--Licensed to the Apache Software Foundation (ASF) under one-->
<!--or more contributor license agreements.  See the NOTICE file-->
<!--distributed with this work for additional information-->
<!--regarding copyright ownership.  The ASF licenses this file-->
<!--to you under the Apache License, Version 2.0 (the-->
<!--"License"); you may not use this file except in compliance-->
<!--with the License.  You may obtain a copy of the License at-->

<!--http://www.apache.org/licenses/LICENSE-2.0-->

<!--Unless required by applicable law or agreed to in writing,-->
<!--software distributed under the License is distributed on an-->
<!--"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY-->
<!--KIND, either express or implied.  See the License for the-->
<!--specific language governing permissions and limitations-->
<!--under the License.-->

<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script src="../../_/js/vendor/lunr.js"></script>
<script src="../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../_/css/search.css"></script>
<script async src="../../search-index.js"></script>
  </body>
</html>
